---
title: "Fisher Behavioral Strategies"
author: "Owen Liu"
date: Last Run "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,warning=F,message=F)
library(tidyverse)
library(magrittr)
library(here)
library(NbClust)
library(viridis)
library(lubridate)
library(ggsci)
library(forcats)
library(rnaturalearth)
library(sf)

# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=10,color="black"),
        legend.text = element_text(size=10),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=8,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
```

## Purpose

The goal of this analysis is to perform a clustering analysis on a suite of behavioral metrics describing the 2009-2019 west coast Dungeness crab fishing fleet. The metrics have been compiled based on fish ticket and VMS data, and include information on port use, revenue, and trip lengths, as well as more advanced metrics from analysis of VMS data, like distance traveled, exploratory behavior and propensity to fish in high winds.

All metrics (to the extent data allow) were calculated for each vessel and crab season. The unit of observation in clustering is one vessel's crab season, e.g. Vessel A in crab season 2012-2013.

Our guiding questions are:

1. **Can the behavior of the west coast Dungeness crab fishing fleet be classified into distinct behavioral types?**
2. **Which behavioral variables are particularly important in defining these behavioral types?**
3. **Have individual vessels moved between behavioral types across years?**
4. **How do fishing behavioral strategies relate to revenue and landings from fishing?**

## Import Data

```{r}
dat <- read_rds(here::here('fishing behavior','fishing_behavior_metrics_vessel_season.rds')) %>% 
  # filter(crab_season!="2008-2009") %>% 
  distinct()
glimpse(dat)
```
```{r}
# Important additional datasets needed for comparison of behavioral group performance

###
# import Richerson et al.'s preseason abundance estimates
abun <- read_csv(here::here('fishing behavior','crab_model_results_2020422.csv'))
# group all of CA
abun %<>% mutate(agency_code=case_when(
  area %in% c('Central CA','North CA') ~ "C",
  area == "OR" ~ "O",
  area == "WA" ~ "W"
)) %>% 
  mutate(lagseason=season-1) %>% 
  mutate(crab_season=paste(lagseason,season,sep="-")) %>% 
  group_by(agency_code,crab_season) %>% 
  summarise(mean_preseason_abun=sum(mean_est_thousands_mt)) %>% 
  ungroup()
###

# all DCRB fish tickets
fishtix <- read_rds(here::here('data','processed','fish tickets','fish_tickets_w_dayofseason.rds'))
# long form fish tickets with all species (for investigating other revenue)
fishtix_long <- read_rds(here::here('data','processed','fish tickets','fish_tickets_long_allspecies.rds'))
# for both sets of fish tickets, we do not make calculations on pre-season tickets
fishtix %<>% filter(ticket_day_of_season>=0)
fishtix_long %<>% filter(ticket_day_of_season>=0)

# vms_rep <- read_rds(here('fishing behavior','vms_proportional_landings_key.rds'))
vms_tickets <- read_rds(here('fishing behavior','fish_tickets_with_vms.rds'))
recid_crabseason <- fishtix %>% select(Rec_ID,crab_season) %>% distinct()

# import vms data as well, to pull out trip duration in days
vms <- purrr::map_df(2009:2019, function(yr){
  read_rds(paste0(here::here('data','processed','matched','filtering',yr),"matched_filtered.rds"))
}) %>% 
  filter(TARGET_rev=='DCRB') %>% 
  # join crab season indicator
  left_join(recid_crabseason,by='Rec_ID') %>% 
  filter(!is.na(crab_season))

vms_all_grd <- read_rds(here::here('data','processed','vms','vms_all_w_grd.rds'))
vms_all_grd %<>%
  dplyr::filter(TARGET_rev=='DCRB') %>% 
  # join crab season indicator
  left_join(recid_crabseason,by='Rec_ID')

trip_duration_key <- vms %>% 
  distinct(Rec_ID,trip_dur)
```

```{r}
## Coastline
coaststates <- ne_states(country='United States of America',returnclass = 'sf') %>% 
  filter(name %in% c('California','Oregon','Washington','Nevada')) %>% 
  st_transform(st_crs(vms_all_grd))
```


More specifically, the metrics are as follows for each vessel (`drvid`) in each `crab_season`:

1.  Port use: 
  *  `n_ports_trip` Average ports visited per trip
  *  `ports_mean_mth` Number of ports visited per month 
  *  `port_shannon` Shannon diversity index of port use
  *  `total_ports` Total number of ports visited across the entire season
2.  Revenue: 
  *  `revenue_mean` Mean Dungeness revenue per trip
  *  `revenue_sd` SD revenue per trip
3.  Landings:
  *  `landings_mean` Mean Dungeness landings (lbs) per trip
  *  `landings_sd` SD landings per trip
4.  Trip Length: 
  *  `trip_dist_mean` Mean distance per fishing trip, 
  *  `trip_dur_mean` Mean number of days per fishing trip
  *  `trip_dist_sd` SD distance per trip
  *  `trip_dur_sd` SD days per trip
5.  Derby fishing:
  *  `quant90_day` Day-of-season on which fisher reach 90% of eventual annual catch
6.  Participation in other fisheries:
  *  `prop_other_revenue` Proportion of revenue from non-DCRB fisheries
  *  `prop_other_tix` Proportion of all fish tickets form non-DCRB fisheries
  *  `revenue_diversity` Inverse Simpson diversity index of revenue by fishery (species)
7.  Risk-taking:
  *  `prop_highwinds` Propensity to fish in high winds. Proportion of trips pursued where the 95% quantile of wind speed was greater than 7.5 m/s
8.  Exploration: 
  *  `entropy_quant90` Cumulative choice entropy, measuring how likely a vessel is to fish in new versus past locations
9.  Mobility:
  * `homerange` Home range defined as the area of the convex hull surrounding all of a vessel's VMS pings during the season, excluding the top 5% spatial outliers


Because we are interested here in a post-hoc analysis of how fishing behaviors correlate with revenue and landings, we remove revenue and landings metrics from the clustering analysis and instead investigate their relationships with the derived behavioral groups later.

## Check Collinearity

Before clustering, we take a look at all the variables to search for extreme collinearity, which would suggest that we should trim our variables down.

```{r}
vars.corrs <- dat %>% select(-(1:2),-revenue_mean,-revenue_sd,-landings_mean,-landings_sd) %>% 
  cor(use="complete.obs") %>% 
  as_tibble(rownames="var1") %>% 
  pivot_longer(-var1,names_to = "var2",values_to = "corr")
vars.corrs %>% filter(corr !=1) %>% distinct(corr,.keep_all = T) %>% arrange(desc(corr)) %>% slice(1:10) %>% knitr::kable()

vars.corrs %>% 
  ggplot(aes(var1,var2,fill=corr))+
  geom_tile()+
  coord_equal()+
  scale_fill_gradient2()+
  labs(x="",y="",title="Variable Pearson Correlation Matrix",fill="")+
  theme(axis.text.x = element_text(angle=90,vjust=0.5,hjust=1))
```

There are some correlated variables, but few are greater than 0.7. Fishing trip distance and standard deviation are highly correlated, as well as three measures of port use (port diversity, ports per trip, and total ports). Additionally, the proportion of non-Dungeness tickets and non-Dungeness revenue are highly correlated.

We thin the clustering variables by removing mean and SD of trip distance (`trip_dist_mean` and `trip_dist_sd`), total ports (`total_ports`), and non-Dungeness ticket proportion (`prop_other_tix`) from further analysis. The remaining variables have no correlations higher than 0.7.

## Re-scale variables

For clustering analyses, we need to re-scale variables to a 0 to 1 scale to avoid artifacts caused simply by scale differences between variables.

Re-scaling is done by dividing each metric by its maximum value.

```{r}
# which variables are most commonly missing?
check_missing <- dat %>% summarise(across(everything(),~sum(is.na(.))))
dat_scaled <- dat %>% 
  select(-revenue_mean,-revenue_sd,-landings_mean,-landings_sd,-vessel_size,-trip_dist_sd,-total_ports,-prop_other_tix,-trip_dist_mean) %>% 
  mutate_at(-(1:2),~./max(.,na.rm=T)) %>% 
  # remove any observations with missing variables
  drop_na()
```

## Do Clustering

We then perform a clustering of the data, using Ward aggregation that attempts to minimize total within-cluster variance. However, instead of choosing the number of resulting classes rather arbitrarily from the results, we utilize the package `NbClust` that calculates 22 clustering indices defined in the literature, and then recommends the optimal number of clusters via majority vote.

```{r,results=FALSE,include=FALSE}
dat_clust <- dat_scaled %>% select(-(1:2)) %>% NbClust(method="ward.D2",min.nc = 2,max.nc=10,index='all')
```

After clustering, there was a range of number of clusters (groups) suggested by the clustering indices, but the **strong majority vote was 4 groups**. 7 of 22 clustering methods suggested that 4 was the best number of clusters. 6 methods suggested 3 groups, 4 suggested 2 groups, and no other group number received more than 2 votes.

## Visualize Clustering

```{r,include=FALSE,eval=FALSE}
dat_clust$All.index %>% as.tibble(rownames="n_clust")
dat_clust$All.CriticalValues
dat_clust$Best.partition %>% length()
```

We apply the majority-rule partitions from clustering to the dataset.

```{r}
library(factoextra)
dat_clustered <- dat_scaled %>% na.omit() %>% 
  mutate(partition=dat_clust$Best.partition) %>% 
  as_tibble()
# write_rds(dat_clustered,here::here('fishing behavior','data_scaled_4clusters.rds'))
```


```{r}
# Dendrogram code
# library(ggdendro)
dat_nolabs <- dat_scaled %>% na.omit() %>% select(-(1:2))

# # calc distances
# dat.d <- dat_scaled %>% na.omit() %>% select(-(1:2)) %>% get_dist()
# 
# # calc clustering
# dat.ward <- dat.d %>% hclust(method="ward.D2")
# 
# # ggdendro::ggdendrogram(dat.ward,leaf_labels = F,labels = FALSE)
# 
# # Rectangular lines dendrogram
# dend <- as.dendrogram(dat.ward) %>% dendro_data(type = "rectangle")
# 
# # figure out colors for segments
# # partitions <- tibble(obs=1:3261,partition=dat_clust$Best.partition)
# # head(dend$segments)
# # test <- dend$segment %>% as_tibble() %>%
# #   mutate(obs=paste(label) %>% as.numeric()) %>% 
# #   left_join(partitions,by=c('obs'))
# test <- dat_clustered %>% group_by(partition) %>% summarise(num_obs=n()) %>% ungroup() %>% mutate(cumobs=cumsum(num_obs))
# 
# # segs <- dend$segments %>% as_tibble() %>% 
# #   mutate(partition=case_when(
# #     round(xend)<= 272 ~ 1,
# #     round(xend)>272 & round(xend)<=1877 ~ 2,
# #     round(xend)>1877 & round(xend)<=2565 ~ 3,
# #     round(xend)>2565 ~ 4
# #   ))
# segs <- dend$segments %>% as_tibble() %>% 
#   mutate(partition=case_when(
#     round(xend)<= 2211 ~ 1,
#     round(xend)>2211 & round(xend)<=2670 ~ 2,
#     round(xend)>2670 ~ 3
#   ))
# p <- ggplot(segs) + 
#   geom_segment(aes(x = x, y = y, xend = xend, yend = yend,col=factor(partition)))+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4),name="Behavioral Group")+
#   labs(x="",y="",title="Dendrogram of all Data with 3 Behavioral Classes")+
#   theme(axis.text=element_blank(),
#         panel.grid.major = element_blank(),
#         panel.grid.minor=element_blank())
# p
```

We can also use the same data to perform a principal component analysis to help visualize our groups.

```{r}
dat_for_pca <- dat_scaled %>% 
  na.omit() %>% 
  select(-(1:2)) %>% 
  rename(`Ports per Trip`=n_ports_trip,
         `Ports per Month`= ports_mean_mth,
         `Port Diversity`= port_shannon,
         `Mean Trip Duration` = trip_dur_mean,
         `SD Trip Duration` = trip_dur_sd,
         `Season Length` = quant90_day,
         `Non-Dungeness Revenue` = prop_other_revenue,
         `Revenue Diversity` = revenue_diversity,
         `Risk Taking` = prop_highwinds,
         `Location Entropy` = entropy_quant90,
         `Home Range Size` = homerange
         )
dat.pca <- FactoMineR::PCA(dat_for_pca,graph=FALSE)

# factoextra::fviz_dend(dat.hclust,k=4,palette=viridis_pal()(4),show_labels=FALSE,rect=T,rect_lty=2)
# summary(dat.pca)
```

```{r}
# pca.inds <- dat.pca$ind$coord %>% as_tibble() %>% mutate(partition=dat_clust$Best.partition) %>% mutate(partition=factor(partition))
# glimpse(pca.inds)
# pca.vars <- dat.pca$var$coord %>% as_tibble() %>% mutate(lab=colnames(dat_nolabs))
# glimpse(pca.vars)3,2,4,1

# names for groups
clustnames <- tibble(partition=dat_clust$Best.partition) %>%
  mutate(partition=case_when(
    partition==3 ~ "Roving Specialists",
    partition==1 ~ "Local Generalists",
    partition==4 ~ "Roving Generalists",
    partition==2 ~ "Local Specialists"
  )) %>%
  mutate(partition=factor(partition,levels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists")))

p <- viridis_pal(begin=0.2,end=0.8)(4) # color palette
cluster3_pca <- fviz_pca(dat.pca,geom.ind="point",
         col.ind=clustnames$partition,
         addEllipses=TRUE,col.var="black",
         palette=p,alpha.ind=0.4)+
  labs(color="",shape="",fill="",shape="",title="")+
  scale_x_continuous(expand = c(.1,0))+
  theme(panel.grid.major = element_blank(),panel.grid.minor=element_blank())

cluster3_pca
ggsave(here::here('fishing behavior','plots','PCA_clusters.png'),cluster3_pca,w=8,h=6)
# scree plot
fviz_eig(dat.pca,choice = 'variance')
```

Here, with both observations and variables plotted along the first two principal components, we can start to see the variables that are defining the classes. In general, the first group seems to be associated with low revenue diversity and proportion of tickets from other fisheries, and spans a relatively broad range of vessel sizes, mean trip distances, and exploratory behavior (choice entropy).

The second group is associated with lower diversity of port use and smaller vessels, with a longer seasons, lower choice entropy, and lower risk-taking behavior than the first and third groups.

The third group (lightest green in the above) is composed generally of the largest, most exploratory vessels that also have high revenue diversity and participate in other fisheries.

The fourth group has the lowest choice entropy, shortest trip lengths, and low revenue diversity and port use, and is associated with small vessels.

As another visualization of differences between clusters, we can look at distribution of specific variable values across groups in boxplots.

```{r,fig.height=8,fig.width=8}
library(multcompView)
find_multcompletters <- function(df){
  aovtemp <- aov(df,formula = value~partition)
  tukeyhsd <- TukeyHSD(aovtemp)
  multcompLetters(tukeyhsd$partition[,4])$Letters %>% 
    enframe(name='partition',value='letter') %>% 
    mutate(partition=as.factor(partition))
}
group_means <- dat %>%
  select(-drvid,-crab_season,-revenue_mean,-revenue_sd,-landings_mean,-landings_sd,-vessel_size,-trip_dist_sd,-total_ports,-prop_other_tix,-trip_dist_mean) %>%
  drop_na() %>%
  mutate(partition=dat_clust$Best.partition %>% as.factor()) %>%
  pivot_longer(-partition,names_to='variable',values_to = 'value') %>%
  group_by(variable) %>%
  nest() %>%
  mutate(plotvars=purrr::map2(variable,data,function(j,k){
    labels=find_multcompletters(k)
    k %>%
      left_join(labels,by='partition') %>%
      ggplot(aes(factor(partition),value,fill=factor(partition)))+
      geom_boxplot(col='gray50')+
      geom_text(aes(partition,y=(max(value)-min(value))*0.9+min(value),label=letter),check_overlap = T,nudge_x=-0.15,size=4)+
      scale_fill_manual(values=c(p[2],p[1],p[3],p[4]))+
      labs(y="",x="",title=j)+
      guides(fill='none')
  })) %>%
  ungroup()

library(cowplot)

group_boxes <- plot_grid(plotlist=group_means$plotvars,labels=LETTERS[1:nrow(group_means)])
ggsave(here::here('fishing behavior','plots','groups_boxplots.png'),group_boxes,w=8,h=10)


# If only 2 groups
# group_means <- dat %>% 
#   select(-drvid,-crab_season,-revenue_mean,-revenue_sd,-landings_mean,-landings_sd,-vessel_size,-trip_dist_sd,-total_ports,-prop_other_tix,-trip_dist_mean) %>% 
#   drop_na() %>% 
#   mutate(partition=dat_clust$Best.partition %>% as.factor()) %>% 
#   pivot_longer(-partition,names_to='variable',values_to = 'value') %>% 
#   group_by(variable) %>% 
#   nest() %>% 
#   mutate(plotvars = map2(variable,data,function(j,k){
#       k %>% ggplot(aes(factor(partition),value,fill=factor(partition)))+
#       geom_boxplot(col='gray50')+
#       scale_fill_manual(values=p)+
#       labs(y="",x="",title=j)+
#       guides(fill='none')
#   }))
# 
# library(cowplot)
# 
# plot_grid(plotlist=group_means$plotvars,labels=LETTERS[1:nrow(group_means)])
```

Letters in the plot above show the results of Tukey's honest significant difference test between the values of each variable amongst classes. We can use these to further define each class, and give each a nickname.

1. Group 1 is associated with lower values of the port use metrics, the 2nd-lowest in trip duration. This group has the 2nd-shortest seasons and 2nd-lowest entropy among groups, with small home range, and 2nd-lowest risk-taking behavior. However, this group is associated with the 2nd-largest proportion of non-Dungeness revenue and tickets, and has the greatest revenue diversity.

2. Group 2 has the most localized vessels, with the smallest home ranges and shortest trips. These vessels have the 2nd-longest Dungeness seasons of any group, the lowest risk-taking behavior, and are specialized in Dungeness fishing, having the lowest proportion of non-Dungeness revenue and lowest revenue diversity.

3. Group 3 is associated with the second greatest values in most ofthe port metrics, with a relatively high number of total ports visited per trip and per month, and larger port use diversity. It is also associated with the second highest trip durations. This group is associated with the longest seasons, 2nd-largest choice entropy, 2nd-largest home range, and 2nd-largest risk, but has the 2nd-lowest outside revenue and revenue diversity.

3. Group 4 is composed of the vessels that visit the most ports, take the longest trips, and have the highest choice entropy and home range of all the groups. However, they have the shortest mean season length. They have the highest values for risk-taking behavior, and participate in many other fisheries, as indicated by their high values for proportion of outside revenue and tickets.

Together, these groups can be conceptualized along two axes---spatial behavior and fishery participation. Groups 3 and 4 display high choice entropy, visit many ports, and have larger home ranges, whereas groups 1 and 2 display much more fidelity to small home ranges and reduced numbers of ports. However, in looking at participation of these fishers in other fisheries, it is groups 2 and 3 that exhibit the greatest fidelity to the Dungeness fishery, while groups 1 and 4 participate in many other fisheries. This participation in other fisheries is also manifest in their season lengths, which are shortest for groups 1 and 4.

Consequently, for the rest of the results, we refer to these groups as Roving (i.e., exploratory, high port use, etc.) versus Local, and Specialist (Dungeness-specific) versus Generalist (participates in many fisheries). Group 2 is the Local Specialists, Group 1 is the Local Generalists, Group 3 is the Roving Specialists, and Group 4 is the Roving Generalists.

```{r}
# Table of group definitions based on mean value of metrics
groups_table <- tibble(
  `Local Generalists`= c(3,3,3,3,2,3,1,1,3,3,3),
  `Local Specialists` = c(3,4,3,4,1,2,4,4,4,4,4),
  `Roving Specialists` = c(2,2,1,2,3,1,3,3,2,2,2),
  `Roving Generalists` = c(1,1,1,1,4,4,1,1,1,1,1)) %>% 
  mutate(metric=c("Ports per Trip",
         "Ports per Month",
         "Port Diversity",
         "Mean Trip Duration",
         "SD Trip Duration",
         "Season Length",
         "Non-Dungeness Revenue",
         "Revenue Diversity",
         "Risk Taking",
         "Location Entropy",
         "Home Range Size")) %>% 
  pivot_longer(cols=1:4,names_to="Group") %>% 
  mutate(metric=factor(metric,levels=c("Ports per Trip",
         "Ports per Month",
         "Port Diversity",
         "Mean Trip Duration",
         "SD Trip Duration",
         "Season Length",
         "Home Range Size",
         "Non-Dungeness Revenue",
         "Revenue Diversity",
         "Risk Taking",
         "Location Entropy")))

groups_table_plot <- groups_table %>% 
  ggplot(aes(metric,Group,fill=factor(value)))+
  geom_tile()+
  geom_text(aes(label=value))+
  labs(x="Metric",y="")+
  coord_fixed()+
  scale_fill_manual(values=rev(RColorBrewer::brewer.pal(4,"Blues")),guide='none')+
  theme(axis.text.x = element_text(angle=45,vjust=1,hjust=1),
        panel.grid.major=element_line(linetype=1))
groups_table_plot
ggsave(here::here('fishing behavior','plots','groups_rankings_plot.png'),groups_table_plot,w=6,h=4)
```

```{r}
## Add factor levels/names to clustered data
dat_clustered <- dat_clustered %>%
  mutate(partition=case_when(
    partition==3 ~ "Roving Specialists",
    partition==1 ~ "Local Generalists",
    partition==4 ~ "Roving Generalists",
    partition==2 ~ "Local Specialists"
  )) %>%
  mutate(partition=factor(partition,levels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists")))
# dat_clustered <- dat_clustered %>% 
#   mutate(partition=case_when(
#     partition==1 ~ "Locals",
#     partition==2 ~ "Rovers",
#   )) %>% 
#   mutate(partition=factor(partition,levels=c("Locals","Rovers")))
vessel_list <- unique(dat_clustered$drvid)
```

## Variable Importance

We can investigate the contribution of individual variables to the eventual classification. We use random forests in the package `randomForest` to see which variables contribute most to classification.

Random forests are built from a number of individual classification trees (we use 1000). Each tree is built by recursive binary partitioning of the data, using a predictor variable (e.g., `trip_dur_mean`) to make a split in the data to create the most homogenous subgroups, where homogeneity is measured by the Gini coefficient on the relative proportions of group (Group 1, 2, 3, or 4) membership. The tree keeps dividing until the Gini index no longer declines with further splitting, at which point the tree is "fully grown".

Random forests build many of these trees, with two differences from single classification trees. First, for each tree, only a bootstrapped subsample of the original data is chosen for classification. Second, only a subset of the predictor variables are "available" to the tree for binary partitioning, chosen randomly. Therefore, each tree is twice randomized---first through bootstrapping, and then through the random selection of partitioning variables; hence creating the "random forest". Once many trees are grown from the bootstrapped sample, the classes for the observations from the original data set that were not chosen for fitting (known as out-of-bag observations) are predicted by each tree in the forest. We compile the rate at which the forest mis-classifies observations into the incorrect class. The measure of variable importance is the *change* in this mis-classification rate when a variable is randomly permuted in the out-of-bag sample. In other words, we measure how much worse our classification performs without the correctly-ordered variable.
```{r}
variable_name_matches <- tibble(v=c("n_ports_trip","ports_mean_mth","port_shannon","trip_dur_mean","trip_dur_sd","quant90_day","prop_other_revenue","revenue_diversity","prop_highwinds","entropy_quant90","homerange","vessel_size"),metric=c("Ports per Trip",
         "Ports per Month",
         "Port Diversity",
         "Mean Trip Duration",
         "SD Trip Duration",
         "Season Length",
         "Non-Dungeness Revenue",
         "Revenue Diversity",
         "Risk Taking",
         "Location Entropy",
         "Home Range Size",
         "Vessel Size"))
```

We apply this procedure to our data, using our four groups and growing 1000 trees.

```{r}
dat_nolabs <- dat_clustered %>% 
  na.omit() %>% 
  select(-(1:2)) %>% 
  mutate(partition=as.factor(partition))

library(randomForest)
rf <- randomForest(partition~.,data=dat_nolabs,importance = TRUE,ntree=1000)
var_imp <- rf$importance %>% as_tibble(rownames="variable") %>% 
  select(variable,MeanDecreaseAccuracy) %>% 
  mutate(rel_imp=MeanDecreaseAccuracy*100)
var_imp %>% 
  arrange(desc(rel_imp)) %>% 
  mutate(varname=factor(variable,levels=variable)) %>% 
  ggplot(aes(varname,rel_imp))+
  geom_col()+
  # scale_y_continuous(breaks=seq(0,10,by=2))+
  labs(x="Variable",y="Relative Importance")+
  theme(axis.text.x = element_text(angle=90))

# With vessel size
vessel_sizes <- read_rds(here::here('fishing behavior','vessel_sizes.rds')) %>% group_by(drvid,crab_season) %>% slice(1)
dat_nolabs_vesselsize <- dat_clustered %>% 
  na.omit() %>%
  left_join(vessel_sizes)%>% 
  na.omit() %>% 
  select(-(1:2)) %>% 
  mutate(partition=as.factor(partition))
rf2 <- randomForest(partition~.,data=dat_nolabs_vesselsize,importance = TRUE,ntree=1000)
var_imp2 <- rf2$importance %>% as_tibble(rownames="variable") %>% 
  select(variable,MeanDecreaseAccuracy) %>% 
  mutate(rel_imp=MeanDecreaseAccuracy*100) %>%
  left_join(variable_name_matches,by = c("variable"="v"))
rel_imp_plot <- var_imp2 %>% 
  arrange(desc(rel_imp)) %>% 
  ggplot(aes(x=fct_reorder(metric,-rel_imp),y=rel_imp))+
  geom_col()+
  # scale_y_continuous(breaks=seq(0,10,by=2))+
  labs(x="",y="Relative Importance")+
  theme(axis.text.x = element_text(angle=45,vjust=1,hjust=0.8,size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor=element_blank(),
        axis.title.x = element_text(size=8),
        axis.title.y=element_text(size=8))
        # plot.background = element_rect(color="black"))
rel_imp_plot
```

```{r}
#combine with PCA
library(cowplot)

fig_pca_rf <- plot_grid(cluster3_pca,rel_imp_plot,nrow=2,labels='auto',rel_heights = c(1,0.8))

# fig_pca_rf <- ggdraw(cluster3_pca) +
#   draw_plot(rel_imp_plot, .6, .5, .4, .4) +
#   draw_plot_label(
#     c("a", "b"),
#     c(0.1, 0.6),
#     c(0.95, 0.95),
#     size = 12
#   )
ggsave(here::here('fishing behavior','plots','fig_pca_rf.png'),fig_pca_rf,w=7.5,h=9)
```


The two variables that, when permuted, had the greatest effect on classification errors were proportion of non-Dungeness revenue and port use diversity, confirming our observation that the groups seem to partition in relation to their diversity of fishery participation and their port use. Next in variable importance were mean trip duration, revenue diversity, and propensity to fish in high-wind conditions.

```{r}
## Mobility and Flexibility Across Years
# 
# As a demonstration of the major differences between groups, we show the distributions of non-Dungeness revenue and port use diversity between groups, and over time (in MHW and non-MHW years). For this we use the non-scaled data.

# mobility_flexibility <- dat %>% 
#   select(-revenue_mean,-revenue_sd,-landings_mean,-landings_sd,-vessel_size,-trip_dist_sd,-total_ports,-prop_other_tix,-trip_dist_mean) %>% 
#   # remove any observations with missing variables
#   drop_na() %>%
#   mutate_at(-(1:2),~./max(.,na.rm=T)) %>% 
#   mutate(partition=dat_clust$Best.partition) %>% 
#   as_tibble() %>% 
#   mutate(partition=case_when(
#     partition==3 ~ "Roving Specialists",
#     partition==1 ~ "Local Generalists",
#     partition==4 ~ "Roving Generalists",
#     partition==2 ~ "Local Specialists"
#   )) %>% 
#   # Add MHW indicator
#   mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
#   mutate(group_type=ifelse(partition %in% c("Local Specialists","Local Generalists"),"Local Groups","Roving Groups")) %>% 
#   # select vars of interest
#   select(drvid,crab_season,partition,group_type,is_heatwave,port_shannon,prop_other_revenue)
# 
# flexibility_plot <-mobility_flexibility %>% 
#   ggplot(aes(partition, prop_other_revenue,fill=is_heatwave))+
#   geom_boxplot()+
#   scale_fill_aaas()+
#   labs(fill="Period",x="Proportion Non-Dungeness Revenue")
# 
# mobility_plot <- mobility_flexibility %>%  
#   ggplot(aes(partition, port_shannon,fill=is_heatwave))+
#   geom_boxplot()+
#   scale_fill_aaas()+
#   labs(fill="Period",x="Port Diversity")
# 
# library(cowplot)
# 
# mobility_flexibility_plot<-plot_grid(flexibility_plot,mobility_plot,ncol=2,labels='auto')
#   
# mobility_flexibility_plot
```


## Vessel Size Distribution by Behavioral Group

Dialogue around the Dungeness crab fishery often focuses around vessel size (i.e., large vs. small boats). Our analysis suggests that although the behavioral groups are correlated with vessel size, there is substantial overlap in vessel size among the different groups, meaning that vessel size alone is insufficient to explain behavioral patterns. 

This is how vessel length maps on to behavioral groups in the fishery.

```{r}
# dat_clustered %>% select(-vessel_size) %>% left_join(vessel_sizes) %>% 
#   ggplot(aes(vessel_size,fill=factor(partition)))+
#   geom_density(alpha=0.5)+
#   labs(x="Vessel Length",y='density',fill='Group',title="Vessel Length Distribution by Behavioral Group")+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   facet_wrap(~crab_season)
vessel_length_dist_plot <-dat_clustered %>% left_join(vessel_sizes) %>% 
  ggplot(aes(vessel_size,fill=factor(partition)))+
  geom_density(alpha=0.5)+
  labs(x="Vessel Length",y='density',fill='Group',title="Vessel Length Distribution by Behavioral Group")+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  facet_wrap(~crab_season)
vessel_length_dist_plot
ggsave(here::here('fishing behavior','plots','vessel_length_dist_by_group.png'),vessel_length_dist_plot,w=6,h=5)
```

While the largest vessels are mostly categorized as Roving Generalists and the smallest are mostly Local Specialists, the other two behavioral groups are made up of a wide range of intermediate vessel sizes.

We can also investigate the correlation of vessel size with other variables in the cluster analysis. As expected from the above, larger vessels are associated with longer trips, more exploratory behavior, risk-taking behavior (i.e. propensity to fish in high winds), and shorter seasons.

```{r}
vessel_length_corr_plot <- vars.corrs %>% 
  filter(var1=='vessel_size',var2 !='vessel_size') %>% 
  arrange(desc(corr)) %>% 
  mutate(varname=factor(var2,levels=var2)) %>% 
  mutate(is_neg=ifelse(corr<0,"neg","pos")) %>% 
  ggplot(aes(varname,corr,fill=is_neg))+
  geom_col()+
  labs(x="Variable",y="Correlation with Vessel Length")+
  scale_fill_manual(values=c("red","blue"),name="")+
  scale_y_continuous(breaks=seq(-1,1,by=0.2))+
  guides(fill='none')+
  theme(axis.text.x = element_text(angle=90,vjust=0.5,hjust=1))
vessel_length_corr_plot
ggsave(here::here('fishing behavior','plots','vessel_length_correlations.png'),vessel_length_corr_plot,w=6,h=5)

```

## Class Transition Across Years

We have described the behavior of some broad groups of Dungeness crab fishers, and explored the importance of individual behavioral variables in distinguishing between groups. Next, we want to investigate how the total number of vessels in each class may have shifted over the course of years on our data, as well as explore interannual movements of individual vessels between the three classes.

```{r}
# key matching vessel-seasons to states
drvid_state_key <- fishtix %>% 
  filter(drvid %in% dat_clustered$drvid) %>% 
  distinct(drvid,crab_season,agency_code)

# count group membership in each year
class_by_yr <- dat_clustered %>% 
  group_by(crab_season,partition) %>% 
  summarise(n_vessels=n_distinct(drvid)) %>% 
  ungroup()
class_by_yr %>%
  ggplot(aes(crab_season,n_vessels,fill=factor(partition)))+
  geom_col()+
  labs(x="Crab Season",y="Number of Vessels",title="Number of Vessels by Behavior Class and Year",fill="Group")+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')
num_vessels_timeseries <- class_by_yr %>% 
  ggplot(aes(crab_season,n_vessels,group=factor(partition),color=factor(partition)))+
  geom_line(size=2)+
  geom_vline(xintercept=7.5,linetype=2,col="darkred")+
  geom_vline(xintercept=10.5,linetype=2,col="darkred")+
  labs(x="Crab Season",y="Number of Vessels",title="",color="")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.text = element_text(size=8),
        legend.position = 'bottom')
num_vessels_timeseries
ggsave(here::here('fishing behavior','plots','nvessels_groups.png'),num_vessels_timeseries,w=8,h=6)

class_by_yr %>% 
  group_by(crab_season) %>%
  mutate(prop_group=n_vessels/sum(n_vessels)) %>% 
  ggplot(aes(crab_season,prop_group,group=factor(partition),color=factor(partition)))+
  geom_line(size=2)+
  labs(x="Crab Season",y="Proportion of Vessels",title="Proportion of Vessels in each Group by Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

# bar plots of heatwave vs. non-heatwave years
heatwave_barplot <- class_by_yr %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>% 
  group_by(partition,is_heatwave) %>% 
  summarise(mean_vessels=mean(n_vessels),sd_vessels=sd(n_vessels)) %>% 
  ungroup() %>% 
  ggplot(aes(partition,mean_vessels,fill=is_heatwave))+
  scale_color_aaas()+
  geom_col(position=position_dodge(),col='black')+
  geom_errorbar(aes(partition,mean_vessels,group=is_heatwave,ymin=mean_vessels-sd_vessels,ymax=mean_vessels+sd_vessels),
                position=position_dodge(0.9),width=0.2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.position = c(0.8,0.8))+
  labs(x="Behavioral Group",y="Number of Vessels",fill="Period")
heatwave_barplot
ggsave(here::here('fishing behavior','plots','heatwave_groups.png'),heatwave_barplot,w=6,h=6)

library(cowplot)
ts_heatwave_groups_plot <- plot_grid(num_vessels_timeseries,heatwave_barplot,labels = "auto",nrow = 2)

ggsave(here::here('fishing behavior','plots','timeseries_and_heatwave_groups.png'),ts_heatwave_groups_plot,w=6,h=8)
```

We can also look at the flows of vessels between classes and years.

```{r,warning=F,message=F}
library(ggalluvial)

# for vessels that are not fishing, indicate whether it is a lack of VMS data (but the vessel recorded tickets), or whether there is no record of the vessel at all, which we indicate as 'not fishing'
novms_key <- dat %>% group_by(drvid,crab_season) %>%
  summarise(no_vms=is.na(n_ports_trip)|is.na(ports_mean_mth)|is.na(port_shannon)|is.na(trip_dur_mean)|is.na(trip_dur_sd)|is.na(prop_highwinds)|is.na(entropy_quant90)|is.na(homerange),
            no_dcrb=is.na(quant90_day)|is.na(prop_other_revenue)|is.na(revenue_diversity))
            
dat_alluvium <- dat_clustered %>%
  select(drvid,crab_season,partition) %>% 
  distinct() %>% 
  mutate(partition=as.character(partition)) 
  # complete(drvid,crab_season,fill=list('partition'="Not Fishing"))%>%
  # mutate(partition=factor(partition,levels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists","Not Fishing"))) %>% 
  # left_join(novms_key) %>% 
  #filter out seasons with no VMS data (but tickets recorded)
  # filter(!no_vms) %>% 
  # select(-no_vms,-no_dcrb_tix)

# with boats not fishing in a given season
dat_alluvium %>%
  ggplot(aes(x=crab_season,stratum=partition,alluvium=drvid,fill=partition,label=partition))+
  geom_flow(na.rm=T,color='darkgray')+
  geom_stratum(na.rm=T)+
  scale_fill_manual(values=c(p[2],p[1],p[4],p[3]),name="Group")+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank())+
  labs(x="Crab Season",y="Number of Vessels")

#consistency of each group
group_consistency <- dat_alluvium %>% count(drvid,partition) %>%
  group_by(drvid) %>% 
  mutate(prop_of_yrs=n/sum(n)) %>% 
  ungroup()

# boxplot of the average percentage of years classified in one group
group_consistency_boxplot <- group_consistency %>% 
  group_by(drvid) %>% 
  arrange(desc(prop_of_yrs)) %>% 
  slice(1) %>% 
  ungroup() %>%
  ggplot(aes(partition,prop_of_yrs,fill=partition))+
  geom_boxplot()+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4),name="")+
  labs(x="Group",y="Proportion of Seasons Classified in Group",title="Consistency of Group Membership")

# use fish tickets to look at the years where certain vessels aren't in the main analysis
# i.e. are they not fishing AT ALL (don't appear in the fish tickets) or participating in a different fishery

# key of vessel-seasons vs. classified group
drvid_group_key <- dat_clustered %>% select(drvid,crab_season,partition) %>% 
  distinct()

drvid_other_fisheries <- fishtix_long %>% 
  filter(drvid %in% vessel_list,crab_season != "2019-2020") %>%  # filter for in-season weeks
  filter(ticket_day_of_season>=0) %>% 
  distinct() %>% 
  # calculate DCRB vs. non-DCRB revenue
  mutate(is_DCRB=PACFIN_SPECIES_CODE=="DCRB") %>% 
  group_by(drvid,agency_code,crab_season) %>% 
  summarise(DCRB_revenue=sum(spp_revenue[is_DCRB]),other_revenue=sum(spp_revenue[!is_DCRB])) %>% 
  ungroup() %>% 
  mutate(DCRB_revenue=coalesce(DCRB_revenue,0),other_revenue=coalesce(other_revenue,0)) %>% 
  complete(drvid,crab_season) %>%
  # add partition information
  left_join(drvid_group_key) %>% 
  # check if missing seasons are because No VMS
  left_join(novms_key) %>% 
  distinct() %>% 
  # for missing data, clarify between stop fishing (no fish tickets recorded) versus fishing other species
  # (i.e., no DCRB revenue, but other revenue evident)
  mutate(other_fishing=no_dcrb & other_revenue>0) %>% 
  mutate(not_fishing=no_vms & no_dcrb & !other_fishing) %>% 
  # use all the logicals to better define the partition for each vessel-season
  mutate(status=case_when(
    is.na(partition)& not_fishing ~ "Not Fishing",
    is.na(partition)& no_vms & !no_dcrb & !other_fishing ~ "No VMS Data",
    is.na(partition)&other_fishing ~ "Different Fishery",
    TRUE ~ "Not Fishing"
  )) %>% 
  mutate(status=coalesce(partition,status))

# most common transition for each group
# including not fishing!
# second_choice_group <- drvid_other_fisheries %>%
#   group_by(drvid) %>%
#   arrange(crab_season) %>% 
#   mutate(next_partition=dplyr::lead(status,1)) %>% 
#   filter(!is.na(next_partition)) %>% 
#   ungroup() %>% 
#   count(status,next_partition) %>% 
#   group_by(status) %>%
#   ungroup() %>% 
#   arrange(status,desc(n)) %>% 
#   filter(status != "No VMS Data",next_partition !="No VMS Data")

# # with "no fishing" option
# second_choice_plot <- second_choice_group %>% 
#   group_by(status) %>% 
#   arrange(desc(n)) %>% 
#   slice(1:2) %>% 
#   mutate(next_partition=factor(next_partition,levels=c("Different Fishery","Not Fishing","Local Specialists","Local Generalists","Roving Specialists","Roving Generalists"))) %>% 
#   mutate(status=factor(status,levels=c("Different Fishery","Not Fishing","Local Specialists","Local Generalists","Roving Specialists","Roving Generalists"))) %>% 
#   mutate(pos=as.numeric(next_partition)) %>% 
#   group_by(status) %>% 
#   mutate(time=c(1,2)) %>% 
#   ungroup() %>% 
#   ggplot(aes(time,pos,col=status))+geom_line(size=3,alpha=0.7)+geom_point(col='black',size=5)+
#   scale_color_manual(values=c("black","gray50",p),guide="none")+
#   scale_y_continuous(labels=c("Different Fishery","Not Fishing","Local Specialists","Local Generalists","Roving Specialists","Roving Generalists"),breaks=seq(1,6,by=1),sec.axis = dup_axis())+
#   labs(y='',x='',title="")+
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor=element_blank(),
#         axis.text.y=element_text(family="sans",size=10),
#         axis.text.x=element_blank())
# second_choice_plot
# without "no fishing"
# second_choice_group %>% 
#   group_by(partition) %>% 
#   arrange(desc(n)) %>% 
#   filter(!(partition!="Not Fishing"&next_partition=="Not Fishing")) %>% 
#   slice(1:2) %>% 
#   mutate(next_partition=factor(next_partition,levels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists","Not Fishing"))) %>% 
#   mutate(partition=factor(partition,levels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists","Not Fishing"))) %>% 
#   mutate(pos=as.numeric(next_partition)) %>% 
#   group_by(partition) %>% 
#   mutate(time=c(1,2)) %>% 
#   ungroup() %>% 
#   ggplot(aes(time,pos,col=partition))+geom_point(size=5)+geom_line()+
#   scale_color_manual(values=c(p,"gray50"),guide="none")+
#   scale_y_continuous(labels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists","Not Fishing"),sec.axis = dup_axis())+
#   labs(y='',x='',title="Most Common Group Transitions (Excluding Fishery Exit)")+
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor=element_blank(),
#         axis.text.y=element_text(family="sans",size=12),
#         axis.text.x=element_blank())

# transitions between all groups by season
trans_by_season <- drvid_other_fisheries %>%
  group_by(drvid,agency_code) %>%
  arrange(crab_season) %>% 
  mutate(last_status=dplyr::lag(status,1)) %>% 
  filter(!is.na(last_status)) %>% 
  filter(status != "No VMS Data", last_status != "No VMS Data") %>% 
  ungroup() %>% 
  count(crab_season,status,last_status) %>% 
  group_by(crab_season) %>% 
  mutate(tot_n=sum(n)) %>% 
  mutate(prop=n/tot_n)

# Most common transition types by crab season
trans_types_by_season <- drvid_other_fisheries %>%
  group_by(drvid) %>%
  arrange(crab_season) %>% 
  mutate(last_status=dplyr::lag(status,1)) %>% 
  filter(!is.na(last_status)) %>% 
  filter(status != "No VMS Data", last_status != "No VMS Data") %>% 
  ungroup() %>% 
  count(crab_season,status,last_status) %>% 
  group_by(crab_season) %>% 
  mutate(tot_n=sum(n)) %>% 
  mutate(transition_type=case_when(
    status=="Not Fishing" & last_status=="Not Fishing" ~ "Not Fishing",
    status=="Different Fishery" & last_status=="Different Fishery" ~ "Different Fishery",
    status=="Not Fishing" & last_status!="Not Fishing" ~ "Exit",
    status=="Different Fishery" & last_status!="Different Fishery" ~ "Fish Other Species",
    status!="Not Fishing" & last_status=="Not Fishing" ~ "Enter",
    status!="Not Fishing"& status !="Different Fishery" & last_status=="Different Fishery" ~ "Enter",
    status!="Not Fishing" & last_status!="Not Fishing" & status==last_status ~ "Same Group",
    status!= "Not Fishing" & last_status!="Not Fishing" & status != last_status ~ "Switch Groups"
    )) %>% 
  ungroup() %>% 
  group_by(crab_season,transition_type) %>% 
  summarise(n=sum(n),prop=n/tot_n) %>% 
  filter(crab_season != "2008-2009") %>% 
  distinct() %>% 
  mutate(transition_type=factor(transition_type,levels=c("Not Fishing","Different Fishery","Fish Other Species","Enter","Exit","Same Group","Switch Groups")))

transition_types_by_season_plot <- trans_types_by_season %>% 
  ggplot(aes(crab_season,prop,group=transition_type,col=transition_type,fill=transition_type))+
  geom_line()+geom_point()+
  scale_fill_jco()+
  scale_color_jco()+
  labs(x="Crab Season",y="Proportion of Vessels",fill="Transition Type",col="Transition Type")+
  theme(axis.text.x=element_text(angle=90,vjust=0.5),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank())
transition_types_by_season_plot

# num_seasons <- dat_alluvium %>% group_by(drvid) %>% summarise(n_seasons=n_distinct(crab_season)) %>% 
#   count(n_seasons) 
# 
# num_seasons_p <- num_seasons%>% 
#   ggplot(aes(n_seasons,n))+
#   geom_bar(fill=p[1],alpha=0.8,stat='identity')+
#   labs(x="Number of Fished Seasons",y="Vessels")+
#   scale_x_continuous(breaks=seq(1,11,by=1),labels=seq(1,11,by=1))
# num_seasons_p
```
From this figure we can see substantial flows between groups in certain years. For example, many vessels classified as Local Generalists joined the other groups between the 2008 and 2009 crab seasons. Similarly, after the 2014-15 crab season, many Local Generalists became Local Specialists or Roving Generalists.


```{r}
## Odds of switching groups
# start_roving <- trans_by_season %>% 
#   filter(status != last_status) %>% 
#   filter(status %in% c("Roving Specialists","Roving Generalists"), 
#          last_status %in% c("Local Specialists","Local Generalists")) %>% 
#   group_by(crab_season) %>% 
#   summarise(tot_swapped=sum(n))
# switch_to_roving_plot <- start_roving %>% 
#   ggplot(aes(crab_season, tot_swapped,group=1))+
#   geom_point()+geom_line()+
#   labs(x="Crab Season",y="Number of Vessels that Switched to Roving")
# switch_to_roving_plot
# 
# start_or_stay_roving <- trans_by_season %>% 
#   filter(status != last_status) %>% 
#   filter(status %in% c("Roving Specialists","Roving Generalists"), 
#          last_status %in% c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists")) %>% 
#   group_by(crab_season) %>% 
#   summarise(tot_swapped=sum(n))
# switch_to_or_stay_roving_plot <- start_or_stay_roving %>% 
#   ggplot(aes(crab_season, tot_swapped,group=1))+
#   geom_point()+geom_line()+
#   labs(x="Crab Season",y="Number of Vessels Roving")
# switch_to_or_stay_roving_plot

# tot_roving <- trans_by_season %>% 
#   filter(status %in% c("Roving Specialists","Roving Generalists")) %>%
#   # filter(!(status=="Roving Specialists"&last_status=="Roving Generalists"),
#   #        !(status=="Roving Generalists"&last_status=="Roving Specialists")) %>% 
#   group_by(crab_season) %>% summarise(tot_rove=sum(n))
# 
# total_roving_plot <- tot_roving %>% 
#   ggplot(aes(crab_season, tot_rove,group=1))+
#   geom_point()+geom_line()+
#   labs(x="Crab Season",y="Number of Vessels Roving")
# total_roving_plot
```

One analysis we can do with the group-membership data is to statistically check whether there are particular years with greater switching between groups. We want to see whether there was a greater propensity to switch to a Roving strategy during the period of the marine heatwave (2014-15 to 2017-18). To be precise, we want to statistically test whether the odds of switching into Roving Specialists or Roving Generalists was signifcantly greater during the MHW period than the non-MHW period. We do this with a logit regression.

```{r}
# switching_logit_dat <- drvid_other_fisheries %>%
#   group_by(drvid) %>%
#   arrange(crab_season) %>% 
#   mutate(last_status=dplyr::lag(status,1)) %>% 
#   filter(!is.na(last_status),crab_season!="2009-2010",crab_season!="2008-2009") %>% 
#   filter(status != "No VMS Data", last_status != "No VMS Data") %>% 
#   # indicate whether a vessel switching into a Roving group
#   mutate(switch_type=case_when(
#     last_status=="Local Generalists" & status != "Local Generalists" ~ 1,
#     # status=="Roving Generalists" & last_status != "Roving Generalists" ~ 1,
#     # status=="Roving Specialists" & last_status != "Roving Specialists" ~ 1,
#     # !(status %in% c("Roving Generalists","Roving Specialists")) ~ 0,
#     status == last_status ~ 0,
#     TRUE ~ 0
#   )) %>% 
#   mutate(mhw=ifelse(crab_season %in% c("2014-2015","2015-2016","2016-2017","2017-2018"),"MHW","Baseline"))
# 
# switching_logit_dat %>% group_by(crab_season) %>% summarise(switchers=sum(switch_type,na.rm=T))
# 
# switch_fit <- glm(switch_type~mhw+agency_code,family=binomial(link="logit"),data=switching_logit_dat)
# summary(switch_fit)
# 
# # what if we add state-by-state controls?

```



## Behavioral Class and Performance

Our last research question is, "*How do fishing behavioral strategies relate to revenue and landings from fishing?*". Now that we have the three groups of vessels, we can use these groups to explore how these behavioral strategies "perform" in terms of revenue and profits over the course of the season, and relative to the efficiency of crab capture (i.e., catch per unit effort).

### Additional Cost and Abundance Information

In order to compare the performance of the FBTs, we need to estimate the cost of fishing for each trip or vessel. We also have a record of estimated preseason abundance of crabs, which we can use to explore fisher performance as a function of available Dungeness biomass.

### Cost of Fishing

To measure cost of fishing, we adopt data from a survey done by Dewees et al. (2004). A survey was conducted of small, medium, and large size-class vessels. We use their mean estimates of annual and daily fishing costs to associate a cost with each trip. Dollar values are adjusted for inflation.

There are daily costs associated with vessel ownership that are associated with fuel and bait. Additionally, larger vessels require a greater number of crew members, which must be accounted for. Using The Dewees et al. study and simulation, we parameterize the following relationship:

$$C_t = C_f + C_c$$
Where $C_t$ is trip cost that is a function of fuel and bait cost $C_f$ and crew cost $C_c$. The cost of fuel and bait is a function of vessel length $L$ and trip length in days $d$, while crew cost is a function of vessel length and trip revenue $R$.

$$C_f = f(L,d)$$
$$C_c = f(L,R)$$

```{r}
# daily costs function
# to make a smooth function, take means and SD from Dewees et al and sample, then fit a line
# in the sample, use min and max values from our dataset on vessel lengths
daily_cost_sim <- function(x){
  if(x<30) cost<-(rnorm(1,57,63)+rnorm(1,41,44)+rnorm(1,40,54))
  if(x>=30&x<=50) cost<-rnorm(1,155,233)+rnorm(1,68,137)+rnorm(1,41,52)
  if(x>50) cost<-rnorm(1,226,163)+rnorm(1,150,83)+rnorm(1,62,29)
  # bait, fuel, and other
  max(cost,0)
}

# also include debit for crew share (so these are costs to captain)
crew_share_sim <- function(x){
  if(x<30) share<-(rnorm(1,0.15,0.1))
  if(x>=30&x<=50) share<-rnorm(1,0.24,0.11)
  if(x>50) share<-rnorm(1,0.31,0.10)
  max(0,share)
}
cost_sim <- tibble(vessel_length=runif(10000,21,103)) %>% 
  mutate(daily_cost= purrr::map_dbl(vessel_length,daily_cost_sim),
         crew_share=purrr::map_dbl(vessel_length,crew_share_sim))

library(ggpubr)
cost_sim %>% ggplot(aes(vessel_length,daily_cost))+
  geom_point(size=0.5)+geom_smooth(method='lm')+
  stat_regline_equation()+
  labs(x="Vessel Length",y="Daily Cost",title="Daily Cost Simulation")
cost_sim %>% ggplot(aes(vessel_length,crew_share))+
  geom_point(size=0.5)+geom_smooth(method='lm')+
  stat_regline_equation()+
  labs(x="Vessel Length",y="Crew Share",title="Daily Cost Simulation, Crew Share")

# pull out the equation of the line
# assume 2% inflation/year
trip_cost_fx <- function(vessel_size,num_days,trip_rev,trip_yr){
  cost_daily<-(150+3.5*vessel_size)*num_days*1.02^(trip_yr-2004)
  crew_share <- (0.17+0.0018*vessel_size)*trip_rev
  cost_daily+crew_share
}
```

### Calculate Performance Metrics

```{r}

# organize fish tickets by group and calculate metrics like cpue, trip length
fishtix_plus <- fishtix %>%
  # add information about how long each trip is
  left_join(trip_duration_key) %>% 
  ungroup() %>% 
  # dplyr::select only fish tickets that have associated vms information
  left_join(vms_tickets) %>% filter(has_vms==1) %>% dplyr::select(-has_vms) %>% 
  distinct(date,drvid,crab_season,agency_code,Rec_ID,DCRB_revenue,DCRB_lbs,SABL_revenue,LOBS_revenue,SPRW_revenue,trip_dur,start_of_season_oneperc) %>%
  # join cluster group/partition information
  left_join(drvid_group_key) %>% 
  filter(!is.na(partition)) %>%
  
  # calculate individual (vessel-level) weeks of the season
  # mutate(firstdate=min(date)) %>% 
  mutate(timediff=start_of_season_oneperc%--%date) %>% 
  mutate(week=time_length(timediff,'weeks')) %>% 
  mutate(week=floor(week)) %>% 
  dplyr::select(-timediff,-start_of_season_oneperc) %>%
  ungroup() %>%
  # filter for in-season weeks
  filter(week>=0) %>% 
  
  # calculate total landings in each state and week
  group_by(agency_code,crab_season,week) %>% 
  mutate(landings_state_week=sum(DCRB_lbs,na.rm=T)) %>% 
  ungroup() %>% 
  
  # calculate cumulative landings by state
  group_by(agency_code,crab_season) %>% 
  arrange(date) %>% 
  mutate(cumulative_landings=cumsum(DCRB_lbs),cumulative_landings_thousand_mt=cumulative_landings/1000/2204.63) %>% 
  #join Richersen's abundance data
  left_join(abun) %>% 
  # calculate the remaining biomass in each state by subtracting landings from preseason abundance
  mutate(thousand_mt_remaining=mean_preseason_abun-cumulative_landings_thousand_mt) %>% 
  # calculate the proportion remaining of the original biomass
  mutate(prop_remaining=thousand_mt_remaining/mean_preseason_abun) %>% 
  mutate(prop_remaining=pmax(0,prop_remaining)) %>% 
  # filter(!is.na(prop_remaining)) %>% 
  ungroup() %>% 
  
  # cpue is lbs caught divided by days fished
  mutate(cpue=DCRB_lbs/trip_dur) %>% 

  # using the cost simulation above, calculate the cost and profit estimated for each trip
  # add trip duration and cost to each ticket
  left_join(vessel_sizes) %>% 
  mutate(trip_year=year(date)) %>% 
  mutate(trip_cost=trip_cost_fx(vessel_size,trip_dur,DCRB_revenue,trip_year)) %>% 
  mutate(trip_profit=DCRB_revenue-trip_cost) 
```

### Metrics by Group and Week

```{r}
metrics_by_partition_week<-fishtix_plus %>%
  #calculate weekly capture
  ungroup() %>% 
  group_by(partition,week) %>%
  summarise(n_tix=n_distinct(Rec_ID),
            n_vessels=n_distinct(drvid),
            mean_prop_remaining=mean(prop_remaining,na.rm=T),
            mean_catch=mean(DCRB_lbs,na.rm=T),
            mean_cpue=mean(cpue,na.rm=T),
            log_mean_cpue=log(mean(cpue,na.rm=T)),
            mean_trip_dur=mean(trip_dur,na.rm=T),
            mean_revenue_group=mean(DCRB_revenue),
            mean_cost_group=mean(trip_cost),
            mean_profit_per_trip=mean(trip_profit,na.rm=T),
            mean_profit_per_day=mean(trip_profit,na.rm=T)/mean(trip_dur,na.rm=T),
            mean_costratio_group=mean(DCRB_revenue,na.rm=T)/mean(trip_cost,na.rm=T),
            mean_relative_abun=mean(prop_remaining)) %>% 
  ungroup() %>% 
  group_by(partition) %>% 
  arrange(week) %>% 
  # cumulative profit by group across the course of the season
  mutate(cumulative_mean_profit=cumsum(mean_profit_per_trip),
         cumulative_revenue=cumsum(mean_revenue_group)) %>% 
  mutate(marginal_profit=cumulative_mean_profit-lag(cumulative_mean_profit,1),
         marginal_revenue=cumulative_revenue-lag(cumulative_revenue,1)) %>% 
  ungroup()

# Prop remaining vs. CPUE
metrics_by_partition_week %>% 
  ggplot(aes(mean_prop_remaining,mean_cpue,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Proportion Resource Remaining",y="CPUE (lbs per day)",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Mean Revenue
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_revenue_group,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Revenue per Trip",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# Mean Cost
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_cost_group,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Cost per Trip",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Mean profit per trip
profit_per_trip <- metrics_by_partition_week %>% 
  ggplot(aes(week,mean_profit_per_trip/1000,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  ylim(NA,40)+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Profit per Trip ($1000s)",col="",fill="")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(legend.position=c(0.7,0.8))
profit_per_trip
ggsave(here::here('fishing behavior','plots','profit_per_trip.png'),profit_per_trip,w=6,h=4)

profit_per_day <- metrics_by_partition_week %>% 
  ggplot(aes(week,mean_profit_per_day/1000,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  ylim(NA,10)+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Profit per Day ($1000s)",col="",fill="")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(legend.position=c(0.7,0.8))
profit_per_day
ggsave(here::here('fishing behavior','plots','profit_per_day.png'),profit_per_day,w=6,h=4)

# Mean profit per day
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_profit_per_day,col=partition,fill=partition))+
  geom_point(size=0.5)+xlim(0,25)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Profit per Day",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Ratio of revenue to cost
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_costratio_group,col=partition,fill=partition))+
  geom_point(size=0.5)+xlim(0,25)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  geom_hline(yintercept=1)+
  labs(x="Week of Season",y="Revenue/Cost Ratio",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# CPUE versus week
metrics_by_partition_week %>%
  ggplot(aes(week,mean_cpue,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week",y="CPUE (lbs per day)",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Mean profit versus log cpue
# metrics_by_partition_week %>% 
#   filter(n_tix>5) %>% 
#   ggplot(aes(log_mean_cpue,mean_profit_group,col=partition,fill=partition))+
#   geom_point(size=0.5)+
#   geom_smooth()+
#   # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
#   labs(x="Log (CPUE)",y="Profit",col="Group",fill="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Cumulative profit
# metrics_by_partition_week %>%
#   ggplot(aes(week,cumulative_mean_profit,col=partition,fill=partition))+
#   geom_point(size=0.5)+
#   geom_smooth()+
#   # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
#   labs(x="Week of Season",y="Cumulative Profit",col="Group",fill="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Marginal profit
# metrics_by_partition_week %>%
#   ggplot(aes(week,marginal_profit,col=partition,fill=partition))+
#   geom_point(size=0.5)+
#   geom_smooth()+
#   # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
#   labs(x="Week of Season",y="Marginal Profit",col="Group",fill="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

```

### Per-trip Revenue and Landings

Here is how average and variance in revenue, landings, and estimated profits have changed over time for each behavioral group

```{r}
dat_rev <- fishtix_plus %>% group_by(crab_season,partition) %>%
  summarise(n = n(),
            rev_per_trip=mean(DCRB_revenue,na.rm=T),
            rev_sd=sd(DCRB_revenue,na.rm=T),
            rev_se=rev_sd/n^0.5,
            land_per_trip=mean(DCRB_lbs,na.rm=T),
            land_sd=sd(DCRB_lbs,na.rm=T),
            land_se=land_sd/n^0.5,
            profit_per_trip=mean(trip_profit,na.rm=T),
            profit_sd=sd(trip_profit,na.rm=T),
            profit_se=profit_sd/n^0.5,
            profit_cv=profit_sd/profit_per_trip)

# Per trip revenue +/- 2SE
dat_rev %>% 
  ggplot(aes(crab_season,rev_per_trip,ymin=rev_per_trip-2*rev_se,ymax=rev_per_trip+2*rev_se,group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5)+geom_linerange(size=1.5)+
  labs(x="Crab Season",y="Revenue per Trip",title="Per-trip Revenue by Behavior Class and Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

# revenue variance
# dat_rev %>% 
#   ggplot(aes(crab_season,rev_sd,group=factor(partition),color=factor(partition)))+
#   geom_line(size=2)+
#   labs(x="Crab Season",y="SD of Revenue per Trip",title="Per-trip Standard Deviation of Revenue by Behavior Class and Year",color="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   theme(axis.text.x = element_text(angle=90,vjust=0.5),
#         legend.position = 'bottom')

# Mean landings +/- 2SE
dat_rev %>% 
  ggplot(aes(crab_season,land_per_trip,ymin=land_per_trip-2*land_se,ymax=land_per_trip+2*land_se,group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5)+geom_linerange(size=1.5)+
  labs(x="Crab Season",y="Landings (lbs) per Trip",title="Per-trip Landings by Behavior Class and Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

# SD landings
# dat_rev %>% 
#   ggplot(aes(crab_season,land_sd,group=factor(partition),color=factor(partition)))+
#   geom_line(size=2)+
#   labs(x="Crab Season",y="SD of Landings (lbs) per Trip",title="Per-trip Standard Deviation of Landings by Behavior Class and Year",color="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   theme(axis.text.x = element_text(angle=90,vjust=0.5),
#         legend.position = 'bottom')

# Mean profits per trip
dat_rev %>% 
  ggplot(aes(crab_season,profit_per_trip,ymin=profit_per_trip-2*profit_se,ymax=profit_per_trip+2*profit_se,group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5)+geom_linerange(size=1.5)+
  labs(x="Crab Season",y="Estimated Profit per Trip",title="Per-trip Profit by Behavior Class and Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

# SD profits per trip
# dat_rev %>% 
#   ggplot(aes(crab_season,profit_sd,group=factor(partition),color=factor(partition)))+
#   geom_line(size=2)+
#   labs(x="Crab Season",y="SD Profit per Trip",title="Per-trip Standard Deviation of Profit by Behavior Class and Year",color="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   theme(axis.text.x = element_text(angle=90,vjust=0.5),
#         legend.position = 'bottom')

# CV profit per trip
# dat_rev %>% 
#   filter(profit_cv<5) %>% 
#   ggplot(aes(crab_season,profit_cv,group=factor(partition),color=factor(partition)))+
#   geom_line(size=1.5)+
#   labs(x="Crab Season",y="CV Profit per Trip",title="CV of Per-trip Profit by Behavior Class and Year",color="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   theme(axis.text.x = element_text(angle=90,vjust=0.5),
#         legend.position = 'bottom')

```

For these plots, the standard deviation is greater than the means, partly because of the exponential-like decline in landings and profits as each season progresses.

### Season-long Revenue and Landings
  
What about total revenue gained from the Dungeness fishery over the course of the entire season?

```{r}
total_rev_landings_season <- fishtix_plus %>%
  distinct(drvid,crab_season,Rec_ID,DCRB_revenue,DCRB_lbs,trip_profit,partition) %>% 
  group_by(drvid,crab_season,partition) %>% 
  summarise(
    total_rev=sum(DCRB_revenue,na.rm=T),
    total_land=sum(DCRB_lbs,na.rm=T),
    total_profit=sum(trip_profit,na.rm=T)) %>% 
  ungroup() %>% 
  group_by(crab_season,partition) %>% 
  summarise(n=n(),
            rev_tot=mean(total_rev,na.rm=T),
            rev_sd=sd(total_rev,na.rm=T),
            rev_se=rev_sd/n^0.5,
            # landings in MT
            land_tot=mean(total_land,na.rm=T)/2204.64,
            land_sd=sd(total_land,na.rm=T)/2204.64,
            land_se=land_sd/n^0.5,
            profit_tot=mean(total_profit,na.rm=T),
            profit_sd=sd(total_profit,na.rm=T),
            profit_se=profit_sd/n^0.5) %>% 
  ungroup()

total_rev_landings_season %>%
  ggplot(aes(crab_season,rev_tot,ymin=rev_tot-2*rev_se,ymax=rev_tot+2*rev_se,
             group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5,position=position_dodge(width=0.2))+geom_linerange(size=1,position=position_dodge(width=0.2))+
  labs(x="Crab Season",y="Mean Total Season Revenue",title="Total Revenue by Behavior Class and Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

total_rev_landings_season %>%
  ggplot(aes(crab_season,land_tot,ymin=land_tot-2*land_se,ymax=land_tot+2*land_se,
             group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5,position=position_dodge(width=0.2))+geom_linerange(size=1,position=position_dodge(width=0.2))+
  labs(x="Crab Season",y="Mean Total Season Landings (MT)",title="Total Landings by Behavior Class and Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

tot_profit_season_plot <- total_rev_landings_season %>%
  filter(crab_season != "2008-2009") %>%
  mutate(profit_tot=profit_tot/1e3,profit_se=profit_se/1e3) %>% 
  ggplot(aes(crab_season,profit_tot,ymin=profit_tot-2*profit_se,ymax=profit_tot+2*profit_se,
             group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5,position=position_dodge(width=0.2))+geom_linerange(size=1,position=position_dodge(width=0.2))+
  geom_vline(xintercept=6.5,linetype=2,col="darkred")+
  geom_vline(xintercept=9.5,linetype=2,col="darkred")+
  labs(x="Crab Season",y="Profit per Vessel ($1000s)",title="",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        axis.title=element_text(family="sans",size=12,color="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'bottom')

tot_profit_season_plot

ggsave(here::here('fishing behavior','plots','total_profit_by_season.png'),tot_profit_season_plot,w=8,h=6)

# heatwave vs. non heatwave years
heatwave_profit_barplot <- fishtix_plus %>%
  filter(crab_season != "2008-2009") %>%
  distinct(drvid,crab_season,Rec_ID,DCRB_revenue,DCRB_lbs,trip_profit,partition) %>% 
  group_by(drvid,crab_season,partition) %>% 
  summarise(total_rev=sum(DCRB_revenue,na.rm=T),
    total_land=sum(DCRB_lbs,na.rm=T),
    total_profit=sum(trip_profit,na.rm=T)) %>% 
  ungroup() %>%  
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  group_by(partition,is_heatwave,drvid) %>% 
  summarise(period_profit=mean(total_profit)) %>% 
  ungroup() %>% 
  group_by(partition,is_heatwave) %>% 
  summarise(mean_profit=mean(period_profit),sd_profit=sd(period_profit,na.rm=T),se_profit=sd_profit/sqrt(n())) %>% 
  ungroup() %>% 
  ggplot(aes(partition,mean_profit/1000,fill=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,mean_profit/1000,group=is_heatwave,ymin=(mean_profit-2*se_profit)/1000,ymax=(mean_profit+2*se_profit)/1000),position=position_dodge(0.9),width=0.2,col="black")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.title=element_text(family="sans",size=14,color="black"),
        legend.position = c(0.2,0.8),
        axis.text.x = element_text(angle=45,vjust=0.75))+
  labs(x="Behavioral Group",y="Profit per Vessel ($1000s)",fill="Period")
heatwave_profit_barplot

# grid with a few plots
row2 <- plot_grid(heatwave_profit_barplot, profit_per_day, labels = c('b', 'c'), label_size = 12)

ts_heatwave_profit_plot <- plot_grid(tot_profit_season_plot, row2, labels = c('a', ''), label_size = 12, ncol = 1,
                                     rel_heights = c(1.5,1))

ggsave(here::here('fishing behavior','plots','timeseries_and_heatwave_profits.png'),ts_heatwave_profit_plot,w=8,h=10)
```

### Number of Weeks with Postive Profit

```{r}
profit_by_season_week <- fishtix_plus %>%
  distinct(drvid,crab_season,Rec_ID,DCRB_revenue,DCRB_lbs,trip_profit,partition,week) %>% 
  group_by(drvid,crab_season,partition,week) %>% 
  summarise(
    total_rev=sum(DCRB_revenue,na.rm=T),
    total_land=sum(DCRB_lbs,na.rm=T),
    total_profit=sum(trip_profit,na.rm=T)) %>% 
  ungroup() %>% 
  group_by(crab_season,partition,week) %>% 
  summarise(n=n(),
            rev_tot=mean(total_rev,na.rm=T),
            rev_sd=sd(total_rev,na.rm=T),
            rev_se=rev_sd/n^0.5,
            # landings in MT
            land_tot=mean(total_land,na.rm=T)/2204.64,
            land_sd=sd(total_land,na.rm=T)/2204.64,
            land_se=land_sd/n^0.5,
            profit_tot=mean(total_profit,na.rm=T),
            profit_sd=sd(total_profit,na.rm=T),
            profit_se=profit_sd/n^0.5) %>% 
  ungroup()

profit_by_season_week_plot <- profit_by_season_week %>% 
  mutate(profit_tot=profit_tot/1e3,profit_se=profit_se/1e3) %>%
  ggplot(aes(week,profit_tot,ymin=profit_tot-2*profit_se,ymax=profit_tot+2*profit_se,
             group=factor(partition),color=factor(partition)))+
  geom_line(size=1,position=position_dodge(width=0.2))+geom_linerange(size=0.5,position=position_dodge(width=0.2))+
  labs(x="Crab Season",y="Mean Weekly Profit ($1000s)",title="",color="Group")+
  facet_wrap(~crab_season,scales='free')+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')
profit_by_season_week_plot
```


### Non-Dungeness Revenue

We want to look at patterns in revenue gained outside of the Dungeness fishery by these same vessels.

```{r}
# calculate non-DCRB revenue by week
drvid_dcrb_other <- fishtix_long %>% 
  filter(drvid %in% unique(dat_clustered$drvid)) %>%
  # add week of season
  mutate(timediff=start_of_season_oneperc%--%date) %>% 
  mutate(week=time_length(timediff,'weeks')) %>% 
  mutate(week=floor(week)) %>% 
  dplyr::select(-timediff,-start_of_season_oneperc) %>%
  ungroup() %>%
  # filter for in-season weeks
  filter(week>=0) %>% 
  distinct() %>% 
  # calculate DCRB vs. non-DCRB revenue
  mutate(is_DCRB=PACFIN_SPECIES_CODE=="DCRB") %>% 
  group_by(Rec_ID,drvid,crab_season,week) %>% 
  summarise(DCRB_revenue=sum(spp_revenue[is_DCRB]),other_revenue=sum(spp_revenue[!is_DCRB])) %>% 
  ungroup() %>% 
  mutate(DCRB_revenue=coalesce(DCRB_revenue,0),other_revenue=coalesce(other_revenue,0)) %>% 
  group_by(drvid,crab_season,week) %>% 
  summarise(tot_dcrb_revenue=sum(DCRB_revenue),tot_other_revenue=sum(other_revenue)) %>% 
  ungroup() %>% 
  mutate(prop_dcrb_revenue=tot_dcrb_revenue/(tot_dcrb_revenue+tot_other_revenue)) %>% 
  # join cluster group/partition information
  left_join(drvid_group_key) %>% 
  filter(!is.na(partition)) %>% 
  mutate(tot_revenue_allsources=tot_dcrb_revenue+tot_other_revenue)

# Graph by week (maybe area plots?)
drvid_dcrb_other %>% 
  group_by(partition,week) %>% 
  summarise(dcrb=mean(tot_dcrb_revenue,na.rm=T),other=mean(tot_other_revenue,na.rm=T)) %>% 
  ggplot(aes(week,dcrb/1e3,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week",y="Dungeness Revenue (thousand dollars)",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

drvid_dcrb_other %>% 
  group_by(partition,week) %>% 
  summarise(dcrb=mean(tot_dcrb_revenue,na.rm=T),other=mean(tot_other_revenue,na.rm=T)) %>% 
  ggplot(aes(week,other/1e3,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  coord_cartesian(ylim=c(0,NA))+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week",y="Other Revenue (thousand dollars)",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

cumulative_tot_revenue <- drvid_dcrb_other %>% 
  group_by(partition,week) %>%
  summarise(total=mean(tot_dcrb_revenue,na.rm=T)+mean(tot_other_revenue,na.rm=T)) %>% 
  ungroup() %>% group_by(partition) %>% arrange(week) %>% 
  mutate(cum_tot=cumsum(total)) %>% 
  ungroup() %>% 
  arrange(partition,desc(cum_tot))

#Other revenue by week
drvid_dcrb_other_summary <- drvid_dcrb_other %>% 
  group_by(partition,week) %>% 
  summarise(Dungeness=mean(tot_dcrb_revenue,na.rm=T),Other=mean(tot_other_revenue,na.rm=T)) %>% 
  ungroup() %>% 
  pivot_longer(Dungeness:Other,names_to="type",values_to="revenue")

ggplot()+
  geom_area(data=drvid_dcrb_other_summary, aes(week,revenue/1e3,col=type,fill=type))+
  # geom_line(data=cumulative_tot_revenue,aes(week,cum_tot/1e3),col='black')+
  coord_cartesian(xlim=c(0,NA),ylim=c(0,NA),expand=F)+
  facet_wrap(~partition)+
  scale_fill_jco()+scale_color_jco()+
  labs(x="Week of Season",y="Mean Revenue (thousand dollars)",col="Revenue Source",fill="Revenue Source")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_rect(fill=NA))



# percent outside revenue
drvid_dcrb_other_summary_perc <- drvid_dcrb_other %>% 
  mutate(perc_dcrb=tot_dcrb_revenue/tot_revenue_allsources,perc_other=tot_other_revenue/tot_revenue_allsources) %>% 
  group_by(partition,week) %>% 
  summarise(Dungeness=mean(perc_dcrb,na.rm=T),Other=mean(perc_other,na.rm=T)) %>% 
  ungroup() %>% 
  pivot_longer(Dungeness:Other,names_to="type",values_to="revenue")

ggplot()+
  geom_area(data=drvid_dcrb_other_summary_perc, aes(week,revenue*100,col=type,fill=type))+
  # geom_line(data=cumulative_tot_revenue,aes(week,cum_tot/1e3),col='black')+
  coord_cartesian(xlim=c(0,NA),ylim=c(0,NA),expand=F)+
  facet_wrap(~partition)+
  scale_fill_jco()+scale_color_jco()+
  labs(x="Week of Season",y="Percent of Weekly Revenue",col="Revenue Source",fill="Revenue Source")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_rect(fill=NA))

# in heatwave vs. non-heatwave years
perc_revenue_heatwave <- drvid_dcrb_other %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  mutate(perc_dcrb=tot_dcrb_revenue/tot_revenue_allsources,perc_other=tot_other_revenue/tot_revenue_allsources) %>% 
  group_by(partition,week,is_heatwave)%>% 
  summarise(Dungeness=mean(perc_dcrb,na.rm=T),Other=mean(perc_other,na.rm=T)) %>% 
  ungroup()

perc_revenue_heatwave_plot <- perc_revenue_heatwave %>% 
  ggplot(aes(week,Dungeness*100,col=partition,linetype=is_heatwave))+
  geom_line(size=1.5)+
  coord_cartesian(xlim=c(0,45),ylim=c(0,100),expand=F)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  labs(x="Week of Season",y="Percent of Weekly Revenue",col="Group",linetype="Period")+
  # facet_wrap(~is_heatwave,nrow=1)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_rect(fill=NA),
        legend.text=element_text(size=10))

perc_revenue_heatwave_plot
perc_revenue_heatwave_plot+geom_hline(yintercept = 80)+geom_vline(xintercept=22)

# with dotted heatwave lines
ggsave(here::here('fishing behavior','plots','dcrb_perc_revenue_by_week_heatwave.png'),perc_revenue_heatwave_plot,w=8,h=6)

```

Other revenue by season

```{r}
other_revenue_season <- drvid_dcrb_other %>% 
  group_by(crab_season,drvid,partition) %>% 
  summarise(tot_dcrb=sum(tot_dcrb_revenue),tot_other=sum(tot_other_revenue),tot_rev=sum(tot_revenue_allsources)) %>% 
  ungroup() %>%
  group_by(crab_season,partition) %>% 
  summarise(mean_dcrb=mean(tot_dcrb,na.rm=T),
            mean_other=mean(tot_other,na.rm=T),
            mean_tot=mean(tot_rev,na.rm=T)) %>% 
  ungroup() %>% 
  mutate(perc=mean_dcrb/mean_tot)

outside_revenue_by_year <- other_revenue_season %>% 
  ggplot(aes(crab_season,perc*100,group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5,position=position_dodge(width=0.2))+
  # geom_linerange(size=1,position=position_dodge(width=0.2))+
  labs(x="Crab Season",y="Percent Dungeness Revenue",title="",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_y_continuous(breaks=seq(20,100,by=10),labels=seq(20,100,by=10),limits = c(10,100))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')
outside_revenue_by_year
ggsave(here::here('fishing behavior','plots','outside_perc_revenue_by_season.png'),outside_revenue_by_year,w=8,h=6)

# Other revenue MHW vs. non-MHW years
other_rev <- drvid_dcrb_other %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>%
  group_by(drvid,crab_season,is_heatwave,partition) %>% 
  summarise(r=sum(tot_other_revenue,na.rm=T)) %>% 
  ungroup() %>% 
  group_by(crab_season,is_heatwave,partition) %>%
  # group_by(crab_season,partition) %>% 
  summarise(n=n(),
            rev_tot=mean(r,na.rm=T),
            rev_sd=sd(r,na.rm=T),
            rev_se=rev_sd/n^0.5)
other_rev_season <- other_rev %>% 
  ggplot(aes(crab_season,rev_tot/1e3,group=partition,col=partition))+
  geom_line(size=2)+
  geom_vline(xintercept=7.5,linetype=2,col="darkred")+
  geom_vline(xintercept=10.5,linetype=2,col="darkred")+
  geom_errorbar(aes(ymin=(rev_tot-2*rev_se)/1e3,ymax=(rev_tot+2*rev_se)/1e3),width=0.2)+
  labs(x="Crab Season",y="Non-Dungeness Revenue ($1000s)",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.text = element_text(size=8),
      legend.position = 'bottom',
        axis.title=element_text(size=10))
other_rev_season
ggsave(here::here('fishing behavior','plots','outside_revenue_by_season_group.png'),other_rev_season,w=8,h=6)

# bar plots of heatwave vs. non-heatwave years
# heatwave vs. non heatwave years
heatwave_non_dcrb_barplot <- drvid_dcrb_other %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>%
  group_by(drvid,crab_season,is_heatwave,partition) %>% 
  summarise(r=sum(tot_other_revenue,na.rm=T)) %>% 
  ungroup() %>% 
  group_by(is_heatwave,partition) %>%
  # group_by(crab_season,partition) %>% 
  summarise(n=n(),
            rev_tot=mean(r,na.rm=T),
            rev_sd=sd(r,na.rm=T),
            rev_se=rev_sd/n^0.5) %>% 
  ggplot(aes(partition,rev_tot/1000,fill=is_heatwave,col=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,rev_tot/1000,group=is_heatwave,ymin=(rev_tot-2*rev_se)/1000,ymax=(rev_tot+2*rev_se)/1000),position=position_dodge(0.9),width=0.2,color='black')+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.title=element_text(family="sans",size=10,color="black"),
        legend.position = c(0.2,0.8),
        axis.text.x = element_text(angle=45,vjust=0.75),)+
  labs(x="Behavioral Group",y="Non-Dungeness Revenue ($1000s)",fill="Period",col="Period")
heatwave_non_dcrb_barplot
ggsave(here::here('fishing behavior','plots','heatwave_non_dcrb_revenue.png'),heatwave_non_dcrb_barplot,w=6,h=6)

other_revenue_season_heatwave <- plot_grid(other_rev_season, heatwave_non_dcrb_barplot,labels = "auto",nrow = 2)
other_revenue_season_heatwave
ggsave(here::here('fishing behavior','plots','non_dcrb_seasons_groups_revenue.png'),other_revenue_season_heatwave,w=6,h=8)
```



```{r}
# miport Richerson et al.'s preseason abundance estimates
abun <- read_csv(here::here('fishing behavior','crab_model_results_2020422.csv'))
# 
# # need to adjust abundance by proportional VMS representation
# # vms_rep <- read_rds(here('fishing behavior','vms_proportional_landings_key.rds'))
# vms_tickets <- read_rds(here('fishing behavior','fish_tickets_with_vms.rds'))
# recid_crabseason <- fishtix %>% select(Rec_ID,crab_season) %>% distinct()
# 
# # import vms data as well, to pull out trip duration in days
# vms <- purrr::map_df(2009:2019, function(yr){
#   read_rds(paste0(here::here('data','processed','matched','filtering',yr),"matched_filtered.rds"))
# }) %>% 
#   filter(TARGET_rev=='DCRB') %>% 
#   # join crab season indicator
#   left_join(recid_crabseason,by='Rec_ID')
# trip_duration_key <- vms %>% 
#   distinct(Rec_ID,trip_dur)
# 
# 
# # group all of CA
abun %<>% mutate(agency_code=case_when(
  area %in% c('Central CA','North CA') ~ "C",
  area == "OR" ~ "O",
  area == "WA" ~ "W"
)) %>%
  mutate(lagseason=season-1) %>%
  mutate(crab_season=paste(lagseason,season,sep="-")) %>%
  group_by(agency_code,crab_season) %>%
  summarise(mean_preseason_abun=sum(mean_est_thousands_mt)) %>%
  ungroup()

# Time series of abundance
abun %>% 
  filter(crab_season %in% unique(dat$crab_season)) %>% 
  filter(crab_season != "2008-2009") %>% 
  ggplot(aes(crab_season,mean_preseason_abun,group=agency_code,col=agency_code))+
  geom_line(size=1.5)+
  labs(x="Crab Season",y="Preseason Abundance Estimate (1000 MT)")
# 
# # from the fish tickets, find weekly cumulative landings of D. crab by state
# # then estimate remaining crabs by including preseason abundance information
# weekly_landings <- fishtix %>% 
#   filter(ticket_day_of_season>=0) %>% 
#   group_by(agency_code,crab_season) %>% 
#   mutate(firstdate=min(date)) %>% 
#   mutate(timediff=firstdate%--%date) %>% 
#   mutate(week=time_length(timediff,'weeks')) %>% 
#   mutate(week=floor(week)) %>% 
#   select(-timediff) %>%
#   ungroup() %>% 
#   group_by(agency_code,crab_season,week) %>% 
#   summarise(landings_state_week=sum(DCRB_lbs,na.rm=T)) %>% 
#   ungroup() %>% 
#   group_by(agency_code,crab_season) %>% 
#   mutate(cumulative_landings=cumsum(landings_state_week),cumulative_landings_thousand_mt=cumulative_landings/1000/2204.63) %>% 
#   #join abundance data
#   left_join(abun) %>% 
#   mutate(thousand_mt_remaining=mean_preseason_abun-cumulative_landings_thousand_mt) %>% 
#   mutate(prop_remaining=thousand_mt_remaining/mean_preseason_abun) %>% 
#   filter(!is.na(prop_remaining))
# 
# # organize landings by group
# # vessel IDs and crab years in the data
# # drvid_crabseason_key <- dat_clustered %>% distinct(drvid,crab_season) %>% mutate(in_data=TRUE)
# fishtix_plus <- fishtix %>%
#   left_join(trip_duration_key) %>% 
#   ungroup() %>% 
#   left_join(vms_tickets) %>% filter(has_vms==1) %>% dplyr::select(-has_vms) %>% 
#   distinct(date,drvid,crab_season,agency_code,Rec_ID,DCRB_revenue,DCRB_lbs,trip_dur) %>%
#   # join cluster group/partition information
#   left_join(dat_rev %>% select(drvid,crab_season,partition)) %>% 
#   filter(!is.na(partition)) %>% 
#   group_by(agency_code,crab_season) %>% 
#   mutate(firstdate=min(date)) %>% 
#   mutate(timediff=firstdate%--%date) %>% 
#   mutate(week=time_length(timediff,'weeks')) %>% 
#   mutate(week=floor(week)) %>% 
#   select(-timediff) %>%
#   ungroup() %>% 
#   left_join(weekly_landings) %>% 
#   # cpue is lbs caught divided by days fished
#   mutate(cpue=DCRB_lbs/trip_dur)
# 
# # number of vessels in each group in each year
# nvessels_group<-fishtix_plus %>% group_by(agency_code,crab_season,partition) %>% summarise(n_vessels=n_distinct(drvid))
# 
# # calculate percent capture by group and week
# # show weeks of season coastwide
# capture_by_group_week <- fishtix_plus %>%
#   #calculate weekly capture
#   ungroup() %>% 
#   group_by(crab_season,agency_code,partition,week,prop_remaining,thousand_mt_remaining) %>% 
#   # total pounds captured by each group in each week
#   summarise(capture_group_week=sum(DCRB_lbs),cpue=mean(cpue,na.rm=T)) %>%
#   ungroup() %>% 
#   group_by(crab_season,agency_code,partition) %>% 
#   # cumulative (season-to-date) pounds captured by group
#   mutate(cumulative_capture_group=cumsum(capture_group_week)) %>% 
#   # cumulative capture relative to each group's eventual, season-long capture
#   mutate(cumulative_prop_capture_withingroup=cumulative_capture_group/last(cumulative_capture_group)) %>% 
#   ungroup() %>% 
#   # proportional capture by each group in that week, relative to remaining total
#   mutate(proportional_capture_group_week=capture_group_week/(thousand_mt_remaining*1000*2204.64)) %>% 
#   ungroup()
```

```{r}
# Plot weekly cumulative capture for a sample season
# capture_by_group_week %>%
#   filter(crab_season=="2013-2014") %>%
#   ggplot(aes(week,cumulative_prop_capture_withingroup,color=partition))+
#   geom_line(size=2)+
#   facet_wrap(~agency_code)+
#   labs(x="Week of Season",y="Cumulative Proportion Captured",title="Cumulative Capture by Group, 2013-2014)",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# # Plot weekly cpue by group
# capture_by_group_week %>%
#   ggplot(aes(week,capture_group_week,color=partition))+
#   geom_point(size=0.5,alpha=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="Week of Season",y="Weekly Landings",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# # Plot weekly cpue by group
# capture_by_group_week %>%
#   ggplot(aes(week,cpue,color=partition))+
#   geom_point(size=0.5,alpha=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="Week of Season",y="CPUE (lbs per day)",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
```

```{r}
#Relationship between relative proportion of crabs remaining and total catch, as well as CPUE.

# capture_by_group_week %>% 
#   ggplot(aes(prop_remaining,capture_group_week/2204.64,col=partition))+
#   geom_point(size=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="Relative Abundance",y="Weekly Landings (MT)",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# 
# capture_by_group_week %>% 
#   ggplot(aes(prop_remaining,cpue,col=partition))+
#   geom_point(size=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="Relative Abundance",y="CPUE (Landings per ticket)",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# 
# # relationship between relative abundance and proportional take by each group
# capture_by_group_week %>%
#   ggplot(aes(prop_remaining,proportional_capture_group_week,col=partition))+
#   geom_point(size=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   ylim(NA,0.15)+
#   labs(x="Relative Abundance",y="Weekly Proportion Taken",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# prop_captured_by_partition <- fishtix_plus %>% 
#   ungroup() %>% 
#   left_join(weekly_proportion_captured) %>% 
#   group_by(crab_season,agency_code,partition,week,tot_week_landings,cpue) %>% 
#   summarise(prop_captured=sum(DCRB_lbs)/tot_week_landings) %>%  
#   # add NAs for weeks when some partitions didn't fish
#   ungroup() %>% 
#   complete(crab_season,agency_code,week,partition) %>% 
#   mutate(partition=as.factor(partition)) %>% 
#   ungroup() %>% 
#   distinct()
# 
# prop_captured_by_partition %>% 
#   pivot_wider(names_from=partition,values_from=prop_captured) %>% 
#   na.exclude() %>% 
#   pivot_longer(any_of(c("1","2","3")),names_to = "partition",values_to = "prop_captured") %>% 
#   ggplot(aes(tot_week_landings,prop_captured,color=partition))+
#   geom_point(alpha=0.3,size=0.5)+
#   geom_smooth(se=F)+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="Total Weekly Landings",y="Proportion Captured by Group",color="Group")
# prop_captured_by_partition %>% 
#   pivot_wider(names_from=partition,values_from=prop_captured) %>% 
#   na.exclude() %>% 
#   pivot_longer(any_of(c("1","2","3")),names_to = "partition",values_to = "prop_captured") %>% 
#   ggplot(aes(cpue,prop_captured,color=partition))+
#   geom_point(alpha=0.3,size=1)+
#   geom_smooth(se=F)+
#   # scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="Relative Abundance (CPUE)",y="Proportion Captured by Group",color="Group")
```

## Average Spatial Footprints

Look at the spatial footprints by season for vessels in different groups. We look at the total convex hulls (spatial footprint) for vessels out of specific ports (defined as the most common landing port in a season), in different behavioral groups.

```{r}

vms_groups <- vms_all_grd %>% 
  left_join(dat_clustered,by=c('drvid','crab_season')) %>% 
  filter(!is.na(partition)) %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW"))

# define home ports as most commonly-landed port for each vessel in each year
homeports <- fishtix %>% 
  group_by(drvid,crab_season,agency_code) %>% 
  count(port_group_code) %>% 
  top_n(1,n) %>% 
  rename(homeport=port_group_code) %>%
  select(-n)

# join homeports to vms data
vms_groups %<>%
  left_join(homeports,by=c('drvid','crab_season','agency_code'))
```

How do we average home ranges across groups?
We'll take the approach of the 95th percentile of lat and lon for vessels in each home port and behavioral group.

```{r}
# library(RANN)
states_all <- coaststates %>% summarise()
find_hull <- function(df,tol=0.98){
  dsts <- RANN::nn2(df %>% as_tibble() %>% select(X_COORD,Y_COORD),k=min(100,nrow(df)))$nn.dists %>% rowMeans()
  hull<-df %>%
    mutate(meandist=dsts) %>%
    # remove top 5% spatial outliers based on distance from other points
    mutate(rnk=percent_rank(dsts)) %>%
    filter(rnk<tol) %>%
    ungroup() %>%
    summarise() %>%
    st_convex_hull()%>%
    st_difference(states_all)
  return(hull)
}
# find_average_range <- function(df){
#   latmax=quantile(df$Y_COORD,0.975)
#   latmin=quantile(df$Y_COORD,0.025)
#   lonmax=quantile(df$X_COORD,0.975)
#   lonmin=quantile(df$X_COORD,0.025)
#   out <- st_polygon(list(matrix(c(lonmin,latmin,lonmin,latmax,lonmax,latmax,lonmax,latmin),nrow=4,byrow = T))
# }
```

```{r}
# CA example footprints
sfa <- vms_groups %>%
  filter(homeport=="SFA") %>%
  # group by behavioral group and home port and calculate hulls
  # st_as_sf(coords=c("X_COORD","Y_COORD"))
  group_by(partition,is_heatwave) %>%
  nest() %>%
  mutate(cvxhull=purrr::map(data,find_hull)) %>% 
  ungroup()

footprints_sfa <- sfa %>%
  pluck("cvxhull") %>%
  bind_rows()

footprints_sfa <- sfa %>%
  select(-data,-cvxhull) %>%
  bind_cols(footprints_sfa) %>%
  st_as_sf() %>% 
  mutate(a=st_area(geometry)/1e6 %>% as.numeric())
#
# library(ggforce)
bbox <- st_bbox(footprints_sfa)
footprints_sfa %>% 
  mutate(pltgrp=factor(partition,levels=c("Roving Generalists","Roving Specialists","Local Generalists","Local Specialists"))) %>%
  ggplot()+
  geom_sf(aes(fill=pltgrp),alpha=1)+
  geom_sf(data=coaststates)+
  scale_fill_manual(values=rev(viridis_pal(begin=0.2,end=0.8)(4)))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),datum=NA)+
  labs(fill="Group")+
  facet_wrap(~is_heatwave,nrow=1)
```

```{r}
# Oregon example footprints
newport <- vms_groups %>%
  filter(homeport=="NPA") %>%
  # group by behavioral group and home port and calculate hulls
  # st_as_sf(coords=c("X_COORD","Y_COORD"))
  group_by(partition,is_heatwave) %>%
  nest() %>%
  mutate(cvxhull=purrr::map(data,find_hull))

footprints_newport <- newport %>%
  pluck("cvxhull") %>%
  bind_rows()

footprints_newport <- newport %>%
  select(-data,-cvxhull) %>%
  bind_cols(footprints_newport) %>%
  st_as_sf() %>% 
  mutate(a=st_area(geometry)/1e6 %>% as.numeric())
#
# library(ggforce)
bbox <- st_bbox(footprints_newport)
footprints_newport %>% 
  mutate(pltgrp=factor(partition,levels=c("Roving Generalists","Roving Specialists","Local Generalists","Local Specialists"))) %>%
  ggplot()+
  geom_sf(aes(fill=pltgrp),alpha=1)+
  geom_sf(data=coaststates)+
  scale_fill_manual(values=rev(viridis_pal(begin=0.2,end=0.8)(4)))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),datum=NA)+
  labs(fill="Group")+
  facet_wrap(~is_heatwave,nrow=1)
```

```{r}
# home range size over time
homeranges_ts <- dat %>% 
  select(drvid,crab_season,homerange) %>% 
  left_join(dat_clustered %>% select(drvid,crab_season,partition)) %>% 
  left_join(homeports,by=c('drvid','crab_season')) %>% 
  filter(!is.na(partition)) %>% 
  # mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  # mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  group_by(partition,crab_season) %>% 
  summarise(homerange_area=mean(homerange),sd_homerange=sd(homerange,na.rm=T),se_homerange=sd_homerange/sqrt(n()))

homeranges_by_season <- homeranges_ts %>% 
  ggplot(aes(crab_season,homerange_area,group=partition,col=partition))+
  geom_line(size=2)+
  geom_vline(xintercept=7.5,linetype=2,col="darkred")+
  geom_vline(xintercept=10.5,linetype=2,col="darkred")+
  geom_errorbar(aes(ymin=(homerange_area-2*se_homerange),ymax=(homerange_area+2*se_homerange)),width=0.1,
                position=position_dodge(width=0.1))+
  labs(x="Crab Season",y="Home Range Area (square km)",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.text = element_text(size=8),
      legend.position = 'bottom',
        axis.title=element_text(size=10))
homeranges_by_season
ggsave(here::here('fishing behavior','plots','outside_revenue_by_season_group.png'),other_rev_season,w=8,h=6)
```

```{r}
# did home ranges change in MHW?
mhw_homeranges <- dat %>% 
  select(drvid,crab_season,homerange) %>% 
  left_join(dat_clustered %>% select(drvid,crab_season,partition)) %>% 
  left_join(homeports,by=c('drvid','crab_season')) %>% 
  filter(!is.na(partition)) %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  group_by(partition,is_heatwave) %>% 
  summarise(homerange_area=mean(homerange),sd_homerange=sd(homerange,na.rm=T),se_homerange=sd_homerange/sqrt(n()))

mhw_homeranges_plot <-mhw_homeranges %>% 
  ggplot(aes(partition,homerange_area,fill=is_heatwave,col=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,homerange_area,group=is_heatwave,ymin=(homerange_area-2*se_homerange),ymax=homerange_area+2*se_homerange),position=position_dodge(0.9),width=0.2,col="black")+
  # facet_wrap(~agency_code,nrow=3,scales="free_y")+
  labs(y="Home Range Area (square km)",fill="Period",col="Period",x="Behavioral Group")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.position = c(0.2,0.8),
        axis.title=element_text(family="sans",size=10,color="black"))
        # legend.position = c(0.2,0.8),
        # axis.text.x = element_text(angle=45,vjust=0.75),)
mhw_homeranges_plot
```
```{r}
homerange_season_heatwave <- plot_grid(homeranges_by_season, mhw_homeranges_plot,labels = "auto",nrow = 2)
homerange_season_heatwave
ggsave(here::here('fishing behavior','plots','homerange_season_heatwave.png'),homerange_season_heatwave,w=6,h=8)
```


## Group Differences Plot
Simple multipanel figure showing the spatial and revenue differences (not including MHW dynamic)

```{r}
perc_revenue <- drvid_dcrb_other %>%
  mutate(perc_dcrb=tot_dcrb_revenue/tot_revenue_allsources,perc_other=tot_other_revenue/tot_revenue_allsources) %>% 
  group_by(partition,week)%>% 
  summarise(Dungeness=mean(perc_dcrb,na.rm=T),Other=mean(perc_other,na.rm=T)) %>% 
  ungroup() %>% 
  mutate(market_type=ifelse(grepl("Specialist",partition),"Specialist","Generalist") %>% as.factor())

override.linetype=c(3,1,3,1)
override.color=viridis_pal(begin=0.2,end=0.8)(4)
override.fill=viridis_pal(begin=0.2,end=0.8)(4)

perc_revenue_plot <- perc_revenue %>% 
  ggplot(aes(week,Dungeness*100,col=partition,linetype=market_type,fill=partition))+
  geom_line(size=1.5)+
  # geom_col()+
  coord_cartesian(xlim=c(0,45),ylim=c(0,100),expand=F)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  # scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Week of Season",y="Percent of Weekly Revenue from Dungeness Fishery")+
  guides(color = guide_legend("Group",override.aes = list(color=override.color, linetype = override.linetype,
                               fill=override.fill),nrow=2,byrow=T,size=2),
         linetype='none',fill='none')+
  # facet_wrap(~is_heatwave,nrow=1)+
  # guides(fill=guide_legend("Group"),color='none',linetype='none')+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_rect(fill=NA),
        legend.text=element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.title.x=element_text(size=10),
        legend.title = element_text(size=10,face='bold'),
        legend.position = 'none')
perc_revenue_plot
ggsave(here::here('fishing behavior','plots','dcrb_perc_revenue_by_week.png'),perc_revenue_plot,w=8,h=6)

# Newport average footprints, but with no MHW modifier
newport <- vms_groups %>%
  filter(homeport=="NPA") %>%
  # group by behavioral group and home port and calculate hulls
  # st_as_sf(coords=c("X_COORD","Y_COORD"))
  group_by(partition) %>%
  nest() %>%
  mutate(cvxhull=purrr::map(data,find_hull,tol=0.95)) %>% 
  ungroup()

footprints_newport <- newport %>%
  pluck("cvxhull") %>%
  bind_rows()

footprints_newport <- newport %>%
  select(-data,-cvxhull) %>%
  bind_cols(footprints_newport) %>%
  st_as_sf() %>% 
  mutate(a=st_area(geometry)/1e6 %>% as.numeric())
#
# library(ggforce)
bbox <- st_bbox(footprints_newport)
newport_total_footprints <- footprints_newport %>% 
  mutate(pltgrp=factor(partition,levels=c("Roving Generalists","Roving Specialists","Local Generalists","Local Specialists"))) %>%
  ggplot()+
  geom_sf(aes(fill=pltgrp),alpha=0.8,col=NA)+
  geom_sf(data=coaststates)+
  scale_fill_manual(values=rev(viridis_pal(begin=0.2,end=0.8)(4)))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),datum=NA)+
  guides(fill=guide_legend("Group",nrow=2,byrow=T))
  # theme(legend.position=c(0.8,0.8))
newport_total_footprints

#find newport port loc
nwprt_coords <- vms_groups %>% filter(in_port=="NEW") %>% st_coordinates() %>% 
  apply(2,mean)

newport_total_footprints2 <- newport_total_footprints+annotate(geom="point",x=nwprt_coords[1],y=nwprt_coords[2],size=2)+
  theme(legend.position = 'none')+
  theme(axis.title.x = element_blank(),axis.title.y=element_blank())+
  theme(panel.border = element_rect(color="black",fill=NA))

fill_leg <- get_legend(newport_total_footprints)
p1 <- plot_grid(perc_revenue_plot,fill_leg,ncol=1,rel_heights = c(5,1))
p2 <- plot_grid(newport_total_footprints2,NULL,p1,nrow=1,labels=c('a','','b'),rel_widths = c(1,-0.2,2))
# groups_mobility_flexibility_plot <- plot_grid(newport_total_footprints,perc_revenue_plot,fill_leg,nrow=1,rel_widths = c(1,3),rel_heights=c(1,1),labels = 'auto')
# groups_mobility_flexibility_plot

ggsave(here::here('fishing behavior','plots','groups_mobility_flexibility.png'),p2,w=7.5,h=6)
```

```{r}
# with a map plot
# SFA average footprints, but with no MHW modifier
# sfa <- vms_groups %>%
#   filter(homeport=="SFA") %>%
#   # group by behavioral group and home port and calculate hulls
#   # st_as_sf(coords=c("X_COORD","Y_COORD"))
#   group_by(partition) %>%
#   nest() %>%
#   mutate(cvxhull=purrr::map(data,find_hull,tol=0.95)) %>% 
#   ungroup()
# 
# footprints_sfa <- sfa %>%
#   pluck("cvxhull") %>%
#   bind_rows()
# 
# footprints_sfa <- sfa %>%
#   select(-data,-cvxhull) %>%
#   bind_cols(footprints_sfa) %>%
#   st_as_sf() %>% 
#   mutate(a=st_area(geometry)/1e6 %>% as.numeric())
# #
# # library(ggforce)
# bbox <- st_bbox(footprints_sfa)
# sfa_total_footprints <- footprints_sfa %>% 
#   mutate(pltgrp=factor(partition,levels=c("Roving Generalists","Roving Specialists","Local Generalists","Local Specialists"))) %>%
#   ggplot()+
#   geom_sf(aes(fill=pltgrp),alpha=0.8,col=NA)+
#   geom_sf(data=coaststates)+
#   scale_fill_manual(values=rev(viridis_pal(begin=0.2,end=0.8)(4)))+
#   coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]))+
#   labs(fill="Group")+
#   theme(legend.position=c(0.8,0.8))
# sfa_total_footprints
```

## Simple Logistic Regressions

We want to know the chance that a vessel in each group is still fishing, given a certain week of the season and given CPUE. We classify each trip in our data as positive or negative profit, then use logistic regression to calculate the probability (or risk) that a fishing trip will be negatively profitable as a function of week of season and/or CPUE, for each of the four groups.

```{r}
# prepare data for regression
logit_dat <- fishtix_plus %>% 
  select(drvid,date,crab_season,partition,week,cpue,DCRB_revenue,DCRB_lbs,thousand_mt_remaining,trip_profit) %>% 
  # fill in zeroes for weeks not fished by a given vessel
  complete(nesting(drvid,crab_season,partition),week,fill=list(DCRB_revenue=0,DCRB_lbs=0,trip_profit=0)) %>% 
  # calculate marginal revenue per vessel
  group_by(drvid,crab_season) %>% 
  arrange(date) %>% 
  mutate(cumulative_revenue_vessel=cumsum(DCRB_revenue)) %>% 
  mutate(marginal_revenue_vessel=cumulative_revenue_vessel-lag(cumulative_revenue_vessel,1)) %>% 
  ungroup()

# fill in cpue with group's average cpue for that season and week
cpue_partition_week <- fishtix_plus %>% 
  group_by(crab_season,partition,week) %>% 
  summarise(cpue_group=mean(cpue,na.rm=T)) %>% ungroup()

logit_dat <- logit_dat %>% 
  left_join(cpue_partition_week) %>% 
  mutate(cpue=coalesce(cpue,cpue_group)) %>% 
  select(-cpue_group)%>% 
  drop_na() %>% 
  mutate(log_cpue=log(cpue)) %>% 
  mutate(positive_catch=ifelse(DCRB_lbs>0,1,0),positive_profit=ifelse(trip_profit>0,1,0),
         negative_profit=ifelse(trip_profit>0,0,1))

# logit_dat <- profit_by_week %>% 
#   select(partition,week,cpue,capture_group_week,mean_profit_group) %>% 
#   mutate(positive_catch=ifelse(capture_group_week>0,1,0),positive_profit=ifelse(mean_profit_group>0,1,0))

# cpue versus profit
# logit_dat %>% 
#   ggplot(aes(cpue,positive_profit,col=partition))+
#   geom_point()+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="CPUE (lbs per day)",y="Profit Greater than Zero")
# 
# # week versus profit
# logit_dat %>% 
#   ggplot(aes(week,positive_profit,col=partition))+
#   geom_point()+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="CPUE (lbs per day)",y="Profit Greater than Zero")

# Do the logit regressions separately for each group of fishers
# vector of weeks for prediction
testdat <- tibble(week=seq(1,50,by=1),cpue=seq(1,500,length.out = 50),
                  log_cpue=seq(4,6,length.out = 50))

graph_logit <- function(dep,ind,group){
  fitdat <- logit_dat %>% filter(partition==group)
  fit <- glm(as.formula(paste(dep,ind,sep="~")),family=binomial(link="logit"),data=fitdat)
  print(summary(fit))
  print(paste("50% chance at",dep,"=",(log(1)-coef(fit)[1])/coef(fit)[2]))
  p <- predict(fit,testdat,type="response",se.fit=TRUE)
  response_title <- gsub("_"," ",dep) %>% tools::toTitleCase()
  df <- testdat %>% select(ind)%>% 
    mutate(predicted=p$fit,se=p$se.fit,partition=group) %>% 
    mutate(upper=predicted+2*se,lower=predicted-2*se)
  # p <- df %>% mutate(predicted=p) %>% 
  #   ggplot(aes_string(ind,"predicted"))+
  #   geom_point()+geom_line()+
  #   ylim(0,1)+
  #   geom_hline(yintercept=0.10,linetype=2)+
  #   labs(x=tools::toTitleCase(ind),y="Probability of Positive Profit",title=paste0("Probability of\n",response_title,", ",group))
  # print(p)
  df
}
# weeks vs. risk
p1 <- graph_logit("negative_profit","week","Local Specialists") 
p2 <- graph_logit("negative_profit","week","Local Generalists") 
p3 <- graph_logit("negative_profit","week","Roving Specialists") 
p4 <- graph_logit("negative_profit","week","Roving Generalists")

# cpue vs. risk
p1cpue <- graph_logit("negative_profit","cpue","Local Specialists") 
p2cpue <- graph_logit("negative_profit","cpue","Local Generalists") 
p3cpue <- graph_logit("negative_profit","cpue","Roving Specialists") 
p4cpue <- graph_logit("negative_profit","cpue","Roving Generalists")

#log cpue vs. risk
p1logcpue <- graph_logit("negative_profit","log_cpue","Local Specialists") 
p2logcpue <- graph_logit("negative_profit","log_cpue","Local Generalists") 
p3logcpue <- graph_logit("negative_profit","log_cpue","Roving Specialists") 
p4logcpue <- graph_logit("negative_profit","log_cpue","Roving Generalists")

# including the quant 90 day for each group?
quant99_day_by_group  <- fishtix_plus %>%
  group_by(drvid,crab_season) %>% 
  # find total and 90% revenue for each vessel in each crab season
  mutate(total_dcrb_revenue=sum(DCRB_revenue,na.rm=T),quant99_dcrb_revenue=0.99*total_dcrb_revenue) %>% 
  arrange(date) %>% 
  # cumulative sum of revenue for each vessel across the year
  mutate(dcrb_cum_revenue=cumsum(DCRB_revenue)) %>% 
  mutate(is_quant99=dcrb_cum_revenue>=quant99_dcrb_revenue) %>% 
  # find the ticket that crossed the 90% threshold and mark its date
  filter(cumany(is_quant99)) %>% 
  slice(1) %>% 
  select(drvid,crab_season,partition,week) %>% 
  rename(quant99_week=week) %>% 
  group_by(partition) %>% 
  summarise(quant99week=mean(quant99_week))

bind_rows(p1,p2,p3,p4) %>% 
  mutate(partition=factor(partition,levels=c("Local Specialists", "Local Generalists", "Roving Specialists","Roving Generalists"))) %>% 
  ggplot(aes(week,predicted,ymin=lower,ymax=upper,col=partition))+
  geom_pointrange(size=0.25)+geom_line()+
  ylim(0,1)+xlim(0,25)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  labs(x="Week",y="Risk of Negative Profit",title="",col="Group")

bind_rows(p1cpue,p2cpue,p3cpue,p4cpue) %>% 
  mutate(partition=factor(partition,levels=c("Local Specialists", "Local Generalists", "Roving Specialists","Roving Generalists"))) %>%
  ggplot(aes(cpue,predicted,ymin=lower,ymax=upper,col=partition))+
  geom_pointrange(size=0.25)+geom_line()+
  ylim(0,1)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  labs(x="CPUE (lbs per day)",y="Risk of Negative Profit",title="Risk by Group",col="Group")

bind_rows(p1logcpue,p2logcpue,p3logcpue,p4logcpue) %>% 
  mutate(partition=factor(partition,levels=c("Local Specialists", "Local Generalists", "Roving Specialists","Roving Generalists"))) %>%
  ggplot(aes(log_cpue,predicted,ymin=lower,ymax=upper,col=partition))+
  geom_pointrange(size=0.25)+geom_line()+
  ylim(0,1)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  labs(x="Log (CPUE)",y="Risk of Negative Profit",title="Risk by Group",col="Group")

# graph_logit("positive_profit","cpue","Local")
# graph_logit("positive_profit","cpue","Rover")
# graph_logit("positive_profit","cpue","Derby")
```

```{r}
# prepare data for regression
# logit_dat <- fishtix_plus %>% 
#   select(drvid,date,crab_season,partition,week,cpue,DCRB_revenue,DCRB_lbs,thousand_mt_remaining,trip_profit) %>% 
#   # fill in zeroes for weeks not fished by a given vessel
#   complete(nesting(drvid,crab_season,partition),week,fill=list(DCRB_revenue=0,DCRB_lbs=0,trip_profit=0)) %>% 
#   # calculate marginal revenue per vessel
#   group_by(drvid,crab_season) %>% 
#   arrange(date) %>% 
#   mutate(cumulative_revenue_vessel=cumsum(DCRB_revenue)) %>% 
#   mutate(marginal_revenue_vessel=cumulative_revenue_vessel-lag(cumulative_revenue_vessel,1)) %>% 
#   ungroup()
# 
# # fill in cpue with group's average cpue for that season and week
# cpue_partition_week <- fishtix_plus %>% 
#   group_by(crab_season,partition,week) %>% 
#   summarise(cpue_group=mean(cpue,na.rm=T)) %>% ungroup()
# 
# logit_dat <- logit_dat %>% 
#   left_join(cpue_partition_week) %>% 
#   mutate(cpue=coalesce(cpue,cpue_group)) %>% 
#   select(-cpue_group)%>% 
#   drop_na() %>% 
#   mutate(log_cpue=log(cpue)) %>% 
#   mutate(positive_catch=ifelse(DCRB_lbs>0,1,0),positive_profit=ifelse(trip_profit>0,1,0),
#          negative_profit=ifelse(trip_profit>0,0,1))

# logit_dat <- profit_by_week %>% 
#   select(partition,week,cpue,capture_group_week,mean_profit_group) %>% 
#   mutate(positive_catch=ifelse(capture_group_week>0,1,0),positive_profit=ifelse(mean_profit_group>0,1,0))

# cpue versus profit
# logit_dat %>% 
#   ggplot(aes(cpue,positive_profit,col=partition))+
#   geom_point()+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="CPUE (lbs per day)",y="Profit Greater than Zero")
# 
# # week versus profit
# logit_dat %>% 
#   ggplot(aes(week,positive_profit,col=partition))+
#   geom_point()+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="CPUE (lbs per day)",y="Profit Greater than Zero")

# Do the logit regressions separately for each group of fishers
# vector of weeks for prediction
# testdat <- tibble(week=seq(1,50,by=1),cpue=seq(1,500,length.out = 50),
#                   log_cpue=seq(4,6,length.out = 50))
# 
# graph_logit <- function(dep,ind,group){
#   fitdat <- logit_dat %>% filter(partition==group)
#   fit <- glm(as.formula(paste(dep,ind,sep="~")),family=binomial(link="logit"),data=fitdat)
#   print(summary(fit))
#   print(paste("50% chance at",dep,"=",(log(1)-coef(fit)[1])/coef(fit)[2]))
#   p <- predict(fit,testdat,type="response",se.fit=TRUE)
#   response_title <- gsub("_"," ",dep) %>% tools::toTitleCase()
#   df <- testdat %>% select(ind)%>% 
#     mutate(predicted=p$fit,se=p$se.fit,partition=group) %>% 
#     mutate(upper=predicted+2*se,lower=predicted-2*se)
#   # p <- df %>% mutate(predicted=p) %>% 
#   #   ggplot(aes_string(ind,"predicted"))+
#   #   geom_point()+geom_line()+
#   #   ylim(0,1)+
#   #   geom_hline(yintercept=0.10,linetype=2)+
#   #   labs(x=tools::toTitleCase(ind),y="Probability of Positive Profit",title=paste0("Probability of\n",response_title,", ",group))
#   # print(p)
#   df
# }
# # weeks vs. risk
# p1 <- graph_logit("negative_profit","week","Locals") 
# p2 <- graph_logit("negative_profit","week","Rovers")
# 
# # cpue vs. risk
# p1cpue <- graph_logit("negative_profit","cpue","Locals") 
# p2cpue <- graph_logit("negative_profit","cpue","Rovers")
# 
# #log cpue vs. risk
# p1logcpue <- graph_logit("negative_profit","log_cpue","Locals") 
# p2logcpue <- graph_logit("negative_profit","log_cpue","Rovers")
# 
# bind_rows(p1,p2) %>% 
#   mutate(partition=factor(partition,levels=c("Locals","Rovers"))) %>% 
#   ggplot(aes(week,predicted,ymin=lower,ymax=upper,col=partition))+
#   geom_pointrange(size=0.25)+geom_line()+
#   ylim(0,1)+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="Week",y="Risk of Negative Profit",title="Risk by Group",col="Group")
# 
# bind_rows(p1cpue,p2cpue) %>% 
#   mutate(partition=factor(partition,levels=c("Locals","Rovers"))) %>%
#   ggplot(aes(cpue,predicted,ymin=lower,ymax=upper,col=partition))+
#   geom_pointrange(size=0.25)+geom_line()+
#   ylim(0,1)+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="CPUE (lbs per day)",y="Risk of Negative Profit",title="Risk by Group",col="Group")
# 
# bind_rows(p1logcpue,p2logcpue) %>% 
#   mutate(partition=factor(partition,levels=c("Locals","Rovers"))) %>%
#   ggplot(aes(log_cpue,predicted,ymin=lower,ymax=upper,col=partition))+
#   geom_pointrange(size=0.25)+geom_line()+
#   ylim(0,1)+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   labs(x="Log (CPUE)",y="Risk of Negative Profit",title="Risk by Group",col="Group")

# graph_logit("positive_profit","cpue","Local")
# graph_logit("positive_profit","cpue","Rover")
# graph_logit("positive_profit","cpue","Derby")
```

## SI: Fleetwide Changes in Individual Clustering Metrics

We can look at changes in the important variables fleetwide over time.

```{r}
annual_var_means <- dat_clustered %>% 
  select(-drvid,-partition) %>% 
  pivot_longer(-crab_season,names_to = 'variable',values_to='value') %>% 
  group_by(crab_season,variable) %>% 
  summarise(mean_val=mean(value),sd_val=sd(value)) %>% 
  ungroup()

annual_var_means %>% 
  ggplot(aes(crab_season,mean_val,group=1))+
  geom_point()+
  geom_line()+
  facet_wrap(~variable)+
  geom_hline(yintercept=0)+
  labs(x="Crab Year",y="Fleet-wide Mean")+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

# annual_var_means %>% 
#   filter(variable=='port_shannon') %>% 
#   ggplot(aes(crab_season,mean_val,group=1))+
#   geom_point()+
#   geom_line()+
#   geom_hline(yintercept=0)+
#   labs(x="Crab Year",y="Fleet-wide Mean")+
#   theme(axis.text.x = element_text(angle=90,vjust=0.5),
#         legend.position = 'bottom')
```

## SI: Metrics by State
```{r,fig.height=8,fig.width=6}
# count group membership in each year
class_by_yr_state <- dat_clustered %>%
  left_join(drvid_state_key) %>% 
  group_by(crab_season,agency_code,partition) %>% 
  summarise(n_vessels=n_distinct(drvid)) %>% 
  ungroup()
num_vessels_states_plot <- class_by_yr_state %>% 
  ggplot(aes(crab_season,n_vessels,fill=factor(partition)))+
  geom_col()+
  labs(x="Crab Season",y="Number of Vessels",title="Number of Vessels by Behavior Class and Year",fill="Group")+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  facet_wrap(~agency_code,ncol=1)+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')

prop_vessels_states_plot <- class_by_yr_state %>% 
  group_by(crab_season,agency_code) %>%
  mutate(prop_group=n_vessels/sum(n_vessels)) %>% 
  ggplot(aes(crab_season,prop_group,group=factor(partition),color=factor(partition)))+
  geom_line(size=2)+
  labs(x="Crab Season",y="Proportion of Vessels",title="Proportion of Vessels in each Group by Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  facet_wrap(~agency_code,ncol=1)+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')
num_vessels_states_plot
prop_vessels_states_plot
ggsave(here::here('fishing behavior','plots','num_vessels_by_state.png'),num_vessels_states_plot,w=6,h=8)
ggsave(here::here('fishing behavior','plots','prop_vessels_by_state.png'),prop_vessels_states_plot,w=6,h=8)

```

```{r}
# Graph of the distribution of trip-level profit by behavioral group
# fishtix_plus %>% 
#   ggplot(aes(trip_profit,fill=partition))+
#   geom_density(alpha=0.5)+
#   labs(x="Profit",y='density',fill='Group',title="Per Trip Profit Distribution by Behavioral Group")+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# number of vessels in each group in each year
# nvessels_group<-fishtix_plus %>% group_by(agency_code,crab_season,partition) %>%
#   summarise(n_vessels=n_distinct(drvid))

# calculate percent capture by state, group and week
# show weeks of season coastwide
capture_by_group_week <- fishtix_plus %>%
  #calculate weekly capture
  ungroup() %>% 
  group_by(crab_season,agency_code,partition,week) %>%
  # average pounds and profits captured by vessels in each group in each week
  summarise(capture_group_week=mean(DCRB_lbs,na.rm=T),
            cpue=mean(cpue,na.rm=T),
            mean_revenue_group=mean(DCRB_revenue),
            mean_cost_group=mean(trip_cost),
            mean_profit_group=mean(trip_profit,na.rm=T),
            prop_remaining=first(prop_remaining,order_by = date),
            thousand_mt_remaining=first(thousand_mt_remaining,order_by=date)) %>%
  ungroup() %>% 
  group_by(crab_season,agency_code,partition) %>% 
  arrange(crab_season,agency_code,partition,week) %>% 
  # cumulative (season-to-date) pounds captured by group
  mutate(cumulative_capture_group=cumsum(capture_group_week)) %>% 
  # cumulative capture relative to each group's eventual, season-long capture
  mutate(cumulative_prop_capture_withingroup=cumulative_capture_group/last(cumulative_capture_group)) %>% 
  # cumulative profit by group across the course of the season
  mutate(cumulative_mean_profit=cumsum(mean_profit_group),
         marginal_profit=cumulative_mean_profit-lag(cumulative_mean_profit,1)) %>%
  # ratio of trip revenue to trip cost across group
  mutate(cost_ratio=mean_revenue_group/mean_cost_group) %>% 
  ungroup() %>% 
  # proportional capture by each group in that week, relative to remaining total for that state
  mutate(proportional_capture_group_week=capture_group_week/(thousand_mt_remaining*1000*2204.64)) %>% 
  ungroup() %>% 
  distinct()
```
```{r}
# Plot weekly landings by group and state
landings_group_week <- capture_by_group_week %>%
  ggplot(aes(week,capture_group_week,color=partition))+
  # geom_point(size=0.5,alpha=0.5)+
  # geom_smooth(se=F)+
  geom_line(size=0.5)+
  facet_grid(agency_code~crab_season,scales="free_y")+
  labs(x="Week of Season",y="Weekly Landings per Vessel",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
landings_group_week
ggsave(here('fishing behavior','landings_by_season_group.png'),landings_group_week,h=8,w=12)

# Plot weekly cpue by group and state
cpue_group_week <- capture_by_group_week %>%
  ggplot(aes(week,cpue,color=partition))+
  # geom_point(size=0.5,alpha=0.5)+
  # geom_smooth(se=F)+
  geom_line(size=0.5)+
  facet_grid(agency_code~crab_season,scales="free_y")+
  labs(x="Week of Season",y="CPUE (lbs per day)",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
cpue_group_week
ggsave(here('fishing behavior','cpue_by_season_group.png'),cpue_group_week,h=8,w=12)

# Plot weekly cumulative capture for a sample season
prop_capture_group_week <- capture_by_group_week %>%
  ggplot(aes(week,cumulative_prop_capture_withingroup,color=partition))+
  geom_line(size=0.5)+
  facet_grid(agency_code~crab_season,scales="free_y")+
  labs(x="Week of Season",y="Cumulative Proportion Captured\nper Vessel",title="Cumulative Capture by Group, 2013-2014)",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
prop_capture_group_week
ggsave(here('fishing behavior','cumulative_prop_capture_season_group.png'),prop_capture_group_week,h=8,w=12)

# cumulative profit per vessel
cumulative_profit_week <- capture_by_group_week %>% 
  ggplot(aes(week,cumulative_mean_profit,col=partition))+
  geom_line(size=0.5)+
  facet_grid(agency_code~crab_season,scales="free_y")+
  labs(x="Week of Season",y="Cumulative Profit\nper Vessel",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
cumulative_profit_week
ggsave(here('fishing behavior','cumulative_profit_by_season_group.png'),cumulative_profit_week,h=8,w=12)

# marginal profit per vessel
marginal_profit_week <- capture_by_group_week %>% 
  ggplot(aes(week,marginal_profit,col=partition))+
  geom_line(size=0.5)+
  facet_grid(agency_code~crab_season,scales="free_y")+
  labs(x="Week of Season",y="Marginal Profit\nper Vessel",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
marginal_profit_week
ggsave(here('fishing behavior','marginal_profit_by_season_group.png'),marginal_profit_week,h=8,w=12)

```
```{r}
# # time series of profit by week
# profit_by_week %>%
#   ggplot(aes(week,mean_profit_group,color=partition))+
#   geom_point(size=0.5,alpha=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="Week of Season",y="Mean Weekly Profit",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# 
# # profit versus proportion resource remaining
# profit_by_week %>% 
#   ggplot(aes(prop_remaining,mean_profit_group,col=partition))+
#   geom_point(size=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="Relative Abundance",y="Mean Weekly Profit",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# 
# # CPUE versus profit
# profit_by_week %>% 
#   ggplot(aes(cpue,mean_profit_group,col=partition))+
#   geom_point(size=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="CPUE (lbs per day)",y="Mean Weekly Profit",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# 
# # cost ratio versus proportion resource remaining
# profit_by_week %>% 
#   ggplot(aes(prop_remaining,cost_ratio,col=partition))+
#   geom_point(size=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="Relative Abundance",y="Mean Weekly Cost Ratio",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# CPUE versus cost ratio
# profit_by_week %>% 
#   ggplot(aes(cpue,cost_ratio,col=partition))+
#   geom_point(size=0.5)+
#   geom_smooth(se=F)+
#   facet_wrap(~agency_code)+
#   labs(x="CPUE (Landings per Trip)",y="Mean Weekly Cost Ratio",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# mean profit by week of season
capture_by_week_allyrs <- capture_by_group_week %>% 
  group_by(agency_code,partition,week) %>% 
  summarise(mean_profit_week_allyrs=mean(mean_profit_group),
            sd_profit_week_allyrs=sd(mean_profit_group),
            marginal_profit_week_allyrs=mean(marginal_profit),
            mean_costratio_week_allyrs=mean(cost_ratio))

capture_by_week_allyrs %>% 
  ggplot(aes(week,mean_profit_week_allyrs,col=partition))+
  geom_point()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  geom_line()+
  facet_wrap(~agency_code)+
  geom_hline(yintercept=1)+
  labs(x="Week of Season",y="Mean Weekly Profit",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

capture_by_week_allyrs %>% 
  ggplot(aes(week,marginal_profit_week_allyrs,col=partition))+
  geom_point()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  geom_line()+
  geom_hline(yintercept=0)+
  facet_wrap(~agency_code)+
  labs(x="Week of Season",y="Mean Marginal Profit",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# mean cost/revenue ratio
capture_by_week_allyrs %>% 
  ggplot(aes(week,mean_costratio_week_allyrs,col=partition))+
  geom_point()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  geom_line()+
  facet_wrap(~agency_code)+
  geom_hline(yintercept=1)+
  labs(x="Week of Season",y="Revenue/Cost Ratio",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
```

```{r}

## Tilman competition

# What if we take the Tilman-style R* view of these strategies? Under our adaptation of the theory, we would expect the best fishing "strategy" to be that which can efficiently exploit the resource to the lowest level, while maintaining a positive growth rate. In our analogy, growth rate will be marginal revenue, loss rate will be average trip cost, and resource level will be relative crab abundance.

# # overall mean trip cost by group
# mean_trip_cost <- fishtix_plus %>% 
#   group_by(partition) %>% 
#   summarise(mean_cost=mean(trip_cost,na.rm=T)) %>% 
#   ungroup()
# 
# rstar_dat <- logit_dat %>% mutate(cpue_norm=(cpue/max(cpue,na.rm=T)))
# 
# rstar_pl <- rstar_dat %>% 
#   ggplot(aes(cpue_norm,marginal_revenue_vessel,col=partition,fill=partition))+
#   geom_point(size=0.5)+
#   geom_smooth()+
#   labs(x="Normalized CPUE",y="Marginal Revenue",col="Group",fill="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# rstar_pl
# 
#   
# # fit an asymptotic-type curve for each partition relating revenue
# fit_asymp <- function(group){
#   fitdat <- rstar_dat %>% filter(partition==group)
#   fit <- drc::drm(marginal_revenue_vessel ~ cpue_norm, fct = drc::AR.3(),data=fitdat)
#   print(summary(fit))
#   
#   testdat <- tibble(cpue_norm=seq(0,max(rstar_dat$cpue_norm),length.out = 100))
#   p <- predict(fit,newdat=as.data.frame(testdat),se.fit=TRUE)
#   
#   df <- testdat %>% mutate(predicted=p[,1],se=p[,2],upper=predicted+2*se,lower=predicted-2*se,partition=group)
#   # p <- df %>% mutate(predicted=p) %>% 
#   #   ggplot(aes_string(ind,"predicted"))+
#   #   geom_point()+geom_line()+
#   #   ylim(0,1)+
#   #   geom_hline(yintercept=0.10,linetype=2)+
#   #   labs(x=tools::toTitleCase(ind),y="Probability of Positive Profit",title=paste0("Probability of\n",response_title,", ",group))
#   # print(p)
#   df
# }
# curve1 <- fit_asymp("Local")
# curve2 <- fit_asymp("Rover")
# curve3 <- fit_asymp("Derby")
# 
# rstar_curves <- bind_rows(curve1,curve2,curve3)%>% 
#   mutate(partition=factor(partition,levels=c("Local","Rover","Derby")))
# 
# rstar_pl <- ggplot()+
#   geom_line(data=rstar_curves,aes(cpue_norm,predicted,col=partition),size=1)+
#   geom_linerange(data=rstar_curves,aes(cpue_norm,predicted,ymax=upper,ymin=lower,col=partition),size=0.25)+
#   geom_hline(data=mean_trip_cost,aes(yintercept=mean_cost,col=partition),linetype=2,size=1)+
#   labs(x="Relative Crab Abundance",y="Revenue",col="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))
# rstar_pl
# 
# rstar_pl+
#   coord_cartesian(xlim=c(0,0.1))
```