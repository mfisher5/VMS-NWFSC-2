---
title: "Filter Matched Data"
author: "Owen Liu"
date: "12/12/2019"
output: html_document
---

## Purpose

This final step cleans up the matched fish ticket/VMS records spatially through filtering. The script:

*Removes outlier trips where the Port of Landing is > 50km from the last VMS point of the associated trip
*Recalculates average speed for each trip and filters out segments with unrealistically large speed. This speed cutoff is set by default at 20 m/s, but can be altered in this script.
*Flags VMS points that are within a 3 kilometer buffer of a port

## Setup and Data Import

```{r, echo=FALSE}
library(tidyverse)
library(magrittr)
library(here)
library(sf)
library(geosphere)
library(lubridate)
library(rgdal)
library(rgeos)
library(rnaturalearth)

# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=12,color="black"),
        legend.text = element_text(size=14),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=8,color="black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
theme_set(plot_theme)

rm(list=setdiff(ls(),c('process_year','alltime')))

# process year (if running this script only, not as part of the pipeline)
process_year=2012
```

### Read in the data

First, the full vms data set for `r process_year`.

```{r data}
# Owen note: using read_csv here to ensure the data types of different variables are read in correctly
vms <- read_rds(here::here('data','processed','matched',paste0(process_year,'matched_vms_only.rds')))
```


## Remove trips where Port of Landing > 50km from last VMS data point

Latitude/longitude of ports. Coordinates were provided by Blake Feist.

```{r}
portlist_coords <- read_csv(here::here('data','raw','port_coords_fromBlake_edited.csv'),col_types='cddd') %>% 
  select(port_code,Lon,Lat) %>% 
  set_names(c('port_code','portlon','portlat'))
```

Filter VMS data to include only the last VMS data point for each trip

```{r}
fishtix_lastVMS <- vms %>%
  group_by(Rec_ID) %>%
  top_n(1, wt=westcoastdate) %>%
  ungroup()
```

Add port locations to last VMS points

```{r port_coords}
fishtix_lastVMS <- left_join(fishtix_lastVMS, portlist_coords, by=c("pacfin_port_code" = "port_code"))
```

How many port lat/lon coordinates are NA? For `r process_year`, `r round(sum(is.na(fishtix_lastVMS$portlat)) / length(fishtix_lastVMS$portlat)*100,2)` percent of trips are missing coordinates. We remove these observations.

Note: why is this happening?

```{r}
fishtix_lastVMS %<>% filter(!is.na(portlat),!is.na(portlon))
```


### Find distance between end VMS and port

Calculate distance with geosphere

```{r calc_dist}
# lastVMS_sf <- fishtix_lastVMS %>%  st_as_sf(coords=c('LONGITUDE','LATITUDE'))
# ports_sf <- fishtix_lastVMS %>% st_as_sf(coords=c('portlon','portlat'))

# port_dists <- st_distance(lastVMS_sf,ports_sf,by_element=TRUE)

port_dists <- geosphere::distHaversine(p1=cbind(fishtix_lastVMS$portlon, fishtix_lastVMS$portlat),
                                    p2=cbind(fishtix_lastVMS$LONGITUDE, fishtix_lastVMS$LATITUDE))
```

Add the distances as another column

```{r}
fishtix_lastVMS %<>%
  mutate(port_to_VMS = port_dists / 1000)
```

### Sort Trips to Keep or Remove

```{r filter_retain}
trips_keep_remove_portdist <- fishtix_lastVMS %>% 
  mutate(keep_remove_portdist= ifelse(port_to_VMS <= 50, 'keep','remove'))
trips_to_keep <-trips_keep_remove_portdist %>% 
  filter(keep_remove_portdist=='keep')
trips_to_remove <- trips_keep_remove_portdist %>% 
  filter(keep_remove_portdist=='remove')
```

For `r process_year`, if we filter using this criterion, we retain `r length(unique(trips_to_keep$Rec_ID))` trips, and remove `r length(unique(trips_to_remove$Rec_ID))` trips, which is about `r round(length(unique(trips_to_remove$Rec_ID))/length(unique(fishtix_lastVMS$Rec_ID))*100,2)` percent of all trips.

```{r filter_rm}
dcrb_trips_to_keep <- trips_to_keep %>% 
  filter(TARGET_rev=="DCRB")
dcrb_trips_to_remove <- trips_to_remove %>% 
  filter(TARGET_rev=="DCRB")
```

With respect to Dungeness crab trips, for `r process_year`, we retain `r length(unique(dcrb_trips_to_keep$Rec_ID))` trips, and remove `r length(unique(dcrb_trips_to_remove$Rec_ID))` trips, which is about `r round(length(unique(dcrb_trips_to_remove$Rec_ID))/length(unique(fishtix_lastVMS$Rec_ID))*100,2)` percent of all Dungeness trips.

```{r}
retained_trips_plot <- trips_to_keep %>% 
  select(Rec_ID, pacfin_port_code) %>% 
  distinct() %>%
  ggplot(aes(x=pacfin_port_code)) +
  geom_bar() +
  labs(x="Port",y="Number of Unique Trips",title="Retained Trips Ending <= 50km from a Port")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90,vjust=0.5))
retained_trips_plot
```
```{r}
trips_removed_plot <- trips_to_remove %>% 
  select(Rec_ID, pacfin_port_code) %>% 
  distinct() %>%
  ggplot(aes(x=pacfin_port_code)) +
  geom_bar() +
  labs(x="Port",y="Number of Trips Removed",title="Removed Trips Ending > 50km from a Port")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90,vjust=0.5))
trips_removed_plot
```

Sort the VMS and fish ticket data by the output of this filtering exercise.

```{r}
# keeps <- trips_to_keep %>%
#   select(Rec_ID,keep_remove_portdist) %>% 
#   distinct()
# removes <- trips_to_remove %>% 
#   select(Rec_ID,keep_remove_portdist) %>% 
#   distinct()
# keeps_removes <- bind_rows(keeps,removes)
# 
# vms_keeps <- vms %>% 
#   left_join(keeps_removes,by='Rec_ID') %>% 
#   filter(keep_remove_portdist=='keep')
# 
# vms_removes <- vms %>% 
#   left_join(keeps_removes,by='Rec_ID') %>% 
#   filter(keep_remove_portdist=='remove')

vms_wfilters <- vms %<>% left_join(trips_keep_remove_portdist %>%  select(Rec_ID,keep_remove_portdist),by='Rec_ID')
```

## Calculate Speeds

We calculate speeds by lagging observations (grouped by vessel) by 1 time step, then calculating distance and dividing by time.

```{r}
vms_speeds <- vms_wfilters %>% 
  ungroup() %>% 
  group_by(drvid) %>% 
  # lag latitude and longitude by 1 time step
  mutate(laglon=lag(LONGITUDE,1,order_by=westcoastdate),laglat=lag(LATITUDE,1,order_by=westcoastdate)) %>% 
  # lag time by 1 time step
  mutate(lagdate=lag(westcoastdate,1,order_by=westcoastdate)) %>% 
  # calculate duration since last ping, in seconds
  mutate(segment_dur=as.duration(lagdate %--% westcoastdate)/dseconds()) %>% 
  ungroup()

# Calculate distance (Note: geosphere seems much faster than doing this with sf())
segment_dists <- geosphere::distHaversine(p1=cbind(vms_speeds$LONGITUDE, vms_speeds$LATITUDE),
                                    p2=cbind(vms_speeds$laglon, vms_speeds$laglat))

vms_speeds %<>% 
  mutate(segment_dist=segment_dists)

# Speed is just segment distance (default in meters) divided by segment duration (in seconds)
vms_speeds %<>%
  mutate(avg_speed_recalc=segment_dist/segment_dur) %>% 
  # some calculations will be NaN or Inf because of 0 distance or time. Fix these as zeroes
  mutate(avg_speed_recalc=ifelse(segment_dist==0|segment_dur==0,0,avg_speed_recalc))
```

### Compare Reported and Calculated Speeds

Correlation between new and old calculations is Subsample randomly for consistency.

```{r}
set.seed(0401)
vms_subsample <- vms_speeds %>% 
  sample_n(100000) %>% 
  mutate(speed_diff=avg_speed_recalc-AVG_SPEED)
vms_subsample %>% 
  ggplot(aes(AVG_SPEED,avg_speed_recalc))+
  geom_point()+
  geom_smooth(method='lm')+
  coord_equal(xlim=c(0,500),ylim=c(0,500))+
  labs(x='Original Average Speed',y="Average Speed Recalculated")
```

Zoom in a bit more

```{r}
vms_subsample %>% 
  ggplot(aes(AVG_SPEED,avg_speed_recalc))+
  geom_point()+
  geom_smooth(method='lm')+
  coord_equal(xlim=c(0,50),ylim=c(0,50))+
  labs(x='Original Average Speed',y="Average Speed Recalculated")
```

Distribution of differences

```{r}
vms_subsample %>% 
  mutate(speed_diff=avg_speed_recalc-AVG_SPEED) %>% 
  ggplot(aes(speed_diff))+
  geom_density(fill='seagreen',col=NA)+
  geom_vline(xintercept=0,linetype=2)+
  labs(x="Calculated-Reported Speed (m/s)",y='kernel density')+
  xlim(-5,5)
```

`r round(sum(vms_subsample$speed_diff<=1 & vms_subsample$speed_diff>=-1,na.rm=T)/nrow(vms_subsample)*100,2)` percent of our re-calculations are within 1 m/s of the reported average speeds. Beyond that, it seems that the reported average speeds tend on average to be greater than our calculated speeds.

### Sort Trips to Keep or Remove

```{r}
max_speed <- 20
```


This time, indicate whether our recalculated speed is greater than `r max_speed` m/s. Add these indicators to the master, matched dataset.

```{r}
vms_wfilters <- vms_speeds %>% mutate(keep_remove_speed=ifelse(avg_speed_recalc>max_speed,'remove','keep'))
```

If we filter using the speed criterion, we would remove `r round(sum(vms_wfilters$keep_remove_speed=='remove',na.rm=T)/nrow(vms_wfilters)*100,2)` percent of all observations for `r process_year`.

## Indicate Pings on Land

Add another `keep_remove` indicator showing whether a given VMS ping may be on land.

```{r}
vms_wfilters %<>% mutate(keep_remove_bathy=ifelse(NGDC_M<=0,"keep","remove"))
```

If we filter using the on-land criterion, we would remove `r round(sum(vms_wfilters$keep_remove_bathy=='remove',na.rm=T)/nrow(vms_wfilters)*100,2)` percent of all observations for `r process_year`.

## Remove In-Port VMS Records

In this piece, we flag all "in-port" VMS records, using a buffer zone of 1.5km or 3km, depending on the port. In-port records that also have an average speed of < 1 m/s are marked for removal. Only those records marked for removal before and after the fishing trip were actually removed from the filtered output data.

```{r}
## width of buffer circle (in meters). applies to all ports but those that require smaller buffers
r = 3000

## port codes for any ports that require reduced buffer sizes. Default is only COS
ports_lowbuffer <- c("COS")

## width of buffer circle (in meters) for reduced buffer size
r2 = 1500

## cutoff value for speed (m/s) -- 1m/s ~ 2 knots
speed_cutoff <- 1

## do you want to filter out data points that are potentially on shore (NGDC > 0m)?
bathy_filter=FALSE
```

Using port coordinates from above, indicated whether they are in the "smaller buffer" category

```{r}
portlist_coords %<>%
  mutate(small_buffer=ifelse(port_code %in% ports_lowbuffer,1,0) %>% as.logical())
```

### Buffer Ports

```{r}
# convert ports to sf() object and buffer
ports_sf <- portlist_coords %>% 
  st_as_sf(coords=c('portlon','portlat'),crs=4326) %>% 
  #project to UTM zone 10
  st_transform(crs = "+proj=utm +north +zone=10 +ellps=WGS84")

# buffer large ports
large_ports_buffer <- ports_sf %>%
  filter(!small_buffer) %>% 
  st_buffer(r)

# buffer small ports
small_ports_buffer <- ports_sf %>% 
  filter(small_buffer) %>% 
  st_buffer(r2)

ports_buffer <- rbind(large_ports_buffer,small_ports_buffer)
```

### Plot Port Buffers

```{r, message=F,warning=FALSE}
# import a background/land layer from rnaturalearth package
coaststates <- ne_states(country='United States of America',returnclass = 'sf') %>% 
  filter(name %in% c('California','Oregon','Washington')) %>% 
  
  # make sure CRS is the same as the port layer
  st_transform(st_crs(ports_buffer))

# sections of coastline
cutcoast <- list(c(-124, -125, 47.5, 48.5), #upper WA
                 c(-123.5, -124.5, 46.7, 47.7), #lower WA p1
                 c(-123.5, -124.5, 45.7, 46.7), #lower WA / upper OR [WLB, NHL]
                 c(-123.5, -124.5,45.6, 44.6), # OR [TLL, NEW]
                 c(-123.5, -124.5,44.5, 43.5), # OR [WLD, WIN]
                 c(-124, -125, 43.5, 42.25), # OR [COS,GLD]
                 c(-123.75, -124.75, 42.2, 40.5), #OR to CA [BRK, FLN]
                 c(-123, -124, 40, 38.5), # CA [BRG, ARE]
                 c(-122, -123.5, 38.5, 36.6), # CA [BDG, CRZ]
                 c(-120.5, -122, 37, 35), # CA [MOS, AVL]
                 c(-117, -120, 35, 32.5)) # CA[SB, OCN]

# Plot
buffer_plots <- purrr::map(1:length(cutcoast), function(i){
  seg=cutcoast[[i]]
  bx=c(xmin=seg[2],xmax=seg[1],ymin=seg[3],ymax=seg[4])%>% st_bbox(crs=st_crs(4326))
  bbox <- bx %>% st_as_sfc() %>% st_transform(st_crs(ports_buffer)) %>% st_bbox()
  plotout <- ggplot()+
    geom_sf(data=coaststates,fill='gray50')+
    geom_sf(data=ports_buffer,aes(fill=small_buffer),alpha=0.5)+
    geom_sf_text(data=ports_buffer,aes(label=port_code),size=3,hjust=1)+
    xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
    labs(x='',y='',title="Port Buffers",fill="Small Buffer")+
    theme(axis.text.x = element_text(angle=90))
  print(plotout)
})
```


### Do Spatial Overlay

Calculate whether points overlap buffers

```{r}
vms_sf <- vms_wfilters %>% 
  select(VMS_RECNO,X_COORD,Y_COORD) %>%
  st_as_sf(coords=c("X_COORD","Y_COORD"),crs = "+proj=utm +north +zone=10 +ellps=WGS84")

# do the overlay, which results in a list of buffer indices into which a VMS point falls
#https://github.com/r-spatial/sf/wiki/migrating
port_names <- ports_buffer$port_code
# vms_ports_over_list <- st_intersects(vms_sf,ports_buffer)
vms_ports_over <- sapply(st_intersects(vms_sf,ports_buffer), function(z) if (length(z)==0) NA_integer_ else z[1])

# Overlay returned integers. Pull out the appropriate port names from the list of ports
vms_ports_over_names <- port_names[vms_ports_over]
```

Add the port names back to the master dataset for each VMS point.

```{r}
vms_wfilters %<>%
  mutate(in_port=vms_ports_over_names)

## Plot a sample of VMS points
vms_sf %<>%
  mutate(in_port=vms_ports_over_names)

test_port<-vms_sf %>% 
  filter(in_port=='BDG') %>% 
  #subsample for quicker plotting
  sample_n(.,min(nrow(.),1000))
testbbox <- st_bbox(ports_buffer %>% filter(port_code=='BDG'))
# testbbox <- st_bbox(test_port)
ggplot()+
  geom_sf(data=coaststates,fill='gray50')+
  geom_sf(data=ports_buffer,fill='seagreen',alpha=0.5)+
  geom_sf(data=test_port,size=1)+
  xlim(testbbox[1],testbbox[3])+ylim(testbbox[2],testbbox[4])+
  labs(x='',y='',title="Points within Bodega Buffer")+
  theme(axis.text.x = element_text(angle=90))
```



What is the avg speed when vessels are marked as in port? 
```{r}
inport_dat <- mutate(vms, in_port_binary = ifelse(is.na(in_port), 0,1))
ggplot(data=filter(inport_dat, avg_speed_ms < 50), aes(x=avg_speed_ms)) +
  geom_histogram() +
  facet_wrap(~in_port_binary) +
  xlab("Average Speed (Calculated)") +
  ylab("Number of Records")
```
<br>

Mark "remove" if the record is in port *and* the avg speed is < 1 m/s.
```{r remove_flag}
vms <- mutate(vms, to_rm = ifelse(!is.na(in_port) & avg_speed_ms < speed_cutoff, "remove", "retain"))
cat("Proportion of VMS records removed: ", sum(vms$to_rm == "remove") / dim(vms)[1], "\n")
cat("There were ", dim(vms)[1]/sum(vms$to_rm == "retain"), "x VMS records in the unfiltered data than will be retained.\n")
cat("Proportion of VMS records marked in-port removed: ", sum(vms$to_rm == "remove") / sum(!is.na(vms$in_port)))
```
<br>


### Filtering data

I want to remove all but the last in-port record before the fishing trip, and the first in-port record after the fishing trip. For now, I am leaving in all mid-trip "remove" points. 

To do this, I first need to get the date / time of the first and last "retain" record for each trip. Then, I can split each trip as pre-first "retain" and post-last "retain". Finally, sort by date/timestamp and take the top n=1 VMS record per trip. Add these data back into the output data frame.

Get the `westcoastdate` of the first/last record to retain
```{r}
vms$westcoastdate <- ymd_hms(vms$westcoastdate)
first_last_retain <- vms %>%
  filter(to_rm == "retain") %>%
  group_by(Rec_ID) %>%
  summarise(first_retain = min(westcoastdate, na.rm=TRUE), last_retain = max(westcoastdate, na.rm=TRUE))
vms_ext <- left_join(vms, first_last_retain, by="Rec_ID")
```
<br>

Split "remove" records into pre-trip and post-trip data
```{r split_remove}
vms_ext$westcoastdate <- ymd_hms(vms_ext$westcoastdate)
pretrip_inport <- vms_ext %>%
  filter(westcoastdate < first_retain) %>%
  filter(to_rm == "remove")
posttrip_inport <- vms_ext %>%
  filter(westcoastdate > last_retain) %>%
  filter(to_rm == "remove")
```
<br>

Sort pre-trip by desc(westcoastdate), grab the top record per trip. Sort post-trip by westcoastdate, grab the top record per trip.
```{r}
pretrip_lastvms <- pretrip_inport %>%
  group_by(Rec_ID) %>%
  top_n(n=1, wt=westcoastdate)
posttrip_firstvms <- posttrip_inport %>%
  group_by(Rec_ID) %>%
  top_n(n=1, wt=desc(westcoastdate))
head(pretrip_lastvms %>% dplyr::select(Rec_ID, westcoastdate, to_rm, first_retain))
head(posttrip_firstvms %>% dplyr::select(Rec_ID, westcoastdate, to_rm, last_retain))
```
<br>

Remove records pre-first_retain and post-last_retain
```{r filter}
vms_ext_filtered <- vms_ext %>%
  filter(westcoastdate > first_retain & westcoastdate < last_retain)
vms_ext_removed <- vms_ext %>%
  filter(westcoastdate < first_retain | westcoastdate > last_retain)
```
<br>

Integrate last pre-trip and first post-trip back into the data set. 
```{r add_one_inport}
colnames(vms_ext_filtered) == colnames(pretrip_lastvms)
colnames(vms_ext_filtered) == colnames(posttrip_firstvms)

vms_out_ext <- vms_ext_filtered %>%
  bind_rows(pretrip_lastvms) %>%
  bind_rows(posttrip_firstvms)
vms_out_ext$westcoastdate <- ymd_hms(vms_out_ext$westcoastdate)
vms_out_ext <- vms_out_ext %>%
  arrange(Rec_ID, westcoastdate)
vms_out <- dplyr::select(vms_out_ext, c(-first_retain, -last_retain))
```
<br>

Write out filtered data set, with a separate file for each year
```{r write_out}
if(bathy_filter == TRUE){
  for(y in years){
    tmp_output <- filter(vms_out, year(westcoastdate) == y)
    tmp_output$westcoastdate <- as.character(tmp_output$westcoastdate)
    write.csv(x=tmp_output, paste0(filterVMS_dir, "VMS_Outputs_wTARGET_10d_lookback_", y, "_speed_cleaned_bathy_offshore.csv"), row.names=FALSE)
    tmp_filteredout <- filter(vms_ext_removed, year(westcoastdate) == y)
    tmp_filteredout$westcoastdate <- as.character(tmp_filteredout$westcoastdate)
    write.csv(x=tmp_filteredout, paste0(filterVMS_dir, "VMS_Outputs_wTARGET_10d_lookback_", y, "_speed_cleaned_bathy_inport_removed.csv"), row.names=FALSE)
  }
} else{
  for(y in years){
    tmp_output <- filter(vms_out, year(westcoastdate) == y)
    tmp_output$westcoastdate <- as.character(tmp_output$westcoastdate)
    write.csv(x=tmp_output, paste0(filterVMS_dir, "VMS_Outputs_wTARGET_10d_lookback_", y, "_speed_cleaned_offshore.csv"), row.names=FALSE)
    tmp_filteredout <- filter(vms_ext_removed, year(westcoastdate) == y)
    tmp_filteredout$westcoastdate <- as.character(tmp_filteredout$westcoastdate)
    write.csv(x=tmp_filteredout, paste0(filterVMS_dir, "VMS_Outputs_wTARGET_10d_lookback_", y, "_speed_cleaned_inport_removed.csv"), row.names=FALSE)
  }
}
```
<br>
<br>



_________________________________
### View flagged points

#### In port, removed
```{r plot_remove}
rm_vms <- filter(vms, to_rm=="remove")
if(plot.me){
  for(i in seq(1,11)){
    myplot<- ggplot() +
      geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
      geom_polygon(data=buffer_polygons_LL, aes(x = long, y = lat, group = group), col="blue") +
      geom_point(data=ports_df, aes(x=Lon, y=Lat), col="red", size=2) +
      geom_point(data=rm_vms, aes(x=LONGITUDE, y=LATITUDE, col=avg_speed_ms), alpha=0.5) +
      coord_cartesian(xlim=c(cutcoast[[i]][1], cutcoast[[i]][2]), ylim=c(cutcoast[[i]][3], cutcoast[[i]][4])) +
      geom_text(data=ports_df, aes(x=Lon, y=Lat, label=port_code),size=4, nudge_x=0.07) +
      ggtitle("Removed VMS Records")
    print(myplot)
  }
} else{
  for(i in seq(from=1,to=9, by=3)){
    myplot<- ggplot() +
      geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
      geom_polygon(data=buffer_polygons_LL, aes(x = long, y = lat, group = group), col="blue") +
      geom_point(data=ports_df, aes(x=Lon, y=Lat), col="red", size=2) +
      geom_point(data=rm_vms, aes(x=LONGITUDE, y=LATITUDE, col=avg_speed_ms), alpha=0.5) +
      coord_cartesian(xlim=c(cutcoast[[i]][1], cutcoast[[i]][2]), ylim=c(cutcoast[[i]][3], cutcoast[[i]][4])) +
      geom_text(data=ports_df, aes(x=Lon, y=Lat, label=port_code),size=4, nudge_x=0.07) +
      ggtitle("Removed VMS Records")
    print(myplot)
  }
}
```
<br>

#### In port, retained
```{r plot_retain}
retain_vms <- filter(vms, to_rm=="retain" & !is.na(in_port))
if(plot.me){
  for(i in seq(1,11)){
    myplot<- ggplot() +
      geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
      geom_polygon(data=buffer_polygons_LL, aes(x = long, y = lat, group = group), col="blue") +
      geom_point(data=ports_df, aes(x=Lon, y=Lat), col="red", size=2) +
      geom_point(data=retain_vms, aes(x=LONGITUDE, y=LATITUDE, col=avg_speed_ms), alpha=0.5) +
      coord_cartesian(xlim=c(cutcoast[[i]][1], cutcoast[[i]][2]), ylim=c(cutcoast[[i]][3], cutcoast[[i]][4])) +
      geom_text(data=ports_df, aes(x=Lon, y=Lat, label=port_code),size=4, nudge_x=0.07) +
      ggtitle("Retained In-Port VMS Records")
    print(myplot)
  }
}  else{
  for(i in seq(from=1,to=9, by=3)){
    myplot<- ggplot() +
      geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
      geom_polygon(data=buffer_polygons_LL, aes(x = long, y = lat, group = group), col="blue") +
      geom_point(data=ports_df, aes(x=Lon, y=Lat), col="red", size=2) +
      geom_point(data=rm_vms, aes(x=LONGITUDE, y=LATITUDE, col=avg_speed_ms), alpha=0.5) +
      coord_cartesian(xlim=c(cutcoast[[i]][1], cutcoast[[i]][2]), ylim=c(cutcoast[[i]][3], cutcoast[[i]][4])) +
      geom_text(data=ports_df, aes(x=Lon, y=Lat, label=port_code),size=4, nudge_x=0.07) +
      ggtitle("Removed VMS Records")
    print(myplot)
  }
}
```



### Check effects of flagging

#### Have we removed > 99% of records from any trips?
```{r plot_premove}
premoved <- vms %>%
  group_by(Port_Of_Landing, Rec_ID) %>%
  summarise(p.remove = sum(to_rm=="remove") / n())
cat("Removed more than 99% of records from ", sum(premoved$p.remove > 0.99) / length(premoved$p.remove) * 100, "% (" , sum(premoved$p.remove > 0.99) , "total) of trips. ")
ggplot(premoved, aes(x=p.remove)) +
  geom_histogram() +
  ggtitle("Across All Ports") 
if(plot.me){
  for(p in premoved$Port_Of_Landing){
    myplot <- ggplot(data=filter(premoved, Port_Of_Landing == p), aes(x=p.remove)) +
      geom_histogram() +
      ggtitle(paste0("Port: ", p)) +
      xlab("Percent VMS records removed per trip") +
      ggtitle(p)
    print(myplot)
  }
}  else{
  for(i in seq(from=1,to=9, by=3)){
    myplot<- ggplot() +
      geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
      geom_polygon(data=buffer_polygons_LL, aes(x = long, y = lat, group = group), col="blue") +
      geom_point(data=ports_df, aes(x=Lon, y=Lat), col="red", size=2) +
      geom_point(data=rm_vms, aes(x=LONGITUDE, y=LATITUDE, col=avg_speed_ms), alpha=0.5) +
      coord_cartesian(xlim=c(cutcoast[[i]][1], cutcoast[[i]][2]), ylim=c(cutcoast[[i]][3], cutcoast[[i]][4])) +
      geom_text(data=ports_df, aes(x=Lon, y=Lat, label=port_code),size=4, nudge_x=0.07) +
      ggtitle("Removed VMS Records")
    print(myplot)
  }
}
```
<br>



#### General viz across ports
Paths of 2 trips from each port: original data set
```{r plot_2trips}
if(plot.me){
  for(p in unique(vms$Port_Of_Landing)){
    tmp_port <- dplyr::filter(vms, Port_Of_Landing == p)
    if(length(unique(tmp_port$Rec_ID)) > 1){
      for(i in seq(1,2)){
        tmp_dat <- filter(tmp_port, Rec_ID == unique(tmp_port$Rec_ID)[i])
        label_dat <- rbind(tmp_dat[1,], tmp_dat[length(tmp_dat$Rec_ID),])
        myplot <- ggplot(tmp_dat) +
          geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
          geom_point(aes(x=LONGITUDE, y=LATITUDE, col=to_rm), size = 4, alpha = 0.5) + 
          geom_path(aes(x=LONGITUDE, y=LATITUDE), col="dodgerblue4", size = 0.5, alpha = 0.5) +
          geom_text(data=label_dat, aes(y = LATITUDE,x=LONGITUDE, label=c("S", "E"))) +
          geom_point(data=filter(ports_df, as.character(port_code) == as.character(unique(tmp_dat$Port_Of_Landing))), aes(x=Lon, y=Lat), col="red", size=2) +
          #scale_color_continuous() +
          ggtitle(paste0("Trip ID:", i, "Port:", tmp_dat$Port_Of_Landing[1])) +
          coord_cartesian(xlim=c(min(tmp_dat$LONGITUDE) - 0.1, max(tmp_dat$LONGITUDE) + 0.1), ylim=c(min(tmp_dat$LATITUDE) - 0.1, max(tmp_dat$LATITUDE) + 0.1))
        png(paste0("ProcessVMS/R_Output/quality/buffer_zones/",years[1], "/", p, "_Rec", unique(tmp_dat$Rec_ID), ".png"))
        print(myplot)
        dev.off()
      }
    }
    else{
      tmp_dat <- tmp_port
      label_dat <- rbind(tmp_dat[1,], tmp_dat[length(tmp_dat$Rec_ID),])
      myplot <- ggplot(tmp_dat) +
        geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
        geom_point(aes(x=LONGITUDE, y=LATITUDE, col=to_rm), size = 4, alpha = 0.5) + 
        geom_path(aes(x=LONGITUDE, y=LATITUDE), col="dodgerblue4", size = 0.5, alpha = 0.5) +
        geom_text(data=label_dat, aes(y = LATITUDE,x=LONGITUDE, label=c("S", "E"))) +
        geom_point(data=filter(ports_df, as.character(port_code) == as.character(unique(tmp_dat$Port_Of_Landing))), aes(x=Lon, y=Lat), col="red", size=2) +
        #scale_color_continuous() +
        ggtitle(paste0("Trip ID:", i, "Port:", tmp_dat$Port_Of_Landing[1])) +
        coord_cartesian(xlim=c(min(tmp_dat$LONGITUDE) - 0.1, max(tmp_dat$LONGITUDE) + 0.1), ylim=c(min(tmp_dat$LATITUDE) - 0.1, max(tmp_dat$LATITUDE) + 0.1))
      png(paste0("ProcessVMS/R_Output/quality/buffer_zones/",years[1], "/", p, "_Rec", unique(tmp_dat$Rec_ID), ".png"))
      print(myplot)
      dev.off()
    }
  }
}
```




Paths of 2 trips from each port: newly filtered data set
```{r plot_2trips_new}
if(plot.me){
  for(p in unique(vms_out$Port_Of_Landing)){
    tmp_port <- dplyr::filter(vms_out, Port_Of_Landing == p)
    if(length(unique(tmp_port$Rec_ID)) > 1){
      for(i in seq(1,2)){
        tmp_dat <- filter(tmp_port, Rec_ID == unique(tmp_port$Rec_ID)[i])
        label_dat <- rbind(tmp_dat[1,], tmp_dat[length(tmp_dat$Rec_ID),])
        myplot <- ggplot(tmp_dat) +
          geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
          geom_point(aes(x=LONGITUDE, y=LATITUDE, col=to_rm), size = 4, alpha = 0.5) + 
          geom_path(aes(x=LONGITUDE, y=LATITUDE), col="dodgerblue4", size = 0.5, alpha = 0.5) +
          geom_text(data=label_dat, aes(y = LATITUDE,x=LONGITUDE, label=c("S", "E"))) +
          geom_point(data=filter(ports_df, as.character(port_code) == as.character(unique(tmp_dat$Port_Of_Landing))), aes(x=Lon, y=Lat), col="red", size=2) +
          #scale_color_continuous() +
          ggtitle(paste0("Trip ID:", i, "Port:", tmp_dat$Port_Of_Landing[1])) +
          coord_cartesian(xlim=c(min(tmp_dat$LONGITUDE) - 0.1, max(tmp_dat$LONGITUDE) + 0.1), ylim=c(min(tmp_dat$LATITUDE) - 0.1, max(tmp_dat$LATITUDE) + 0.1))
        png(paste0("ProcessVMS/R_Output/quality/buffer_zones/", years[1], "/filter_", p, "_Rec", unique(tmp_dat$Rec_ID), ".png"))
        print(myplot)
        dev.off()
      }
    }
    else{
      tmp_dat <- tmp_port
      label_dat <- rbind(tmp_dat[1,], tmp_dat[length(tmp_dat$Rec_ID),])
      myplot <- ggplot(tmp_dat) +
        geom_polygon(data=states_df, aes(x=long, y=lat, group=group), fill="grey47") +
        geom_point(aes(x=LONGITUDE, y=LATITUDE, col=to_rm), size = 4, alpha = 0.5) + 
        geom_path(aes(x=LONGITUDE, y=LATITUDE), col="dodgerblue4", size = 0.5, alpha = 0.5) +
        geom_text(data=label_dat, aes(y = LATITUDE,x=LONGITUDE, label=c("S", "E"))) +
        geom_point(data=filter(ports_df, as.character(port_code) == as.character(unique(tmp_dat$Port_Of_Landing))), aes(x=Lon, y=Lat), col="red", size=2) +
        #scale_color_continuous() +
        ggtitle(paste0("Trip ID:", i, "Port:", tmp_dat$Port_Of_Landing[1])) +
        coord_cartesian(xlim=c(min(tmp_dat$LONGITUDE) - 0.1, max(tmp_dat$LONGITUDE) + 0.1), ylim=c(min(tmp_dat$LATITUDE) - 0.1, max(tmp_dat$LATITUDE) + 0.1))
      png(paste0("ProcessVMS/R_Output/quality/buffer_zones/", years[1], "/filter_", p, "_Rec", unique(tmp_dat$Rec_ID), ".png"))
      print(myplot)
      dev.off()
    }
  }
}
```
