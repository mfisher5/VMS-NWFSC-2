---
title: "EMD by group"
author: "M. Fisher"
date: "2/20/2023"
output: html_document
---

Calculate the year-over-year Earth Mover's Distance for Dungeness crab fishing grounds.

This script includes options to remove Dungeness crab vessels based on (1) the number of fishing trips they took in a given year, and/or (2) an exvessel revenue cut-off. This is in addition to the filters that were already imposed in creating the fishing ground data: 

- landings in a given state (e.g., California)
- trips targeting Dungeness crab
- vessels that have five or more relocations per crab season


However, for the analysis as it stands, I am not going to apply any additional filters beyond those already used in script 01.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(magrittr)
library(here)
library(raster)
library(adehabitatHR)
library(move)
library(pryr)
library(plotrix)
```


User inputs
```{r}
crab_years <- seq(2011,2018)
keep_years <- seq(2013,2018)
kernel_g <- 75
udsize       <- 0.90
cut_length <- 40  # all vessels below this length are "small"

save_SPDF <- TRUE # save an SPDF for each vessel, in addition to the 90% UD? Want this if calculating BA overlap later.

indir   <- 'project-dat/vms/interpolation_60min/NaN_speed_filter'
outdir  <- 'project-dat/vms/interpolation_60min/NaN_speed_filter/vessel90ud'
statdir <- 'project-dat/statistics'

filter=FALSE
filter_trips=5
filter_revenue=5000
```



## Data

Earth Mover's distance
```{r}
emd.dat <- read_csv(here::here(statdir,paste0('EMD_annual_per_vessel_',udsize*100,'ud_',kernel_g,'grid_', crab_years[1],'-',substr(tail(crab_years,1),3,4), 'crabYrs_ALL.csv')))
head(emd.dat)
```


Clustering groups
```{r}
vgroups <- read_csv(here('project-dat','vessel_groups','k4_NaNspeedfilter_2014clusterYR_byArea_noncon-group-key.csv'))
vgroups_summary <- vgroups %>% 
              dplyr::select(group,subgroup,vessel_size,group_area,crab_year) %>% 
              distinct()
unique(vgroups$subgroup)
```


Vessel length keys
```{r}
vlengths <- read_csv(here('project-dat','vessel_groups','length_key_dcrb_vms_vessels.csv'))
```



## EMD Group Means

### add vessel group info

add the vessel groups dataframe
```{r}
emd.dat.groups <- emd.dat %>% 
  left_join(vgroups %>% 
              dplyr::select(drvid,group,subgroup,vessel_size,group_area) %>% 
              distinct(),by=c("drvid"),multiple="all") %>%
  filter(!is.na(group))
```

combine crab years
```{r}
emd.dat.groups %<>% unite(col="crab_years",crab_year_1, crab_year_2, sep="_",remove=FALSE)
```

sample sizes for year=over=year comparisons 
```{r}
emd_groups_sample_sizes <-  emd.dat.groups %>%
  group_by(subgroup) %>% summarise(n.vessels=length(unique(drvid)))
filter(emd_groups_sample_sizes,n.vessels < 3) # should probably be 0

emd_groups_yearly_sample_sizes <-  emd.dat.groups %>%
  group_by(crab_years,subgroup) %>% summarise(n.vessels=length(unique(drvid)))
filter(emd_groups_yearly_sample_sizes,n.vessels < 3)
```


grab only the EMD values with non-confidential years for each vessel subgroup and year=over=year comparison (may not have been filtered out with non-confidential vessel key)
```{r}
emd.dat.groups.noncon <- emd.dat.groups %>% 
  left_join(emd_groups_yearly_sample_sizes,by=c("crab_years","subgroup")) %>%
  filter(n.vessels > 2)
```



### group means
```{r}
## vessel clusters
emd_group_means_overall <- emd.dat.groups %>%
  filter(crab_year_1 %in% keep_years & crab_year_2 %in% keep_years) %>%
  group_by(vessel_size,group,subgroup,group_area) %>%
  summarize(mean.emd=mean(emd),sd.emd=std.error(emd),n.vessels=length(unique(drvid)),.groups='drop') %>%
  ungroup() %>%
  mutate(`Vessel Group`=ifelse(group_area=="central","Central",
                         ifelse(group_area=="northern","Northern",
                                ifelse(group_area=="central/northern" & group==3 ,"Central/Northern","Diversified Northern"))),
         crab_years="Overall") %>%
  rename(`Vessel Size`=vessel_size)

emd_group_means <- emd.dat.groups.noncon %>%
  filter(crab_year_1 %in% keep_years & crab_year_2 %in% keep_years) %>%
  group_by(vessel_size,group,subgroup,group_area,crab_years) %>%
  summarize(mean.emd=mean(emd),sd.emd=std.error(emd),n.vessels=length(unique(drvid)),.groups='drop') %>%
  ungroup() %>%
  mutate(`Vessel Group`=ifelse(group_area=="central","Central",
                         ifelse(group_area=="northern","Northern",
                                ifelse(group_area=="central/northern" & group==3 ,"Central/Northern","Diversified Northern")))) %>%
  rename(`Vessel Size`=vessel_size)
emd_group_means %<>%
  rbind(dplyr::select(emd_group_means_overall, colnames(emd_group_means)))
emd_group_means$`Vessel Group` <- factor(emd_group_means$`Vessel Group`,levels=c("Central","Northern","Central/Northern","Diversified Northern"))
emd_group_means$crab_years <- factor(emd_group_means$crab_years, levels=c("Overall","2013_2014","2014_2015","2015_2016","2016_2017","2017_2018"))
```


```{r}
write_csv(emd_group_means, here('project-dat','statistics','meanEMD_annual_bygroup_90ud_75grid_k4_2014clusterYR_noncon.csv'))
```


### t test

#### local vessels
```{r}
wilcox.local.lengths.out <- list()
sig.local.lengths.out <- data.frame(crab_years=as.character(),
                              pval=as.numeric())
emd.dat.local.groups <- filter(emd.dat.groups, group %in% c(1,2))
i=1
for(a in unique(emd.dat.local.groups$group_area)){
for(y in unique(emd.dat.local.groups$crab_years)){
  testdat <- emd.dat.groups %>% filter(crab_years==y & group_area==a)
  wilcox.local.lengths.out[[i]] <- wilcox.test(emd~vessel_size,testdat)
  sig.local.lengths.out %<>% bind_rows(data.frame(area=a,
                                                  crab_years=y,
                                                  pval=round(wilcox.local.lengths.out[[i]]$p.value,5)))
  names(wilcox.local.lengths.out)[[i]] <- paste0(a,"-",y)
  i = i +1
}
}
wilcox.local.lengths.out
```
```{r}
wilcox.local.lengths <- wilcox.local.lengths.out[c(seq(1,5),seq(8,12))]
sig.local.lengths.out %<>% mutate(correct.pval=pval*(length(wilcox.local.lengths)/2)) %>%
  mutate(significance=ifelse(correct.pval<0.05,"*","")) %>%
  mutate(y=(max(emd_group_means$mean.emd)+max(emd_group_means$sd.emd))/1000) %>% filter(crab_years %in% emd_group_means$crab_years)
```

again, on the overall data
```{r}
i=length(wilcox.local.lengths) + 1
for(a in unique(emd.dat.local.groups$group_area)){
  testdat <- emd.dat.groups %>% filter(crab_years %in% emd_group_means$crab_years & group_area==a)
  wilcox.local.lengths[[i]] <- wilcox.test(emd~vessel_size,testdat)
  names(wilcox.local.lengths)[[i]] <- paste0(a,"- Overall")
  
  sig.local.lengths.out %<>% bind_rows(data.frame(area=a,
                                                  crab_years="Overall",
                                                  pval=round(wilcox.local.lengths[[i]] $p.value,5)))
  i = i +1
}
```


Save output from all t-tests
```{r}
wilcox_tests_bylength <- list(wilcox.local.lengths.out,wilcox.local.lengths,sig.local.lengths.out)
save(wilcox_tests_bylength, file=here('project-dat','statistics','wilcox_tests_groups_localBYlength_noncon.rds'))
```



#### coastwide vessels

Note that this can only be done for groups 3-large and 5-large
```{r}
wilcox.coast.lengths.out <- list()
sig.coast.lengths.out <- data.frame(crab_years=as.character(),
                              pval=as.numeric())
emd.dat.coast.groups <- filter(emd.dat.groups, group %in% c(3,5)) %>%
  mutate(group_area=ifelse(group==5,"combo northern/central",group_area))
i=1
for(a in unique(emd.dat.coast.groups$group_area)){
for(y in unique(emd.dat.coast.groups$crab_years)){
  testdat <- emd.dat.groups %>% filter(crab_years==y & group_area==a)
  wilcox.coast.lengths.out[[i]] <- wilcox.test(emd~vessel_size,testdat)
  sig.coast.lengths.out %<>% bind_rows(data.frame(area=a,
                                                  crab_years=y,
                                                  pval=round(wilcox.coast.lengths.out[[i]]$p.value,5)))
  names(wilcox.coast.lengths.out)[[i]] <- paste0(a,"-",y)
  i = i +1
}
}
wilcox.coast.lengths.out
```
```{r}
wilcox.local.lengths <- wilcox.local.lengths.out[c(seq(1,5),seq(8,12))]
sig.local.lengths.out %<>% mutate(correct.pval=pval*(length(wilcox.local.lengths)/2)) %>%
  mutate(significance=ifelse(correct.pval<0.05,"*","")) %>%
  mutate(y=(max(emd_group_means$mean.emd)+max(emd_group_means$sd.emd))/1000) %>% filter(crab_years %in% emd_group_means$crab_years)
```



### anova
#### between years
```{r}
emd.dat.groups.keepYRS <- filter(emd.dat.groups, (crab_year_1 %in% keep_years & crab_year_2 %in% keep_years))
aov.years.out <- list()
tukey.years.out <- list()
i=1

for(s in unique(emd.dat.groups$subgroup)){
  testdat <- filter(emd.dat.groups.keepYRS, subgroup==s)
  aov.years.out[[i]] <- aov(emd~crab_years,data=testdat)
  tukey.years.out[[i]] <- TukeyHSD(aov.years.out[[i]],conf.level=0.90)
  names(aov.years.out)[[i]] <- paste0(s)
  names(tukey.years.out)[[i]] <- paste0(s)
  i=i+1
}
```


```{r}
anovas_list <- list(aov.years.out,tukey.years.out)
save(anovas_list, file=here('project-dat','statistics','anova_tukey_tests_crossYrs_byGroup.rds'))
```


#### between groups
are there significant differences between vessel groups, for the overall EMD mean?
```{r}
aov.groups.out <- aov(emd~subgroup,data=emd.dat.groups.keepYRS)
summary(aov.groups.out)
tukey.groups.out <- TukeyHSD(aov.groups.out)
```

```{r}
anovas_list <- list(aov.groups.out,tukey.groups.out)
save(anovas_list, file=here('project-dat','statistics','anova_tukey_tests_groups_byYR.rds'))
```





