---
title: "Mapping UDs"
author: "M. Fisher"
date: "4/2/2023"
output: html_document
---

## Description

Map utilization distributions


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(maps)
library(here)
library(rgdal)
library(rgeos)
library(adehabitatHR)
library(grid); library(PNWColors)

source(here('R/map_fishing_stacked_2sizes.R'))
source(here('R','create_vms_spdf.R'))
```


User inputs
```{r}
keep_years <- seq(2013,2018)

indir <- 'project-dat/vms/interpolation_60min/NaN_speed_filter'
uddir <- 'project-dat/vms/interpolation_60min/NaN_speed_filter/group90ud'


## size of port group labels on maps; this should change with res
pg_label_size = 4  # suggested:4

```


## Data

VMS
```{r read_vms}
for(y in keep_years){
  tmpvms <-  read_rds(here::here(indir,paste0(y,'season_crabfishing.rds')))
  if(y==keep_years[1]){
    vms <- tmpvms
  } else{
    vms %<>% bind_rows(tmpvms)
  }
}

str(vms)
```


Basemap
```{r fig.height=4, fig.width=3}
data(stateMapEnv)
states_df <- map_data("state") %>%
  filter(region %in% c("california"))
states_df_sp <- states_df
coordinates(states_df_sp) <- c("long", "lat")
proj4string(states_df_sp) <- CRS("+init=epsg:4326") # WGS 84
# states_geo <- spTransform(states_df_sp, CRS("+init=epsg:32610"))
states_geo_df <- as.data.frame(states_df_sp)

states_df_coast <- filter(states_df,long < -116) %>%
  filter(!(long > -120.5 & lat > 32.5)) %>%
  filter(!(long > -122.5 & lat > 38.1))

# check the outline
ggplot(data=states_df_coast, aes(x=long,y=lat,group=group)) + geom_path()
```


port group points
```{r}
pg <- read.csv(here::here('project-dat','pcgroup_mean_coordinates.csv'))
pg$port_group <- c("Bodega Bay","Fort Bragg","Crescent City","Eureka","Monterey","Morro Bay","San Francisco")
coordinates(pg) <- c("Lon", "Lat")
proj4string(pg) <- CRS("+init=epsg:4326") # WGS 84
# pg_geo <- spTransform(pg, CRS("+init=epsg:32610"))
pg_df <- as.data.frame(pg)


pg_df$port_group_label <- pg_df$port_group_name
pg_df$port_group_label[which(pg_df$port_group_label=="Morro Bay")] <- "Morro\nBay"
pg_df$port_group_label[which(pg_df$port_group_label=="San Francisco")] <- "\nSan Francisco"
```


vessel groups 
```{r}
vgroups <- read_csv(here('project-dat','vessel_groups','k4_NaNspeedfilter_2014clusterYR_byArea_noncon-group-key.csv'))

vgroup_summary <- vgroups %>% dplyr::select(group,subgroup,group_area, vessel_size) %>% distinct()
vgroup_annual_summary <- vgroups %>% dplyr::select(subgroup,group_area,vessel_size,crab_year) %>% 
  distinct() %>% arrange(subgroup)
```


90% Utilization Distributions, as rasters, saved into a list of lists. A list of rasters (by year) was saved for each vessel group from script `04b_vessel_group_overlap.Rmd`
```{r}
group_uds <- list()
for(i in seq(1,length(vgroup_summary$subgroup))){
  g <- vgroup_summary$subgroup[i]
  tmpuds <- readRDS(here(uddir,paste0(g,"_90ud_SpatialPolygonsGetVerticesHR_250grid_2013-18crabYrs.rds")))
  group_uds[[i]] <- tmpuds
}

names(group_uds) <- vgroup_summary$subgroup

rm(g)
```
<br>


## Small vessels

### northern locals

```{r}
g <- "2-small"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`2-small`
```


The dark blue on the map is the group's ud that is in the paper figure; the orange is the ud for the vessel.
```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,central_fill="pink")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_SmLocal_stacked_rmNorth",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```

Notes from maps:
- 



### central locals

```{r}
g <- "1-small"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`1-small`
```


The dark blue on the map is the group's ud that is in the paper figure; the orange is the ud for the vessel.

```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,north_fill=pnw_palette("Bay",n=5)[4], central_fill="aquamarine4")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_SmLocal_stacked_rmCentral",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```



## Large vessels

### northern locals

```{r}
g <- "2-large"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`2-large`
```


The dark blue on the map is the group's ud that is in the paper figure; the pink is the ud for the vessel.
```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,central_fill="pink")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_LgLocal_stacked_rmNorth",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```

### central locals

```{r}
g <- "1-large"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`1-large`
```


The dark blue on the map is the group's ud that is in the paper figure; the orange is the ud for the vessel.

```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,north_fill=pnw_palette("Bay",n=5)[4], central_fill="aquamarine4")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_LgLocal_stacked_rmCentral",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```

### cross-district pool









```{r}
key_filter <- filter(vgroups_summary, subgroup %in% c("5-large"))

north_uds <- udlist[["5-large"]]
# map_fishing_stacked <- function(north_uds,central_uds,key,keep_years,states_df_coast,label_year=TRUE){
#   
#   
#   
# }
  
  # prep to add to map
  ncol=pnw_palette("Moth",n=7)[4]
  
  myplot_coast <- ggplot()
  j = 0
  for(i in seq(1,length(keep_years))){
  yr <- as.numeric(keep_years[i])
  n_uds <- north_uds[north_uds$id==yr,]
  new_coast <- states_df_coast
    if(i > 1){
      n_uds <- fortify(n_uds) %>% mutate(long=long+j)
      new_coast <- new_coast %>% mutate(long=long+j)
    } 
    if(i < length(keep_years)){
      myplot_coast <- myplot_coast  +
        geom_path(data=new_coast,aes(x=long,y=lat,group=group),col="grey50") +
        geom_segment(aes(y=38.79, yend=38.79,x=-124,xend=-120), lty=3) +
        geom_polygon(data=n_uds, aes(x=long,y=lat, group=group), fill=ncol,color=ncol,alpha=0.3, size=0.5)
      j = j + offset
    } else{
    myplot_coast <- myplot_coast  +
      geom_polygon(data=states_geo_df, aes(x=long+j, y=lat, group=group), fill="grey87",linetype=1) +
      geom_path(data=new_coast,aes(x=long,y=lat,group=group),col="grey50") +
    geom_point(data=pg_df, aes(x=Lon+j,y=Lat), color="black") +
      geom_segment(aes(y=38.79, yend=38.79,x=-124,xend=-120+j), lty=3) +
      geom_polygon(data=n_uds, aes(x=long,y=lat, group=group), fill=ncol,color=ncol,alpha=0.3, size=0.5) +
      geom_text(data=pg_df, aes(x=Lon+j, y=Lat, label=port_group),size=pg_label_size,
                nudge_x=c(1.5,1.3,1.7,1,1.1,1),nudge_y=c(0.25,rep(0,5)))
    }
  }
  
  # finalize plot area / theme
  myplot_coast <- myplot_coast + theme_void() +
    theme(legend.position="none",plot.margin=margin(l=0,r=0.5,unit="cm"),
                         plot.title = element_text(hjust=0.5))  +
        coord_fixed(xlim=c(-127,-120+j),ylim=c(33,43))
  
  if(label_year){
    # data frame to label crab years
    nyrs <- length(keep_years)
    yrs_labels <- data.frame(yr = seq(as.numeric(first(keep_years)),as.numeric(last(keep_years)))) %>%
      mutate(ymin=42.5,ymax=42.5) %>%
      mutate(xmin=seq(-124, -124+((nyrs-1)*offset), by=offset),
             xmax=xmin)
    for(i in seq(1,nyrs)){
      myplot_coast <- myplot_coast +  annotation_custom(grob = textGrob(label = yrs_labels$yr[i], hjust = 0, gp = gpar(cex = 1.2)),
                                            ymin = yrs_labels$ymin[i], ymax = yrs_labels$ymax[i],
                                            xmin = yrs_labels$xmin[i], xmax = yrs_labels$xmax[i])
    }
  } #end if(label_year)
```


```{r}
png(here::here('project-dat','figures',"change_90ud_annual_All_byRegion_stacked.png"),res=200,height=2000, width=1800)
grid.arrange(grobs=list(myplot_sm,myplot_lg,myplot_coast),nrow=3)
dev.off()
```



