---
title: "Check Sensitivity of 90% UD Maps"
author: "M. Fisher"
date: "4/2/2023"
output: html_document
---

## Description

Figure 2 provides the 90% utilization distributions of vessel groups, by year. Since vessel fishing locations are confidential unless summarized to n=3 or more, we need to make sure that a particularly isolated part of the published utilization distribution is not wholly dependent on a single vessel. 

For each vessel in the group, plot the utilization distribution with (e.g., what would be Figure 2) and without the vessel. If there is a significant change in the group UD without the vessel, Figure 2 may need to be adjusted.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(maps)
library(here)
library(rgdal)
library(rgeos)
library(adehabitatHR)
library(grid); library(PNWColors)

source(here('R','map_fishing_stacked_2sizes.R'))
source(here('R','create_vms_spdf.R'))
```


User inputs
```{r}
keep_years <- seq(2013,2018)

indir <- 'project-dat/vms/interpolation_60min/NaN_speed_filter'
uddir <- 'project-dat/vms/interpolation_60min/NaN_speed_filter/group90ud'


## size of port group labels on maps; this should change with res
pg_label_size = 4  # suggested:4

```


## Data

VMS
```{r read_vms}
for(y in keep_years){
  tmpvms <-  read_rds(here::here(indir,paste0(y,'season_crabfishing.rds')))
  if(y==keep_years[1]){
    vms <- tmpvms
  } else{
    vms %<>% bind_rows(tmpvms)
  }
}

str(vms)
```


Basemap
```{r fig.height=4, fig.width=3}
data(stateMapEnv)
states_df <- map_data("state") %>%
  filter(region %in% c("california"))
states_df_sp <- states_df
coordinates(states_df_sp) <- c("long", "lat")
proj4string(states_df_sp) <- CRS("+init=epsg:4326") # WGS 84
# states_geo <- spTransform(states_df_sp, CRS("+init=epsg:32610"))
states_geo_df <- as.data.frame(states_df_sp)

states_df_coast <- filter(states_df,long < -116) %>%
  filter(!(long > -120.5 & lat > 32.5)) %>%
  filter(!(long > -122.5 & lat > 38.1))

# check the outline
ggplot(data=states_df_coast, aes(x=long,y=lat,group=group)) + geom_path()
```


port group points
```{r}
pg <- read.csv(here::here('project-dat','pcgroup_mean_coordinates.csv'))
pg$port_group <- c("Bodega Bay","Fort Bragg","Crescent City","Eureka","Monterey","Morro Bay","San Francisco")
coordinates(pg) <- c("Lon", "Lat")
proj4string(pg) <- CRS("+init=epsg:4326") # WGS 84
# pg_geo <- spTransform(pg, CRS("+init=epsg:32610"))
pg_df <- as.data.frame(pg)


pg_df$port_group_label <- pg_df$port_group_name
pg_df$port_group_label[which(pg_df$port_group_label=="Morro Bay")] <- "Morro\nBay"
pg_df$port_group_label[which(pg_df$port_group_label=="San Francisco")] <- "\nSan Francisco"
```


vessel groups 
```{r}
vgroups <- read_csv(here('project-dat','vessel_groups','k4_NaNspeedfilter_2014clusterYR_byArea_noncon-group-key.csv')) %>%
  filter(crab_year %in% keep_years)

vgroup_summary <- vgroups %>% dplyr::select(group,subgroup,group_area, vessel_size) %>% distinct()
vgroup_annual_summary <- vgroups %>% dplyr::select(subgroup,group_area,vessel_size,crab_year) %>% 
  distinct() %>% arrange(subgroup)
```


90% Utilization Distributions, as rasters, saved into a list of lists. A list of rasters (by year) was saved for each vessel group from script `04b_vessel_group_overlap.Rmd`
```{r}
group_uds <- list()
for(i in seq(1,length(vgroup_summary$subgroup))){
  g <- vgroup_summary$subgroup[i]
  tmpuds <- readRDS(here(uddir,paste0(g,"_90ud_SpatialPolygonsGetVerticesHR_250grid_2013-18crabYrs_annual.rds")))
  group_uds[[i]] <- tmpuds
}

names(group_uds) <- vgroup_summary$subgroup

rm(g)
```
<br>


## Small vessels

### northern locals

```{r}
g <- "2-small"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`2-small`
```


The dark blue on the map is the group's ud that is in the paper figure; the orange is the ud for the vessel.
```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,central_fill="pink")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_SmLocal_stacked_rmNorth",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```

Notes from maps:
- 



### central locals

```{r}
g <- "1-small"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`1-small`
```


The dark blue on the map is the group's ud that is in the paper figure; the orange is the ud for the vessel.

```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,north_fill=pnw_palette("Bay",n=5)[4], central_fill="aquamarine4")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_SmLocal_stacked_rmCentral",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```



## Large vessels

### northern locals

```{r}
g <- "2-large"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`2-large`
```


The dark blue on the map is the group's ud that is in the paper figure; the pink is the ud for the vessel.
```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,central_fill="pink")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_LgLocal_stacked_rmNorth",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```

### central locals

```{r}
g <- "1-large"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`1-large`
```


The dark blue on the map is the group's ud that is in the paper figure; the orange is the ud for the vessel.

```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,north_fill=pnw_palette("Bay",n=5)[4], central_fill="aquamarine4")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_LgLocal_stacked_rmCentral",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```

### cross-district pool


```{r}
g <- "5-large"
key_sub <- filter(vgroups, subgroup == g)
vessels_sub <- unique(key_sub$drvid)
vms_sub <- filter(vms, (removal_type_code %in% c("C","D","U")) & (crab_year %in% keep_years) & (drvid %in% vessels_sub))
dim(vms_sub)

group_ud <- group_uds$`5-large`
```


The dark blue on the map is the group's ud that is in the paper figure; the pink is the ud for the vessel.

```{r}
for(i in seq(1,length(vessels_sub))){
  tmp_vessel <- vessels_sub[i]; print(tmp_vessel)
  tmp_vms    <- filter(vms_sub, drvid != tmp_vessel)
  message(dim(vms_sub)[1]-dim(tmp_vms)[1], " records removed out of ",dim(vms_sub)[1])
  tmp_sp <- create_groups_vms_spdf(dat=tmp_vms, crab_years=keep_years, group_id=g, list_by="year", clusters=key_sub)[[1]]
  vms_ud <- kernelUD(tmp_sp, grid=250, h=.06, same4all=TRUE)
  vms_udp <- getverticeshr(vms_ud, percent=90)
  
  testplot <- map_fishing_stacked2(north_uds=group_ud,central_uds=vms_udp,key=key_sub,keep_years=keep_years,states_df_coast=states_df_coast,central_fill="pink")
  png(here::here('project-dat','figures','QC',paste0("change_90ud_annual_LgCrossDistrict_stacked_rm",tmp_vessel,".png")),height=2000,width=1800,res=300)
  print(testplot)
  dev.off()
  message("done.")
}
```


