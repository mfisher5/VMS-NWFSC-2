---
title: "EMD by vessel"
author: "M. Fisher"
date: "2/20/2023"
output: html_document
---

Calculate the year-over-year Earth Mover's Distance for Dungeness crab fishing grounds.

For year-over-year comparisons of fishing grounds based only on vessel size, we do not need to restrict the analysis to vessels assigned to a group from the 2013-14 crab season. Instead, we just need vessels with VMS in at least two successive seasons.

This script includes options to remove Dungeness crab vessels based on (1) the number of fishing trips they took in a given year, and/or (2) an exvessel revenue cut-off. This is in addition to the filters that were already imposed in creating the fishing ground data: 

- landings in a given state (e.g., California)
- trips targeting Dungeness crab
- vessels that have five or more relocations per crab season


However, for the analysis as it stands, I am not going to apply any additional filters beyond those already used in script 01.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(magrittr)
library(here)
library(raster)
library(adehabitatHR)
library(move)
library(pryr)
```


User inputs
```{r}
crab_years <- seq(2011,2018)
kernel_g <- 75
udsize       <- 0.90
cut_length <- 40  # all vessels below this length are "small"

save_SPDF <- TRUE # save an SPDF for each vessel, in addition to the 90% UD? Want this if calculating BA overlap later.

indir   <- 'project-dat/vms/interpolation_60min/NaN_speed_filter'
outdir  <- 'project-dat/vms/interpolation_60min/NaN_speed_filter/vessel90ud'

filter=FALSE
filter_trips=5
filter_revenue=5000
```



## Data

VMS
```{r read_vms}
for(y in crab_years){
  tmpvms <-  read_rds(here::here(indir,paste0(y,'season_crabfishing.rds')))
  if(y==crab_years[1]){
    vms <- tmpvms
  } else{
    vms %<>% bind_rows(tmpvms)
  }
}

str(vms)
```


Fish tickets
```{r read_fishtix}
for(y in crab_years){
  tmpy <- y-1
  tmptix <-  read_rds(here::here('../data','processed','fish tickets',paste0(tmpy,'fishtix_vlengths.rds'))) %>%
  dplyr::select(Rec_ID,drvid,year,FINAL_LENGTH) %>% distinct()
  if(y==crab_years[1]){
    tix <- tmptix
  } else{
    tix %<>% bind_rows(tmptix)
  }
}

str(tix)
```



make just a vessel length key. since vessel lengths can vary by year, vessel lengths are assigned according to the year at the *beginning* each crab season (in other words, crab_year - 1). 
```{r}
lkey <- tix %>% left_join(vms %>% dplyr::select(Rec_ID,drvid,crab_year) %>% distinct()) %>%
  filter(year!=crab_year) %>%
  dplyr::select(drvid,FINAL_LENGTH,crab_year) %>% distinct() %>%
  mutate(vessel_size=ifelse(FINAL_LENGTH < cut_length,"small","large"))

lkey.filtered <- lkey %>% filter(!is.na(FINAL_LENGTH))

write_csv(lkey.filtered,here('project-dat','vessel_groups','length_key_dcrb_vms_vessels.csv'))
```


## Filtering

### trips per vessel

### exvessel revenue

## Earth Mover's Distance per vessel

The Earth Mover's Distance calculation takes a utilization distribution as: A Raster, RasterStack, RasterBrick, SpatialPoints, SpatialPointsDataFrame. This code first constructs the utilization distribution, and then saves it uses a Spatial Points DataFrame. That object can be called back in to calculate EMD.

### create utilization distribution


```{r}
for(d in unique(vms$drvid)){
  # filter VMS data
  tmpvms <- filter(vms, crab_year %in% crab_years & drvid == d) %>%
    dplyr::select(drvid,crab_year,X_COORD, Y_COORD)
  # create the Spatial Points Data frame
  tmpvms.sp <- SpatialPointsDataFrame(coords=tmpvms %>% dplyr::select(X_COORD,Y_COORD), data=tmpvms %>% dplyr::select(crab_year), proj4string = CRS("+init=epsg:32610"))
  
  # save the list(by year) of spatial points dataframes as an RDS
  if(save_SPDF){
  write_rds(tmpvms.sp, here::here(outdir,paste0(d,"_SPDF_", crab_years[1],"-",substr(tail(crab_years,1),3,4), "crabYrs.rds")))
  }
  
  tmpyrs <- unique(tmpvms.sp$crab_year)
  tmpout <- list()
  # create a list of raster layers
  for(j in seq(1,length(tmpyrs))){
    y <- tmpyrs[j]
    # create utilization distribution, with grid size of 'kernel_g'
    tmpud <- kernelUD(tmpvms.sp[tmpvms.sp$crab_year==y,], grid=kernel_g)
    # convert estUD object to a raster
    tmpras <- raster(as(tmpud[[1]],"SpatialPixelsDataFrame"))
    # set any points outside the 90% line to NA, then recalculate the probability surface
    tmpras[tmpras > udsize] <- NA; newras <- tmpras/cellStats(tmpras,sum)
    tmpout[[j]] <- newras
  }
  names(tmpout) <- tmpyrs
  # save the list(by year) of 90% UD rasters as an RDS
  write_rds(tmpout, here::here(outdir,paste0(d,"_",udsize*100,"ud_RasterLayer_",kernel_g,"grid_", crab_years[1],"-",substr(tail(crab_years,1),3,4), "crabYrs.rds")))
}
rm(tmpout, tmpvms,tmpvms.sp)
```
<br>

Get filenames from above.
```{r}
file_vec <- list.files(path=here(outdir),pattern="RasterLayer")
```

Read back in the 90% UD lists, and find the year-over-year EMD for each vessel.
```{r}
# for(i in seq(1,length(file_vec))){
for(i in seq(202,length(file_vec))){
  # get drvid & rds name
  f <- file_vec[[i]]
  d <- strsplit(f,split="_")[[1]][1]
  message(d)
  # read in rds
  ras_list <- read_rds(here::here(outdir,f))
  tmpyrs <- names(ras_list)
  if(length(tmpyrs) > 1){
    # empty data frame for EMD
    tmpdat <- matrix(nrow=length(tmpyrs),ncol=length(tmpyrs),dimnames=list(tmpyrs,tmpyrs),data=0)
    
    # get emd for consecutive years
    sstart <- Sys.time()
    message("calculating emd...")
    for(j in seq(1,length(ras_list)-1)){
      k=j+1
      message("working on ",names(ras_list)[j],"...")
        tmpdat[j,k] <- emd(ras_list[[j]],ras_list[[k]])
    }
    
    # get unique values from EMD matrix. coerce to dataframe.
    ind <- which(upper.tri(tmpdat, diag = FALSE), arr.ind = TRUE)
    tmpdat.df <- data.frame(drvid=d,
                            crab_year_1 = tmpyrs[ind[,1]],
                            crab_year_2 = tmpyrs[ind[,2]],
                            emd=tmpdat[ind]) %>%
      mutate(tmpdiff=as.numeric(crab_year_2)-as.numeric(crab_year_1)) %>%
      filter(tmpdiff == 1) %>% dplyr::select(-tmpdiff)
    message(d, " done.\n")
    print(Sys.time()-sstart)
    # 
    
    if(!(exists("emd_dat"))){
      emd_dat <- tmpdat.df
    } else{
      emd_dat %<>% rbind(tmpdat.df)
    }
    rm(ras_list,tmpdat,ind)
    
  }
}

write.csv(emd_dat,here::here('project-dat','statistics',paste0('EMD_annual_per_vessel_',udsize*100,'ud_',kernel_g,'grid_', crab_years[1],'-',substr(tail(crab_years,1),3,4), 'crabYrs-part4.csv')))

```
<br>


## Significance testing
```{r}
keep_years <- seq(2013,2018)
```

Vessel length keys
```{r}
vlengths <- read_csv(here('project-dat','vessel_groups','length_key_dcrb_vms_vessels.csv'))
```

Clustering groups
```{r}
vgroups <- read_csv(here('project-dat','vessel_groups','k4_NaNspeedfilter_2014clusterYR_byArea_noncon-group-key.csv'))
```

### fix missing vessel sizes

```{r}
emd.dat %<>% left_join(vlengths,by=c("drvid","crab_year_1"="crab_year"))
```

if a fishing vessel is missing vessel sizes, use the most common size over all the other years. leave the final length as NA so that we can tell which sizes were interpolated.
```{r}
# split data set 
emd.dat.noVS <- filter(emd.dat, is.na(vessel_size))
emd.dat.VS <- filter(emd.dat, !is.na(vessel_size))

# get most common vessel sizes
VS_mode <- emd.dat.VS %>%
  group_by(drvid) %>%
  summarise(vessel_size=getmode(vessel_size),
            n_sizes=length(unique(vessel_size)))
# any vessels span size classes across years?
VS_mode %>% filter(n_sizes>1)

# add in vessel sizes
emd.dat.noVS %<>% dplyr::select(-vessel_size) %>%
  left_join(VS_mode,by="drvid") %>% dplyr::select(-n_sizes)


# rejoin data sets
emd.dat <- bind_rows(emd.dat.VS, emd.dat.noVS) %>% arrange(drvid,crab_year_1)
(length((emd.dat %>% filter(is.na(vessel_size)))$vessel_size)/dim(emd.dat[1]))
```


### add vessel groups
```{r}
emd.dat.groups <- emd.dat %>% dplyr::select(-vessel_size) %>% 
  left_join(vgroups %>% dplyr::select(drvid,group,subgroup,vessel_size,area) %>% distinct(),by=c("drvid")) %>%
  filter(!is.na(group))
```

combine crab years
```{r}
emd.dat %<>% unite(col="crab_years",crab_year_1, crab_year_2, sep="_",remove=FALSE)
emd.dat.groups %<>% unite(col="crab_years",crab_year_1, crab_year_2, sep="_",remove=FALSE)
```

### group means
```{r}
## small / large vessels
emd_means_overall <- emd.dat %>%
  filter(crab_year_1 %in% keep_years & crab_year_2 %in% keep_years) %>%
  filter(!is.na(vessel_size)) %>%
  group_by(vessel_size) %>%
  summarize(mean.emd=mean(emd),sd.emd=std.error(emd),.groups='drop') %>%
  mutate(crab_years="Overall",group="All Vessels")
emd_means <- emd.dat %>%
  filter(crab_year_1 %in% keep_years & crab_year_2 %in% keep_years) %>%
  filter(!is.na(vessel_size)) %>%
  group_by(vessel_size,crab_years) %>%
  summarize(mean.emd=mean(emd),sd.emd=std.error(emd),.groups='drop') %>%
  mutate(group="All Vessels") %>%
  rbind(emd_means_overall)
emd_means$crab_years <- factor(emd_means$crab_years, levels=c("Overall","2013_2014","2014_2015","2015_2016","2016_2017","2017_2018"))

## vessel clusters
emd_group_means_overall <- emd.dat.groups %>%
  filter(crab_year_1 %in% keep_years & crab_year_2 %in% keep_years) %>%
  group_by(vessel_size,group,subgroup,area) %>%
  summarize(mean.emd=mean(emd),sd.emd=std.error(emd),.groups='drop') %>%
  ungroup() %>%
  mutate(`Vessel Group`=ifelse(area=="central","Central",
                         ifelse(area=="northern","Northern",
                                ifelse(area=="central/northern" & group==3 ,"Central/Northern","Diversified Northern"))),
         crab_years="Overall") %>%
  rename(`Vessel Size`=vessel_size)

emd_group_means <- emd.dat.groups %>%
  filter(crab_year_1 %in% keep_years & crab_year_2 %in% keep_years) %>%
  group_by(vessel_size,group,subgroup,area,crab_years) %>%
  summarize(mean.emd=mean(emd),sd.emd=std.error(emd),.groups='drop') %>%
  ungroup() %>%
  mutate(`Vessel Group`=ifelse(area=="central","Central",
                         ifelse(area=="northern","Northern",
                                ifelse(area=="central/northern" & group==3 ,"Central/Northern","Diversified Northern")))) %>%
  rename(`Vessel Size`=vessel_size)
emd_group_means %<>%
  rbind(dplyr::select(emd_group_means_overall, colnames(emd_group_means)))
emd_group_means$`Vessel Group` <- factor(emd_group_means$`Vessel Group`,levels=c("Central","Northern","Central/Northern","Diversified Northern"))
emd_group_means$crab_years <- factor(emd_group_means$crab_years, levels=c("Overall","2013_2014","2014_2015","2015_2016","2016_2017","2017_2018"))
```


```{r}
write_csv(emd_means, here('project-dat','statistics','meanEMD_annual_bysize_90ud_75grid.csv'))
write_csv(emd_group_means, here('project-dat','statistics','meanEMD_annual_bygroup_90ud_75grid_k4_2014clusterYR.csv'))
```


### t test
```{r fig.height=3, fig.width=5}
ggplot(data=emd.dat,aes(x=emd)) + geom_histogram(aes(fill=vessel_size))
```
The data is not normal. conduct a wilcoxon test for each comparison

#### by length
```{r}
wilcox.lengths.out <- list()
sig.lengths.out <- data.frame(crab_years=as.character(),
                              pval=as.numeric())
i=1
for(y in unique(emd.dat$crab_years)){
  testdat <- emd.dat %>% filter(crab_years==y & !is.na(vessel_size))
  wilcox.lengths.out[[i]] <- wilcox.test(emd~vessel_size,testdat)
  sig.lengths.out %<>% bind_rows(data.frame(crab_years=y,
                                 pval=round(wilcox.lengths.out[[i]]$p.value,5)))
  i = i +1
}
names(wilcox.lengths.out) <- unique(emd.dat$crab_years)
wilcox.lengths.out
```
```{r}
wilcox.lengths <- wilcox.lengths.out[which(names(wilcox.lengths.out) %in% emd_means$crab_years)]
sig.lengths.out %<>% mutate(correct.pval=pval*length(wilcox.lengths)) %>%
  mutate(significance=ifelse(correct.pval<0.05,"*","")) %>%
  mutate(y=(max(emd_means$mean.emd)+max(emd_means$sd.emd))/1000) %>% filter(crab_years %in% emd_means$crab_years)
```

again, on the overall data
```{r}
i=length(wilcox.lengths) + 1
testdat <- emd.dat %>% filter(!is.na(vessel_size)) %>%
  filter(crab_years %in% emd_means$crab_years)
wilcox.lengths[[length(wilcox.lengths) + 1]] <- wilcox.test(emd~vessel_size,testdat)
wilcox.lengths[[length(wilcox.lengths)]]

sig.lengths.out %<>% bind_rows(data.frame(crab_years="Overall",
                                         pval=wilcox.lengths[[length(wilcox.lengths)]]$p.value,
                                         significance="*",
                                         y=unique(sig.lengths.out$y)))
```

#### by length & group, for local vessels
```{r}
wilcox.local.lengths.out <- list()
sig.local.lengths.out <- data.frame(crab_years=as.character(),
                              pval=as.numeric())
emd.dat.local.groups <- filter(emd.dat.groups, group %in% c(1,2))
i=1
for(a in unique(emd.dat.local.groups$area)){
for(y in unique(emd.dat.local.groups$crab_years)){
  testdat <- emd.dat.groups %>% filter(crab_years==y & area==a)
  wilcox.local.lengths.out[[i]] <- wilcox.test(emd~vessel_size,testdat)
  sig.local.lengths.out %<>% bind_rows(data.frame(area=a,
                                                  crab_years=y,
                                                  pval=round(wilcox.local.lengths.out[[i]]$p.value,5)))
  names(wilcox.local.lengths.out)[[i]] <- paste0(a,"-",y)
  i = i +1
}
}
wilcox.local.lengths.out
```
```{r}
wilcox.local.lengths <- wilcox.local.lengths.out[c(seq(1,5),seq(8,12))]
sig.local.lengths.out %<>% mutate(correct.pval=pval*(length(wilcox.local.lengths)/2)) %>%
  mutate(significance=ifelse(correct.pval<0.05,"*","")) %>%
  mutate(y=(max(emd_means$mean.emd)+max(emd_means$sd.emd))/1000) %>% filter(crab_years %in% emd_means$crab_years)
```

again, on the overall data
```{r}
i=length(wilcox.local.lengths) + 1
for(a in unique(emd.dat.local.groups$area)){
  testdat <- emd.dat.groups %>% filter(crab_years %in% emd_group_means$crab_years & area==a)
  wilcox.local.lengths[[i]] <- wilcox.test(emd~vessel_size,testdat)
  names(wilcox.local.lengths)[[i]] <- paste0(a,"- Overall")
  
  sig.local.lengths.out %<>% bind_rows(data.frame(area=a,
                                                  crab_years="Overall",
                                                  pval=round(wilcox.local.lengths[[i]] $p.value,5)))
  i = i +1
}
```


Save output from all t-tests
```{r}
wilcox_tests_bylength <- list(wilcox.lengths.out,wilcox.lengths,sig.lengths.out,wilcox.local.lengths.out,wilcox.local.lengths,sig.local.lengths.out)
save(wilcox_tests_bylength, file=here('project-dat','statistics','wilcox_tests_bylength.rds'))
```


### anova
#### between years
```{r}
emd.dat.keepYRS <- filter(emd.dat, (crab_year_1 %in% keep_years & crab_year_2 %in% keep_years))
emd.dat.groups.keepYRS <- filter(emd.dat.groups, (crab_year_1 %in% keep_years & crab_year_2 %in% keep_years))
aov.years.out <- list()
tukey.years.out <- list()
i=1
## first across all vessels, by size
for(s in c("small","large")){
  testdat <- filter(emd.dat.keepYRS, vessel_size==s)
  aov.years.out[[i]] <- aov(emd~crab_years,data=testdat)
  tukey.years.out[[i]] <- TukeyHSD(aov.years.out[[i]])
  names(aov.years.out)[[i]] <- paste0(s, "-all")
  names(tukey.years.out)[[i]] <- paste0(s, "-all")
  i=i+1
}

## now for vessel groups
for(s in unique(emd.dat.groups$subgroup)){
  testdat <- filter(emd.dat.groups.keepYRS, subgroup==s)
  aov.years.out[[i]] <- aov(emd~crab_years,data=testdat)
  tukey.years.out[[i]] <- TukeyHSD(aov.years.out[[i]],conf.level=0.90)
  names(aov.years.out)[[i]] <- paste0(s)
  names(tukey.years.out)[[i]] <- paste0(s)
  i=i+1
}
```

#### between groups
are there significant differences between vessel groups, for the overall EMD mean?
```{r}
aov.groups.out <- aov(emd~subgroup,data=emd.dat.groups.keepYRS)
summary(aov.groups.out)
tukey.groups.out <- TukeyHSD(aov.groups.out)
```

```{r}
anovas_list <- list(aov.years.out,tukey.years.out, aov.groups.out,tukey.groups.out)
save(anovas_list, file=here('project-dat','statistics','anova_tukey_tests_byYR.rds'))
```





