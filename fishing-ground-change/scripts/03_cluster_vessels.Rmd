---
title: "Cluster Vessels into Groups"
output: html_document
---

**Author: M. Fisher**

Cluster Dungeness crab fishing vessels in a given crab year, according to fishing location. Clustering input is the proportion of geolocations in each California offshore management block. This script is specific to commercial fishing vessels landing Dungeness crab at California port groups.

Clustering details: 

- Hellinger distance: because we don't know for sure if 0s mean no fishing in a given block, or just no VMS-covered fishing.

- `k` chosen using a combination of heatmaps, NbClust

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# r packages
library(tidyverse)
library(magrittr)
library(sf)
# library(sp)
library(lubridate)
library(ggplot2)
# library(rgdal)
# library(rgeos)
library(here)
library(cowplot)
library(parallelDist)
library(vegan)
library(NbClust)
library(ggdendro)
library(grid);library(gridExtra)
# library(maps)

source(here('R','intersect_vms_block.R'))


# ggplot theme
plot_theme <- theme_classic() +
  theme(text=element_text(family="sans",size=12,color="black"),
        legend.text = element_text(size=14),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=8,color="black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
theme_set(plot_theme)

```

User Inputs:
```{r}
crab_years <- seq(2011,2018)
cluster_year <- 2014
outdir <- "project-dat/vms/interpolation_60min/NaN_speed_filter"
write  <- FALSE
```


## Data

VMS
```{r read_vms}
for(y in crab_years){
  tmpvms <-  read_rds(here::here('project-dat','vms','interpolation_60min','NaN_speed_filter',paste0(y,'season_crabfishing.rds')))
  if(y==crab_years[1]){
    vms <- tmpvms
  } else{
    vms %<>% bind_rows(tmpvms)
  }
}

str(vms)
```

offshore management blocks, in a shapefile.
```{r}
#Load shapefile
blocks <- st_read(here("project-dat","CA_largeOffshoreblocks/CA_largeOffshoreblocks.shp"))

#change blocks to lat/lon WGS84
blocks4326 <- blocks %>% st_transform(4326)
```



## Add management blocks

California offshore management blocks are slightly smaller-scale than the management areas. Blocks 1042, 1041, and 1040 are in the northern management area.
```{r echo=FALSE,fig.width=4,fig.height=6}
## plot
blocks_coords <- as.data.frame(sf::st_coordinates(sf::st_point_on_surface(blocks4326))) %>%
  mutate(NAME=blocks4326$BLOCK10_ID)
ggplot() +
  geom_sf(data=blocks4326) +
  geom_text(data = blocks_coords, aes(X, Y, label = NAME), colour = "black") +
  labs(x="",y="")
```
<br>

### southern blocks (optional)
Most Dungeness crab fishing occurs north of Santa Barbara, so let's aggregate the southern-most management blocks. **Set to `eval=FALSE`**
```{r eval=FALSE}
## separate blocks to combine
keep_blocks <- blocks4326[blocks4326$BLOCK10_ID %in% c("1042","1041","1040","1038","1037","1036")]
# combine_blocks <- blocks4326[blocks4326$BLOCK10_ID %in% c("1035","1034","1033","1032"),]
combine_blocks <- blocks4326 %>% filter(BLOCK10_ID %in% c("1035","1034","1033","1032"))



## aggregate southern blocks 
combine_blocks2 <- st_union(x=combine_blocks,by_feature=FALSE)
combine_blocks3 <- st_as_sf(data.frame(BLOCK10_ID=103532,
                                 Perimeter=0,
                                 Area=0,
                                 Acres=0,
                                 Hectares=0,
                                 geometry=combine_blocks2)) %>%
  group_by()
combine_blocks4 <- st_as_sf(combine_blocks3) %>% st_cast(to="MULTIPOLYGON",group_or_split=FALSE) %>% st_transform(4326)

## new blocks object
blocks2 <- rbind(keep_blocks,combine_blocks4,makeUniqueIDs = TRUE)
```
```{r eval=FALSE, echo=FALSE, fig.width=5, fig.height=7}
ggplot() +
  geom_sf(data=combine_blocks2)
  # geom_polygon(data = combine_blocks, aes(x=long,y=lat,group=group),size = 1, color = "black", fill = "cyan1", alpha=0.5)
```
<br>

### add block to locations

```{r}
for(y in crab_years){
  tmpout <- intersect_vms_block(vms=vms, blocks_sf = blocks4326, y=y, plot=TRUE)
  if(y==crab_years[1]){
    vms_out <- tmpout[[1]]
  } else{
    vms_out %<>% bind_rows(tmpout[[1]])
  }
  if(write){
  png(here(outdir,paste0(y,'block_assignments.png')))
  print(tmpout[[2]])
  dev.off()
  }
}
```


how many vms points were not assigned to a block? remove them from the dataset.
```{r echo=FALSE}
vms_out %>% filter(is.na(BLOCK10_ID)) %>%
  group_by(crab_year) %>%
  summarise(nvms=length(unique(VMS_RECNO))) %>%
  left_join(vms_out %>% group_by(crab_year) %>%
              summarise(totalvms=length(unique(VMS_RECNO))),by="crab_year") %>%
  mutate(percent_missing=100*(nvms/totalvms)) %>%
  ggplot(aes(x=as.factor(crab_year),y=percent_missing)) + 
  geom_col() + labs(x="Crab Year",y="% VMS out of blocks")
```
```{r}
vms_out %<>% filter(!is.na(BLOCK10_ID))
```
<br>

Calculate proportion of VMS points in each offshore block, for each vessel and crab year. 
```{r}
vms_per_block <- vms_out %>%
  group_by(crab_year,drvid,BLOCK10_ID) %>%
  summarise(nvms=length(unique(VMS_RECNO))) %>%
  left_join(vms_out %>%
              group_by(crab_year,drvid) %>%
  summarise(totalvms=length(unique(VMS_RECNO))), by=c("drvid","crab_year")) %>%
  mutate(propVMS=nvms/totalvms)
```
```{r echo=FALSE}
ggplot(vms_per_block, aes(x=as.factor(crab_year),y=propVMS)) +
  geom_boxplot(aes(col=as.factor(BLOCK10_ID))) + 
  facet_wrap(~BLOCK10_ID) + theme(legend.position="none") +
  labs(x="crab year",y="propVMS per vessel")
```

Calculate proportion of VMS points in each management area, for each vessel and crab year. 
```{r}
vms_per_area <- vms_out %>%
  mutate(area=ifelse(BLOCK10_ID %in% c("1042","1041","1040"), "northern","central")) %>%
  group_by(crab_year,drvid,area) %>%
  summarise(nvms=length(unique(VMS_RECNO))) %>%
  left_join(vms_out %>%
              group_by(crab_year,drvid) %>%
  summarise(totalvms=length(unique(VMS_RECNO))), by=c("drvid","crab_year")) %>%
  mutate(propVMS=nvms/totalvms)
```
```{r echo=FALSE}
ggplot(vms_per_area, aes(x=as.factor(crab_year),y=propVMS)) +
  geom_boxplot(aes(col=as.factor(area))) + 
  facet_wrap(~area) + theme(legend.position="none") +
  labs(x="crab year",y="propVMS per vessel")
```



## clustering

### by block

Remove empty rows; select only cluster year
```{r}
mydat <- vms_per_block %>% filter(crab_year==cluster_year) %>%
  ungroup() %>%
  dplyr::select(drvid,BLOCK10_ID,propVMS) %>%
  pivot_wider(id_cols=c("drvid"), names_from=BLOCK10_ID, values_from=propVMS, values_fill=0)
```
```{r echo=FALSE}
mydat_counts <- vms_per_block %>% filter(crab_year==cluster_year) %>%
  ungroup() %>%
  dplyr::select(drvid,BLOCK10_ID,nvms)
```
<br>

calculate hellinger distance between vessels.
```{r}
starttime <- Sys.time()

   dat.dist <- parDist(as.matrix(mydat[,2:8]), method="hellinger", diag=FALSE, upper=FALSE)

Sys.time()-starttime
```

clustering
```{r}
dat.hclust <- hclust(d=dat.dist, method="ward.D2")
dat.dendro <- as.dendrogram(dat.hclust)
```


#### explore clusters
```{r echo=FALSE}
heights <- cbind(dat.hclust$height, dat.hclust$merge)
plot(x=12:1, y=heights[(nrow(heights)-11):nrow(heights),1],xlab="Number of Groups", ylab="height", type="b")
nb <- NbClust(data=as.matrix(mydat[,2:8]), diss=dat.dist, distance=NULL, method="ward.D2", index="gap")
plot(x=seq(2,length(nb$All.index)+1), y=nb$All.index)

plot(dat.hclust, labels=mydat$drvid, hang=-1, ylab="Dissimilarity")
rect.hclust(dat.hclust, k=6) # k splits dendrogram into given number of clusters

plot(dat.hclust, labels=mydat$drvid, hang=-1, ylab="Dissimilarity")
rect.hclust(dat.hclust, k=5) # k splits dendrogram into given number of clusters

plot(dat.hclust, labels=mydat$drvid, hang=-1, ylab="Dissimilarity")
rect.hclust(dat.hclust, k=4) # k splits dendrogram into given number of clusters
```
<br>

Vessel Heatmap 
```{r echo=FALSE}
dat_long <- mydat %>% 
  pivot_longer(cols=2:8, names_to="block",values_to="propVMS")

dat.order <- data.frame(drvid=mydat$drvid[order.dendrogram(dat.dendro)])

dat_long$drvid <- factor(dat_long$drvid,levels=dat.order$drvid)


ordered.heatmap.plot <- ggplot(data = dat_long, aes(x = block, y = drvid)) +
  geom_tile(aes(fill = propVMS)) +
  scale_fill_gradient2() +
  theme(axis.text.y = element_blank())

dendro.plot <- ggdendrogram(data = dat.dendro, rotate = TRUE) + 
  theme(axis.text.y = element_text(size = 6))

grid.newpage()
print(ordered.heatmap.plot, vp = viewport(x = 0.4, y = 0.5, width = 0.8, height = 1.0))
print(dendro.plot, vp = viewport(x = 0.90, y = 0.5, width = 0.2, height = 1.08))

if(write){
  png(here(outdir,paste0(cluster_year,'dendrogram_heatmap_block-clustered.png')))
grid.newpage()
print(ordered.heatmap.plot, vp = viewport(x = 0.4, y = 0.5, width = 0.8, height = 1.0))
print(dendro.plot, vp = viewport(x = 0.90, y = 0.5, width = 0.2, height = 1.08))
dev.off()
}
```
<br>

#### final clusters

```{r}
k=6

plot(dat.hclust,hang=-1, ylab="Dissimilarity")
hclust.groups <- rect.hclust(dat.hclust, k=k)
drvid_groups <- data.frame(vessels=as.character(),
                           group=as.numeric(),
                           crab_year=as.numeric())
for(i in seq(1,k)){
  vessel_list <- mydat$drvid[hclust.groups[[i]]]
  tmp_df <- data.frame(vessels=vessel_list,
                       group=rep(i,length(vessel_list)),
                       crab_year=cluster_year)
  drvid_groups <- rbind(drvid_groups, tmp_df)
}
```
<br>

Name groups
```{r}
get_home <- function(df, cutoff=0.10){
  df <- mutate(df, max_sum = max(tmpn),prop_max = 1-tmpn/max_sum)
  home_ports <- filter(df, prop_max < cutoff)$BLOCK10_ID
  home_out <- paste0(home_ports, collapse="/")
  return(home_out)
}
```
<br>


```{r}
for(i in seq(1,k)){
  tmp_drvids <- filter(drvid_groups, group == i)
  tmp_dat <- mydat_counts %>%
    filter(drvid %in% tmp_drvids$vessels) %>%
    group_by(BLOCK10_ID) %>%
    summarise(tmpn = sum(nvms, na.rm=TRUE))
  home_block <- get_home(tmp_dat, cutoff=0.7)
  if(i==1){
    home_names <- data.frame(vessels=tmp_drvids$vessels,
                             block=rep(home_block,times=length(tmp_drvids$vessels)))
  } else{
    tmp_names <-data.frame(vessels=tmp_drvids$vessels,
                             block=rep(home_block,times=length(tmp_drvids$vessels)))
    home_names <- rbind(home_names, tmp_names)
  }
}

drvid_groups <- left_join(drvid_groups, home_names, by="vessels")
plotdat <- left_join(drvid_groups,mydat,by=c("vessels"="drvid"))

if(write){
#write it out
write.csv(plotdat,here::here(outdir,paste0(cluster_year,"_k",k,"clusters_blocks.csv")))
}
```
<br>

Condensed heat map
```{r}
plotdat.summary <- mydat_counts %>%
  left_join(plotdat %>% dplyr::select(vessels,group,block),by=c("drvid"="vessels")) %>%
  rename("group_block"=block) %>%
  group_by(group,group_block, BLOCK10_ID) %>%
  summarise(groupVMS=sum(nvms)) %>%
  pivot_wider(names_from=BLOCK10_ID,values_from=groupVMS, values_fill=0)
plotdat_prop <- prop.table(as.matrix(plotdat.summary[,3:9]),margin=1) %>%
  bind_cols(dplyr::select(plotdat.summary,group,group_block)) %>%
  pivot_longer(cols=1:7,names_to="block")

labeldat <- data.frame(x=0.75,y=seq(1,k),nv=(plotdat %>% group_by(group) %>% summarise(n.vessels=length(unique(vessels))))[,"n.vessels"])

ggplot(data = plotdat_prop, aes(x = block, y = as.factor(group))) +
  geom_tile(aes(fill = value)) +
  geom_text(data=labeldat,aes(x,y,label=n.vessels), size=4, color="grey30") +
  scale_fill_gradient2() +
  theme(axis.text.y = element_text(size = 9)) + theme_bw()
```



### by area


Remove empty rows; select only cluster year
```{r}
mydat <- vms_per_area %>% filter(crab_year==cluster_year) %>%
  ungroup() %>%
  dplyr::select(drvid,area,propVMS) %>%
  pivot_wider(id_cols=c("drvid"), names_from=area, values_from=propVMS, values_fill=0)
```
```{r echo=FALSE}
mydat_counts <- vms_per_area %>% filter(crab_year==cluster_year) %>%
  ungroup() %>%
  dplyr::select(drvid,area,nvms)
```
<br>

calculate hellinger distance between vessels.
```{r}
starttime <- Sys.time()

   dat.dist <- parDist(as.matrix(mydat[,2:3]), method="hellinger", diag=FALSE, upper=FALSE)

Sys.time()-starttime
```

clustering
```{r}
dat.hclust <- hclust(d=dat.dist, method="ward.D2")
dat.dendro <- as.dendrogram(dat.hclust)
```


#### explore clusters
```{r echo=FALSE}
heights <- cbind(dat.hclust$height, dat.hclust$merge)
plot(x=12:1, y=heights[(nrow(heights)-11):nrow(heights),1],xlab="Number of Groups", ylab="height", type="b")
nb <- NbClust(data=as.matrix(mydat[,2:3]), diss=dat.dist, distance=NULL, method="ward.D2", index="gap")
plot(x=seq(2,length(nb$All.index)+1), y=nb$All.index)

plot(dat.hclust, labels=mydat$drvid, hang=-1, ylab="Dissimilarity")
rect.hclust(dat.hclust, k=4) # k splits dendrogram into given number of clusters

plot(dat.hclust, labels=mydat$drvid, hang=-1, ylab="Dissimilarity")
rect.hclust(dat.hclust, k=3) # k splits dendrogram into given number of clusters

plot(dat.hclust, labels=mydat$drvid, hang=-1, ylab="Dissimilarity")
rect.hclust(dat.hclust, k=2) # k splits dendrogram into given number of clusters
```
<br>

Vessel Heatmap 
```{r echo=FALSE}
dat_long <- mydat %>% 
  pivot_longer(cols=2:3, names_to="block",values_to="propVMS")

dat.order <- data.frame(drvid=mydat$drvid[order.dendrogram(dat.dendro)])

dat_long$drvid <- factor(dat_long$drvid,levels=dat.order$drvid)


ordered.heatmap.plot <- ggplot(data = dat_long, aes(x = block, y = drvid)) +
  geom_tile(aes(fill = propVMS)) +
  scale_fill_gradient2() +
  theme(axis.text.y = element_blank())

dendro.plot <- ggdendrogram(data = dat.dendro, rotate = TRUE) + 
  theme(axis.text.y = element_text(size = 6))

grid.newpage()
print(ordered.heatmap.plot, vp = viewport(x = 0.4, y = 0.5, width = 0.8, height = 1.0))
print(dendro.plot, vp = viewport(x = 0.90, y = 0.5, width = 0.2, height = 1.08))


if(write){
png(here(outdir,paste0(cluster_year,'dendrogram_heatmap_area-clustered.png')))
grid.newpage()
print(ordered.heatmap.plot, vp = viewport(x = 0.4, y = 0.5, width = 0.8, height = 1.0))
print(dendro.plot, vp = viewport(x = 0.90, y = 0.5, width = 0.2, height = 1.08))
dev.off()
}
```
<br>
#### final clusters

```{r}
k=4

plot(dat.hclust,hang=-1, ylab="Dissimilarity")
hclust.groups <- rect.hclust(dat.hclust, k=k)
drvid_groups <- data.frame(vessels=as.character(),
                           group=as.numeric(),
                           crab_year=as.numeric())
for(i in seq(1,k)){
  vessel_list <- mydat$drvid[hclust.groups[[i]]]
  tmp_df <- data.frame(vessels=vessel_list,
                       group=rep(i,length(vessel_list)),
                       crab_year=cluster_year)
  drvid_groups <- rbind(drvid_groups, tmp_df)
}
```
<br>

Name groups
```{r}
get_home <- function(df, cutoff=0.10){
  df <- mutate(df, max_sum = max(tmpn),prop_max = 1-tmpn/max_sum)
  home_ports <- filter(df, prop_max < cutoff)$area
  home_out <- paste0(home_ports, collapse="/")
  return(home_out)
}
```
<br>


```{r}
for(i in seq(1,k)){
  tmp_drvids <- filter(drvid_groups, group == i)
  tmp_dat <- mydat_counts %>%
    filter(drvid %in% tmp_drvids$vessels) %>%
    group_by(area) %>%
    summarise(tmpn = sum(nvms, na.rm=TRUE))
  home_area <- get_home(tmp_dat, cutoff=0.8)
  if(i==1){
    home_names <- data.frame(vessels=tmp_drvids$vessels,
                             area=rep(home_area,times=length(tmp_drvids$vessels)))
  } else{
    tmp_names <-data.frame(vessels=tmp_drvids$vessels,
                             area=rep(home_area,times=length(tmp_drvids$vessels)))
    home_names <- rbind(home_names, tmp_names)
  }
}

drvid_groups <- left_join(drvid_groups, home_names, by="vessels")
plotdat <- left_join(drvid_groups,mydat,by=c("vessels"="drvid"))

if(write){
#write it out
write.csv(plotdat,here::here(outdir,paste0(cluster_year,"_k",k,"clusters_area.csv")), row.names=FALSE)
}
```
<br>

Condensed heat map
```{r}
plotdat.summary <- mydat_counts %>%
  left_join(plotdat %>% dplyr::select(vessels,group,area) %>% rename("group_area"=area) ,by=c("drvid"="vessels"))%>%
  group_by(group,group_area, area) %>%
  summarise(groupVMS=sum(nvms)) %>%
  pivot_wider(names_from=area,values_from=groupVMS, values_fill=0)
plotdat_prop <- prop.table(as.matrix(plotdat.summary[,3:4]),margin=1) %>%
  bind_cols(dplyr::select(plotdat.summary,group,group_area)) %>%
  pivot_longer(cols=1:2,names_to="area")

labeldat <- data.frame(x=0.75,y=seq(1,k),nv=(plotdat %>% group_by(group) %>% summarise(n.vessels=length(unique(vessels))))[,"n.vessels"])

ggplot(data = plotdat_prop, aes(x = area, y = as.factor(group))) +
  geom_tile(aes(fill = value)) +
  geom_text(data=labeldat,aes(x,y,label=n.vessels), size=4, color="grey30") +
  scale_fill_gradient2() +
  theme(axis.text.y = element_text(size = 9)) + theme_bw()

if(write){
png(here(outdir,paste0(cluster_year,'group_heatmap_area-clustered.png')))
ggplot(data = plotdat_prop, aes(x = area, y = as.factor(group))) +
  geom_tile(aes(fill = value)) +
  geom_text(data=labeldat,aes(x,y,label=n.vessels), size=4, color="grey30") +
  scale_fill_gradient2() +
  theme(axis.text.y = element_text(size = 9)) + theme_bw()
dev.off()
}
```


## Sub-clusters by length

Vessel lengths can vary by year. Here, clusters are subdivided by the vessel lengths reported in the year *beginning* each crab season (in other words, crab_year - 1). 
```{r include=FALSE}
rm(vms,tmpvms,tmpout,vms_out,vms_per_area,vms_per_block)
```
<br>

### data

```{r fishtix}
for(y in crab_years){
  tmpy <- y-1
  tmptix <-  read_rds(here::here('../data','processed','fish tickets',paste0(y,'fishtix_vlengths.rds'))) %>%
    dplyr::select(Rec_ID,drvid,year,jdate,DCRB_lbs,DCRB_revenue,FINAL_LENGTH) %>%
    filter(drvid %in% drvid_groups$vessels) %>%
    mutate(for_crab_year=y)
  if(y==crab_years[1]){
    tix <- tmptix
  } else{
    tix %<>% bind_rows(tmptix)
  }
}

str(tix)
```

make just a vessel length key.
```{r}
lkey <- tix %>% dplyr::select(drvid,FINAL_LENGTH,for_crab_year) %>% distinct()
```


### by area

For each year, copy over the groups data frame, then assign a year-specific vessel size category (small, large)
```{r}
for(i in seq(1,length(crab_years))){
  y <- crab_years[i]
  tmpdat <- drvid_groups %>% 
    rename("group_year"=crab_year) %>%
    mutate(crab_year=y) %>%
    left_join(lkey, by=c("vessels"="drvid","crab_year"="for_crab_year"))
  if(i==1){
    drvid_groups_annual <- tmpdat
  } else{
    drvid_groups_annual %<>% bind_rows(tmpdat)
  }
}

drvid_groups_annual %<>% mutate(vessel_size=ifelse(FINAL_LENGTH < 40, "small","large"))
```

Split groups
```{r}
drvid_subgroups <- drvid_groups_annual %>% 
  filter(!is.na(FINAL_LENGTH)) %>%
  group_by(crab_year,group,vessel_size) %>%
  summarise(n=n()) %>%
  unite(col="subgroup",c(group,vessel_size), sep="-",remove=FALSE)

ggplot(drvid_subgroups, aes(x=crab_year,y=n, col=subgroup)) +
  geom_point() + geom_path() + 
  labs(subtitle=paste0("cluster sizes (k=",k,")"), x="crab year",y="n. vessels")

if(write){
write.csv(drvid_subgroups, here('project-dat','vessel_groups',paste0('k',k,'_NaNspeedfilter_',cluster_year,'clusterYR_byArea_sample-sizes-tix.csv')))
}
```
<br>

which group-years are confidential? write out a non-confidential groups key.
```{r}
if(write){
subgroup_out <- drvid_subgroups %>% 
  filter(n>2) %>%
  dplyr::select(crab_year,subgroup,group,vessel_size) %>%
  left_join(drvid_groups_annual, by=c("group","crab_year","vessel_size")) %>%
  rename("drvid"=vessels)

write.csv(subgroup_out, here('project-dat','vessel_groups',paste0('k',k,'_NaNspeedfilter_',cluster_year,'clusterYR_byArea_nonconTix-group-key.csv')))
}
```


## Add a "group 5"

```{r}
k <- 4
cluster_year <- 2014
subgroup_out <- read_csv(here('project-dat','vessel_groups',paste0('k',k,'_NaNspeedfilter_',cluster_year,'clusterYR_byArea_nonconTix-group-key.csv')))
```

In certain years, vessel groups 4-large and 3-large (the coastwide / mobile northern groups) have fewer than 3 vessels in the *VMS data.* I didn't catch this because there are more than 3 vessels in the fish ticket data. So those vessels that dropped out of the VMS data either didn't have VMS, or their trips got filtered out. 

I still want to be able to look at 4-large and 3-large behavior, but for figures in the paper, I'm also probably going to need a non-confidential combination group.


First extend the vessel group key to include "5-large" / group 5, and copy in drvids. 
```{r}
group5_vessels <- filter(subgroup_out,subgroup %in% c("3-large","4-large"))
group5_vessels %<>% dplyr::select(-subgroup,-group,-area) %>%
  mutate(subgroup="5-large", group=5,
         area="central/northern")

vgroups_ext <- bind_rows(subgroup_out,group5_vessels)
unique(vgroups_ext$subgroup)
```
```{r}
k <- k + 1
```

Then, create a truly non-confidential vessel group key by (1) marking subgroup/year combinations to remove from the VMS data...
```{r}
grouped.vms <- vgroups_ext %>% dplyr::select(crab_year,drvid,subgroup,group,vessel_size,area) %>%
  rename(group_area=area) %>%
  left_join(vms, by=c("drvid","crab_year"), multiple="all") %>%
  filter(crab_year %in% crab_years) %>% 
  dplyr::select(crab_year,drvid,subgroup,group,vessel_size,group_area,Rec_ID,date,removal_type_code,westcoastdate,X_COORD,Y_COORD,LATITUDE,LONGITUDE,season_start_date) %>%
  filter(!is.na(Rec_ID))

to_remove <- grouped.vms %>% group_by(subgroup,crab_year) %>% summarise(n.vessels=length(unique(drvid))) %>% filter(n.vessels < 3)

to_remove
```

and (2) doing an anti-join with the grouped VMS dataset. 
```{r}
grouped.vms %<>% anti_join(to_remove,by=c("crab_year","subgroup"))
```


check that it worked!
```{r} 
grouped.vms %>% group_by(subgroup,crab_year) %>% summarise(n.vessels=length(unique(drvid))) %>% filter(n.vessels < 3)
```



In the tickets-based key

   subgroup crab_year ndrvid
   <chr>        <dbl>  <int>
 1 3-large       2013      4
 2 3-large       2014      4
 3 3-large       2015      5
 4 3-large       2016      4
 5 3-large       2017      4
 6 3-large       2018      3
 7 4-large       2013      3
 8 4-large       2014      3
 9 4-large       2015      3
10 4-large       2016      3
11 4-large       2017      3
12 4-large       2018      3

In the vms data
  subgroup crab_year ndrvid
   <chr>        <dbl>  <int>
 1 3-large       2013      3
 2 3-large       2014      4
 3 3-large       2015      5

 5 3-large       2017      4

 8 4-large       2014      3
 9 4-large       2015      3

11 4-large       2017      3
12 4-large       2018      3

New "group 5" in the vms data
  subgroup crab_year n.vessels
  <chr>        <dbl>     <int>
1 5-large       2013         5
2 5-large       2014         7
3 5-large       2015         8
4 5-large       2016         4
5 5-large       2017         7
6 5-large       2018         5

```{r}
## only for the first time through -- re-write groups key to be truly non-confidential
vgroups_key_out <- grouped.vms %>%
  dplyr::select(group,subgroup,crab_year,drvid,group_area,vessel_size) %>% 
  distinct()
sample_sizes_out <- vgroups_key_out %>%
  group_by(group,subgroup,crab_year,group_area,vessel_size) %>%
  summarise(n.vessels=length(unique(drvid)))

if(write){
write_csv(vgroups_key_out,file=here('project-dat','vessel_groups','k4_NaNspeedfilter_2014clusterYR_byArea_noncon-group-key.csv'))

write_csv(sample_sizes_out,file=here('project-dat','vessel_groups','k4_NaNspeedfilter_2014clusterYR_byArea_sample-sizes.csv'))
}
```

















### park
```{r eval=FALSE}
# Remove any records within the same trip that have the same time stamp. Depending on how "NA" speeds were filtered, there may be no duplicate locations.
vms_nodup <- vms[c(which(!(duplicated(subset(vms,select=c(Rec_ID, UTCDATETIM)),fromLast=TRUE)))),]
message('removed ', round((1-(dim(vms_nodup)[1]/dim(vms)[1]))*100,3), "% of all VMS records.")
```

